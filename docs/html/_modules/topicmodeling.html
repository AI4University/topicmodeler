<!DOCTYPE html>
<html class="writer-html5" lang="en" >
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>topicmodeling &mdash; Topic Modeler documentation</title>
      <link rel="stylesheet" href="../_static/pygments.css" type="text/css" />
      <link rel="stylesheet" href="../_static/css/theme.css" type="text/css" />
  <!--[if lt IE 9]>
    <script src="../_static/js/html5shiv.min.js"></script>
  <![endif]-->
  
        <script data-url_root="../" id="documentation_options" src="../_static/documentation_options.js"></script>
        <script src="../_static/jquery.js"></script>
        <script src="../_static/underscore.js"></script>
        <script src="../_static/doctools.js"></script>
    <script src="../_static/js/theme.js"></script>
    <link rel="index" title="Index" href="../genindex.html" />
    <link rel="search" title="Search" href="../search.html" /> 
</head>

<body class="wy-body-for-nav"> 
  <div class="wy-grid-for-nav">
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-scroll">
        <div class="wy-side-nav-search" >
            <a href="../index.html" class="icon icon-home"> IntelComp_Topic_Modeler
          </a>
<div role="search">
  <form id="rtd-search-form" class="wy-form" action="../search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>
        </div><div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="Navigation menu">
              <p class="caption" role="heading"><span class="caption-text">Contents:</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../ITMT_mainCMD.html">ITMT_mainCMD</a></li>
<li class="toctree-l1"><a class="reference internal" href="../ITMT_mainGUI.html">ITMT_mainGUI</a></li>
<li class="toctree-l1"><a class="reference internal" href="../JSONadapter.html">JSONadapter</a></li>
<li class="toctree-l1"><a class="reference internal" href="../TMinferencer.html">TMinferencer</a></li>
<li class="toctree-l1"><a class="reference internal" href="../corpus2JSON.html">corpus2JSON</a></li>
<li class="toctree-l1"><a class="reference internal" href="../src.html">src</a></li>
<li class="toctree-l1"><a class="reference internal" href="../topicmodeling.html">topicmodeling</a></li>
</ul>

        </div>
      </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap"><nav class="wy-nav-top" aria-label="Mobile navigation menu" >
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="../index.html">IntelComp_Topic_Modeler</a>
      </nav>

      <div class="wy-nav-content">
        <div class="rst-content">
          <div role="navigation" aria-label="Page navigation">
  <ul class="wy-breadcrumbs">
      <li><a href="../index.html" class="icon icon-home"></a> &raquo;</li>
          <li><a href="index.html">Module code</a> &raquo;</li>
      <li>topicmodeling</li>
      <li class="wy-breadcrumbs-aside">
      </li>
  </ul>
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
           <div itemprop="articleBody">
             
  <h1>Source code for topicmodeling</h1><div class="highlight"><pre>
<span></span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">* *IntelComp H2020 project*</span>
<span class="sd">* *Topic Modeling Toolbox*</span>

<span class="sd">Provides several classes for Topic Modeling</span>
<span class="sd">    - stwEQcleaner: For string cleaning (stopword removal + equivalent terms)</span>
<span class="sd">    - TMmodel: To represent a trained topic model + edition functions</span>
<span class="sd">    - MalletTrainer: To train a topic model from a given corpus</span>
<span class="sd">&quot;&quot;&quot;</span>

<span class="kn">import</span> <span class="nn">numpy</span> <span class="k">as</span> <span class="nn">np</span>
<span class="kn">from</span> <span class="nn">sklearn.preprocessing</span> <span class="kn">import</span> <span class="n">normalize</span>
<span class="kn">from</span> <span class="nn">scipy</span> <span class="kn">import</span> <span class="n">sparse</span>
<span class="c1"># from scipy.spatial.distance import jensenshannon</span>
<span class="c1"># import pyLDAvis</span>
<span class="kn">import</span> <span class="nn">matplotlib.pyplot</span> <span class="k">as</span> <span class="nn">plt</span>
<span class="kn">import</span> <span class="nn">argparse</span>
<span class="kn">import</span> <span class="nn">configparser</span>
<span class="kn">import</span> <span class="nn">logging</span>
<span class="kn">from</span> <span class="nn">pathlib</span> <span class="kn">import</span> <span class="n">Path</span>
<span class="kn">import</span> <span class="nn">regex</span> <span class="k">as</span> <span class="nn">javare</span>
<span class="kn">import</span> <span class="nn">re</span>
<span class="kn">import</span> <span class="nn">sys</span>
<span class="kn">import</span> <span class="nn">pandas</span> <span class="k">as</span> <span class="nn">pd</span>
<span class="kn">from</span> <span class="nn">tqdm</span> <span class="kn">import</span> <span class="n">tqdm</span>
<span class="kn">import</span> <span class="nn">ipdb</span>
<span class="kn">from</span> <span class="nn">gensim</span> <span class="kn">import</span> <span class="n">corpora</span>
<span class="kn">from</span> <span class="nn">gensim.utils</span> <span class="kn">import</span> <span class="n">check_output</span><span class="p">,</span> <span class="n">tokenize</span>

<span class="c1"># Local imports</span>
<span class="kn">from</span> <span class="nn">src.neural_models.pytorchavitm.utils.data_preparation</span> <span class="kn">import</span> <span class="n">prepare_dataset</span>
<span class="kn">from</span> <span class="nn">src.neural_models.contextualized_topic_models.utils.data_preparation</span> <span class="kn">import</span> <span class="n">prepare_ctm_dataset</span>
<span class="kn">from</span> <span class="nn">src.neural_models.pytorchavitm.avitm_network.avitm</span> <span class="kn">import</span> <span class="n">AVITM</span>
<span class="kn">from</span> <span class="nn">src.neural_models.contextualized_topic_models.ctm_network.ctm</span> <span class="kn">import</span> <span class="n">CombinedTM</span><span class="p">,</span> <span class="n">ZeroShotTM</span>

<span class="n">logging</span><span class="o">.</span><span class="n">getLogger</span><span class="p">(</span><span class="s2">&quot;gensim&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">setLevel</span><span class="p">(</span><span class="n">logging</span><span class="o">.</span><span class="n">WARNING</span><span class="p">)</span>


<div class="viewcode-block" id="file_lines"><a class="viewcode-back" href="../topicmodeling.html#topicmodeling.file_lines">[docs]</a><span class="k">def</span> <span class="nf">file_lines</span><span class="p">(</span><span class="n">fname</span><span class="p">):</span>
    <span class="c1"># Count number of lines in file</span>
    <span class="k">with</span> <span class="n">fname</span><span class="o">.</span><span class="n">open</span><span class="p">(</span><span class="s1">&#39;r&#39;</span><span class="p">,</span> <span class="n">encoding</span><span class="o">=</span><span class="s1">&#39;utf8&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
        <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">l</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">f</span><span class="p">):</span>
            <span class="k">pass</span>
    <span class="k">return</span> <span class="n">i</span> <span class="o">+</span> <span class="mi">1</span></div>


<div class="viewcode-block" id="stwEQcleaner"><a class="viewcode-back" href="../topicmodeling.html#topicmodeling.stwEQcleaner">[docs]</a><span class="k">class</span> <span class="nc">stwEQcleaner</span><span class="p">(</span><span class="nb">object</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Simpler version of the english lemmatizer</span>
<span class="sd">    It only provides stopword removal and application of equivalences</span>
<span class="sd">        </span>
<span class="sd">    Public methods:</span>
<span class="sd">        - cleanstr: Apply stopwords and equivalences on provided string</span>
<span class="sd">    &quot;&quot;&quot;</span>

<div class="viewcode-block" id="stwEQcleaner.__init__"><a class="viewcode-back" href="../topicmodeling.html#topicmodeling.stwEQcleaner.__init__">[docs]</a>    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">stw_files</span><span class="o">=</span><span class="p">[],</span> <span class="n">dict_eq_file</span><span class="o">=</span><span class="s1">&#39;&#39;</span><span class="p">,</span> <span class="n">logger</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Initilization Method</span>
<span class="sd">        Stopwwords and the dictionary of equivalences will be loaded</span>
<span class="sd">        during initialization</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        stw_file: list</span>
<span class="sd">            List of files of stopwords</span>
<span class="sd">        dict_eq_file: pathlib.Path</span>
<span class="sd">            Dictionary of equivalent words A : B means A will be replaced by B</span>

<span class="sd">        &quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">__stopwords</span> <span class="o">=</span> <span class="p">[]</span>

        <span class="c1"># Unigrams for word replacement</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">__useunigrams</span> <span class="o">=</span> <span class="kc">False</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">__pattern_unigrams</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">__unigramdictio</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="k">if</span> <span class="n">logger</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">logger</span> <span class="o">=</span> <span class="n">logger</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="kn">import</span> <span class="nn">logging</span>
            <span class="n">logging</span><span class="o">.</span><span class="n">basicConfig</span><span class="p">(</span><span class="n">level</span><span class="o">=</span><span class="s1">&#39;INFO&#39;</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">logger</span> <span class="o">=</span> <span class="n">logging</span><span class="o">.</span><span class="n">getLogger</span><span class="p">(</span><span class="s1">&#39;stwEQcleaner&#39;</span><span class="p">)</span>
        <span class="c1"># Load stopwords</span>
        <span class="k">for</span> <span class="n">stw_file</span> <span class="ow">in</span> <span class="n">stw_files</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">stw_file</span><span class="o">.</span><span class="n">is_file</span><span class="p">():</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">__stopwords</span> <span class="o">+=</span> <span class="bp">self</span><span class="o">.</span><span class="n">__loadStopFile</span><span class="p">(</span><span class="n">stw_file</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;-- -- Stopwords file not found&#39;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">__stopwords</span> <span class="o">=</span> <span class="nb">set</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">__stopwords</span><span class="p">)</span>

        <span class="c1"># Predefined equivalences as provided in file</span>
        <span class="k">if</span> <span class="n">dict_eq_file</span><span class="o">.</span><span class="n">is_file</span><span class="p">():</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">__unigramdictio</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">__pattern_unigrams</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">__loadEQFile</span><span class="p">(</span><span class="n">dict_eq_file</span><span class="p">)</span>
            <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">__unigramdictio</span><span class="p">):</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">__useunigrams</span> <span class="o">=</span> <span class="kc">True</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;-- -- Equivalence file not found&#39;</span><span class="p">)</span>

        <span class="k">return</span></div>

<div class="viewcode-block" id="stwEQcleaner.cleanstr"><a class="viewcode-back" href="../topicmodeling.html#topicmodeling.stwEQcleaner.cleanstr">[docs]</a>    <span class="k">def</span> <span class="nf">cleanstr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">rawtext</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Function to remove stopwords and apply equivalences</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        rawtext: str</span>
<span class="sd">            string with the text to lemmatize</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="n">rawtext</span> <span class="o">==</span> <span class="kc">None</span> <span class="ow">or</span> <span class="n">rawtext</span> <span class="o">==</span> <span class="s1">&#39;&#39;</span><span class="p">:</span>
            <span class="k">return</span> <span class="s1">&#39;&#39;</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">texto</span> <span class="o">=</span> <span class="s1">&#39; &#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">__removeSTW</span><span class="p">(</span><span class="n">rawtext</span><span class="o">.</span><span class="n">split</span><span class="p">()))</span>
            <span class="c1"># Make equivalences according to dictionary</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">__useunigrams</span><span class="p">:</span>
                <span class="n">texto</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">__pattern_unigrams</span><span class="o">.</span><span class="n">sub</span><span class="p">(</span>
                    <span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">__unigramdictio</span><span class="p">[</span><span class="n">x</span><span class="o">.</span><span class="n">group</span><span class="p">()],</span> <span class="n">texto</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">texto</span></div>

    <span class="k">def</span> <span class="nf">__loadStopFile</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">file</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Function to load the stopwords from a file. The stopwords will be</span>
<span class="sd">        read from the file, one stopword per line</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        file:</span>
<span class="sd">            The file to read the stopwords from</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">file</span><span class="p">,</span> <span class="n">encoding</span><span class="o">=</span><span class="s1">&#39;utf-8&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
            <span class="n">stopw</span> <span class="o">=</span> <span class="n">f</span><span class="o">.</span><span class="n">read</span><span class="p">()</span><span class="o">.</span><span class="n">splitlines</span><span class="p">()</span>

        <span class="k">return</span> <span class="p">[</span><span class="n">word</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span> <span class="k">for</span> <span class="n">word</span> <span class="ow">in</span> <span class="n">stopw</span> <span class="k">if</span> <span class="n">word</span><span class="p">]</span>

    <span class="k">def</span> <span class="nf">__loadEQFile</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">file</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Function to load equivalences from a file. The equivalence file</span>
<span class="sd">        will contain an equivalence per line in the format original : target</span>
<span class="sd">        where original will be changed to target after lemmatization</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        file:</span>
<span class="sd">            The file to read the equivalences from</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">unigrams</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">file</span><span class="p">,</span> <span class="s1">&#39;r&#39;</span><span class="p">,</span> <span class="n">encoding</span><span class="o">=</span><span class="s1">&#39;utf-8&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
            <span class="n">unigramlines</span> <span class="o">=</span> <span class="n">f</span><span class="o">.</span><span class="n">readlines</span><span class="p">()</span>
        <span class="n">unigramlines</span> <span class="o">=</span> <span class="p">[</span><span class="n">el</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span> <span class="k">for</span> <span class="n">el</span> <span class="ow">in</span> <span class="n">unigramlines</span><span class="p">]</span>
        <span class="n">unigramlines</span> <span class="o">=</span> <span class="p">[</span><span class="n">x</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39; : &#39;</span><span class="p">)</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">unigramlines</span><span class="p">]</span>
        <span class="n">unigramlines</span> <span class="o">=</span> <span class="p">[</span><span class="n">x</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">unigramlines</span> <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">x</span><span class="p">)</span> <span class="o">==</span> <span class="mi">2</span><span class="p">]</span>

        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">unigramlines</span><span class="p">):</span>
            <span class="c1"># This dictionary contains the necessary replacements to carry out</span>
            <span class="n">unigramdictio</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">(</span><span class="n">unigramlines</span><span class="p">)</span>
            <span class="n">unigrams</span> <span class="o">=</span> <span class="p">[</span><span class="n">x</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">unigramlines</span><span class="p">]</span>
            <span class="c1"># Regular expression to find the tokens that need to be replaced</span>
            <span class="n">pattern_unigrams</span> <span class="o">=</span> <span class="n">re</span><span class="o">.</span><span class="n">compile</span><span class="p">(</span><span class="sa">r</span><span class="s1">&#39;\b(&#39;</span> <span class="o">+</span> <span class="s1">&#39;|&#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">unigrams</span><span class="p">)</span> <span class="o">+</span> <span class="sa">r</span><span class="s1">&#39;)\b&#39;</span><span class="p">)</span>
            <span class="k">return</span> <span class="n">unigramdictio</span><span class="p">,</span> <span class="n">pattern_unigrams</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">return</span> <span class="kc">None</span><span class="p">,</span> <span class="kc">None</span>

    <span class="k">def</span> <span class="nf">__removeSTW</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">tokens</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Removes stopwords from the provided list</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        tokens:</span>
<span class="sd">            Input list of string to be cleaned from stw</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="p">[</span><span class="n">el</span> <span class="k">for</span> <span class="n">el</span> <span class="ow">in</span> <span class="n">tokens</span> <span class="k">if</span> <span class="n">el</span> <span class="ow">not</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">__stopwords</span><span class="p">]</span></div>


<div class="viewcode-block" id="TMmodel"><a class="viewcode-back" href="../topicmodeling.html#topicmodeling.TMmodel">[docs]</a><span class="k">class</span> <span class="nc">TMmodel</span><span class="p">(</span><span class="nb">object</span><span class="p">):</span>
    <span class="c1"># This class represents a Topic Model according to the LDA generative model</span>
    <span class="c1"># Essentially the TM is characterized by</span>
    <span class="c1"># _alphas: The weight of each topic</span>
    <span class="c1"># _betas: The weight of each word in the vocabulary</span>
    <span class="c1"># _thetas: The weight of each topic in each document</span>
    <span class="c1">#</span>
    <span class="c1"># The TM can be trained with Blei&#39;s LDA, Mallet, or any other toolbox that</span>
    <span class="c1"># produces a model according to this representation</span>

    <span class="c1"># Estas variables guardarán los valores originales de las alphas, betas, thetas</span>
    <span class="c1"># servirán para resetear el modelo después de su optimización</span>
    <span class="n">_betas_orig</span> <span class="o">=</span> <span class="kc">None</span>
    <span class="n">_thetas_orig</span> <span class="o">=</span> <span class="kc">None</span>
    <span class="n">_alphas_orig</span> <span class="o">=</span> <span class="kc">None</span>

    <span class="n">_betas</span> <span class="o">=</span> <span class="kc">None</span>
    <span class="n">_thetas</span> <span class="o">=</span> <span class="kc">None</span>
    <span class="n">_alphas</span> <span class="o">=</span> <span class="kc">None</span>
    <span class="n">_edits</span> <span class="o">=</span> <span class="kc">None</span>  <span class="c1"># Store all editions made to the model</span>
    <span class="n">_ntopics</span> <span class="o">=</span> <span class="kc">None</span>
    <span class="n">_betas_ds</span> <span class="o">=</span> <span class="kc">None</span>
    <span class="n">_topic_entropy</span> <span class="o">=</span> <span class="kc">None</span>
    <span class="n">_descriptions</span> <span class="o">=</span> <span class="kc">None</span>
    <span class="n">_vocab_w2id</span> <span class="o">=</span> <span class="kc">None</span>
    <span class="n">_vocab_id2w</span> <span class="o">=</span> <span class="kc">None</span>
    <span class="n">_vocabfreq</span> <span class="o">=</span> <span class="kc">None</span>
    <span class="n">_size_vocab</span> <span class="o">=</span> <span class="kc">None</span>
    <span class="n">_vocabfreq_file</span> <span class="o">=</span> <span class="kc">None</span>

<div class="viewcode-block" id="TMmodel.__init__"><a class="viewcode-back" href="../topicmodeling.html#topicmodeling.TMmodel.__init__">[docs]</a>    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">betas</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">thetas</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">alphas</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
                 <span class="n">vocabfreq_file</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">from_file</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">logger</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Inicializacion del model de topicos a partir de las matrices que lo caracterizan</span>
<span class="sd">        Ademas de inicializar las correspondientes variables del objeto, se recalcula el Vector</span>
<span class="sd">        beta con downscoring (palabras comunes son penalizadas), y se calculan las</span>
<span class="sd">        entropias de cada topico.</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        betas:</span>
<span class="sd">            Matriz numpy de tamaño n_topics x n_words (vocab de cada tópico)</span>
<span class="sd">        thetas:</span>
<span class="sd">            Matriz numpy de tamaño n_docs x n_topics (composición documental)</span>
<span class="sd">        alphas:</span>
<span class="sd">            Vector de longitud n_topics, con la importancia de cada perfil</span>
<span class="sd">        vocabfreq_file:</span>
<span class="sd">            Ruta a un fichero con el vocabulario correspondiente al modelo. Contiene también la frecuencia de cada términos del vocabulario</span>
<span class="sd">        from_file:</span>
<span class="sd">            If not None, contains the name of a file from which the object can be initialized</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="n">logger</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">logger</span> <span class="o">=</span> <span class="n">logger</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="kn">import</span> <span class="nn">logging</span>
            <span class="n">logging</span><span class="o">.</span><span class="n">basicConfig</span><span class="p">(</span><span class="n">level</span><span class="o">=</span><span class="s1">&#39;INFO&#39;</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">logger</span> <span class="o">=</span> <span class="n">logging</span><span class="o">.</span><span class="n">getLogger</span><span class="p">(</span><span class="s1">&#39;TMmodel&#39;</span><span class="p">)</span>

        <span class="c1"># Convert strings to Paths if necessary</span>
        <span class="k">if</span> <span class="n">vocabfreq_file</span><span class="p">:</span>
            <span class="n">vocabfreq_file</span> <span class="o">=</span> <span class="n">Path</span><span class="p">(</span><span class="n">vocabfreq_file</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">from_file</span><span class="p">:</span>
            <span class="n">from_file</span> <span class="o">=</span> <span class="n">Path</span><span class="p">(</span><span class="n">from_file</span><span class="p">)</span>

        <span class="c1"># Locate vocabfile for the model</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">vocabfreq_file</span> <span class="ow">and</span> <span class="n">from_file</span><span class="p">:</span>
            <span class="c1"># If not vocabfile was indicated, try to recover from same directory where model is</span>
            <span class="n">vocabfreq_file</span> <span class="o">=</span> <span class="n">from_file</span><span class="o">.</span><span class="n">parent</span><span class="o">.</span><span class="n">joinpath</span><span class="p">(</span><span class="s1">&#39;vocab_freq.txt&#39;</span><span class="p">)</span>

        <span class="k">if</span> <span class="ow">not</span> <span class="n">vocabfreq_file</span><span class="o">.</span><span class="n">is_file</span><span class="p">():</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s1">&#39;-- -- -- It was not possible to locate a valid vocabulary file.&#39;</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s1">&#39;-- -- -- The TMmodel could not be created&#39;</span><span class="p">)</span>
            <span class="k">return</span>

        <span class="c1"># Load vocabulary variables from file</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_vocab_w2id</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_vocab_id2w</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_vocabfreq</span> <span class="o">=</span> <span class="n">lee_vocabfreq</span><span class="p">(</span><span class="n">vocabfreq_file</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_size_vocab</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_vocabfreq</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_vocabfreq_file</span> <span class="o">=</span> <span class="n">vocabfreq_file</span>

        <span class="c1"># Create model from given data, or recover model from file</span>
        <span class="k">if</span> <span class="n">from_file</span><span class="p">:</span>
            <span class="n">data</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">load</span><span class="p">(</span><span class="n">from_file</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_alphas</span> <span class="o">=</span> <span class="n">data</span><span class="p">[</span><span class="s1">&#39;alphas&#39;</span><span class="p">]</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_betas</span> <span class="o">=</span> <span class="n">data</span><span class="p">[</span><span class="s1">&#39;betas&#39;</span><span class="p">]</span>
            <span class="k">if</span> <span class="s1">&#39;thetas&#39;</span> <span class="ow">in</span> <span class="n">data</span><span class="p">:</span>
                <span class="c1"># non-sparse thetas</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_thetas</span> <span class="o">=</span> <span class="n">data</span><span class="p">[</span><span class="s1">&#39;thetas&#39;</span><span class="p">]</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_thetas</span> <span class="o">=</span> <span class="n">sparse</span><span class="o">.</span><span class="n">csr_matrix</span><span class="p">((</span><span class="n">data</span><span class="p">[</span><span class="s1">&#39;thetas_data&#39;</span><span class="p">],</span> <span class="n">data</span><span class="p">[</span><span class="s1">&#39;thetas_indices&#39;</span><span class="p">],</span> <span class="n">data</span><span class="p">[</span><span class="s1">&#39;thetas_indptr&#39;</span><span class="p">]),</span>
                                                 <span class="n">shape</span><span class="o">=</span><span class="n">data</span><span class="p">[</span><span class="s1">&#39;thetas_shape&#39;</span><span class="p">])</span>

            <span class="bp">self</span><span class="o">.</span><span class="n">_alphas_orig</span> <span class="o">=</span> <span class="n">data</span><span class="p">[</span><span class="s1">&#39;alphas_orig&#39;</span><span class="p">]</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_betas_orig</span> <span class="o">=</span> <span class="n">data</span><span class="p">[</span><span class="s1">&#39;betas_orig&#39;</span><span class="p">]</span>
            <span class="k">if</span> <span class="s1">&#39;thetas_orig&#39;</span> <span class="ow">in</span> <span class="n">data</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_thetas_orig</span> <span class="o">=</span> <span class="n">data</span><span class="p">[</span><span class="s1">&#39;thetas_orig&#39;</span><span class="p">]</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_thetas_orig</span> <span class="o">=</span> <span class="n">sparse</span><span class="o">.</span><span class="n">csr_matrix</span><span class="p">((</span><span class="n">data</span><span class="p">[</span><span class="s1">&#39;thetas_orig_data&#39;</span><span class="p">],</span>
                                                       <span class="n">data</span><span class="p">[</span><span class="s1">&#39;thetas_orig_indices&#39;</span><span class="p">],</span> <span class="n">data</span><span class="p">[</span><span class="s1">&#39;thetas_orig_indptr&#39;</span><span class="p">]),</span>
                                                      <span class="n">shape</span><span class="o">=</span><span class="n">data</span><span class="p">[</span><span class="s1">&#39;thetas_orig_shape&#39;</span><span class="p">])</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_ntopics</span> <span class="o">=</span> <span class="n">data</span><span class="p">[</span><span class="s1">&#39;ntopics&#39;</span><span class="p">]</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_betas_ds</span> <span class="o">=</span> <span class="n">data</span><span class="p">[</span><span class="s1">&#39;betas_ds&#39;</span><span class="p">]</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_topic_entropy</span> <span class="o">=</span> <span class="n">data</span><span class="p">[</span><span class="s1">&#39;topic_entropy&#39;</span><span class="p">]</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_descriptions</span> <span class="o">=</span> <span class="p">[</span><span class="nb">str</span><span class="p">(</span><span class="n">x</span><span class="p">)</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">data</span><span class="p">[</span><span class="s1">&#39;descriptions&#39;</span><span class="p">]]</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_edits</span> <span class="o">=</span> <span class="p">[</span><span class="nb">str</span><span class="p">(</span><span class="n">x</span><span class="p">)</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">data</span><span class="p">[</span><span class="s1">&#39;edits&#39;</span><span class="p">]]</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="c1"># Cuando el modelo se genera desde el principio, tenemos que</span>
            <span class="c1"># guardar los alphas, betas y thetas tanto en las permanentes</span>
            <span class="c1"># como en las actuales que se utilizan para visualizar el modelo</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_betas_orig</span> <span class="o">=</span> <span class="n">betas</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_thetas_orig</span> <span class="o">=</span> <span class="n">thetas</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_alphas_orig</span> <span class="o">=</span> <span class="n">alphas</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_betas</span> <span class="o">=</span> <span class="n">betas</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_thetas</span> <span class="o">=</span> <span class="n">thetas</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_alphas</span> <span class="o">=</span> <span class="n">alphas</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_edits</span> <span class="o">=</span> <span class="p">[]</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_ntopics</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_thetas</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_calculate_other</span><span class="p">()</span>
            <span class="c1"># Descripciones</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_descriptions</span> <span class="o">=</span> <span class="p">[</span><span class="n">x</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span>
                                  <span class="bp">self</span><span class="o">.</span><span class="n">get_topic_word_descriptions</span><span class="p">()]</span>
            <span class="c1"># Reordenamiento inicial de tópicos</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">sort_topics</span><span class="p">()</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;-- -- -- Topic model object (TMmodel) successfully created&#39;</span><span class="p">)</span>
        <span class="k">return</span></div>

    <span class="k">def</span> <span class="nf">_calculate_other</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;This function is intended to calculate all other variables</span>
<span class="sd">        of the TMmodel object</span>
<span class="sd">            * self._betas_ds</span>
<span class="sd">            * self._topic_entropy</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c1"># ======</span>
        <span class="c1"># 1. self._betas_ds</span>
        <span class="c1"># Calculamos betas con down-scoring</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_betas_ds</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">copy</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_betas</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">np</span><span class="o">.</span><span class="n">min</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_betas_ds</span><span class="p">)</span> <span class="o">&lt;</span> <span class="mf">1e-12</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_betas_ds</span> <span class="o">+=</span> <span class="mf">1e-12</span>
        <span class="n">deno</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">reshape</span><span class="p">((</span><span class="nb">sum</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_betas_ds</span><span class="p">))</span> <span class="o">/</span> <span class="bp">self</span><span class="o">.</span><span class="n">_ntopics</span><span class="p">),</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_size_vocab</span><span class="p">,</span> <span class="mi">1</span><span class="p">))</span>
        <span class="n">deno</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">ones</span><span class="p">((</span><span class="bp">self</span><span class="o">.</span><span class="n">_ntopics</span><span class="p">,</span> <span class="mi">1</span><span class="p">))</span><span class="o">.</span><span class="n">dot</span><span class="p">(</span><span class="n">deno</span><span class="o">.</span><span class="n">T</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_betas_ds</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_betas_ds</span> <span class="o">*</span> <span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_betas_ds</span><span class="p">)</span> <span class="o">-</span> <span class="n">deno</span><span class="p">)</span>
        <span class="c1"># ======</span>
        <span class="c1"># 2. self._topic_entropy</span>
        <span class="c1"># Nos aseguramos de que no hay betas menores que 1e-12. En este caso betas nunca es sparse</span>
        <span class="k">if</span> <span class="n">np</span><span class="o">.</span><span class="n">min</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_betas</span><span class="p">)</span> <span class="o">&lt;</span> <span class="mf">1e-12</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_betas</span> <span class="o">+=</span> <span class="mf">1e-12</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_topic_entropy</span> <span class="o">=</span> <span class="o">-</span><span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_betas</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_betas</span><span class="p">),</span> <span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_topic_entropy</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_topic_entropy</span> <span class="o">/</span> <span class="n">np</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_size_vocab</span><span class="p">)</span>
        <span class="k">return</span>

<div class="viewcode-block" id="TMmodel.get_alphas"><a class="viewcode-back" href="../topicmodeling.html#topicmodeling.TMmodel.get_alphas">[docs]</a>    <span class="k">def</span> <span class="nf">get_alphas</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_alphas</span></div>

<div class="viewcode-block" id="TMmodel.get_betas"><a class="viewcode-back" href="../topicmodeling.html#topicmodeling.TMmodel.get_betas">[docs]</a>    <span class="k">def</span> <span class="nf">get_betas</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_betas</span></div>

<div class="viewcode-block" id="TMmodel.get_thetas"><a class="viewcode-back" href="../topicmodeling.html#topicmodeling.TMmodel.get_thetas">[docs]</a>    <span class="k">def</span> <span class="nf">get_thetas</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_thetas</span></div>

<div class="viewcode-block" id="TMmodel.get_ntopics"><a class="viewcode-back" href="../topicmodeling.html#topicmodeling.TMmodel.get_ntopics">[docs]</a>    <span class="k">def</span> <span class="nf">get_ntopics</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_ntopics</span></div>

<div class="viewcode-block" id="TMmodel.get_tpc_corrcoef"><a class="viewcode-back" href="../topicmodeling.html#topicmodeling.TMmodel.get_tpc_corrcoef">[docs]</a>    <span class="k">def</span> <span class="nf">get_tpc_corrcoef</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="c1"># Computes topic correlation. Highly correlated topics</span>
        <span class="c1"># co-occure together</span>
        <span class="c1"># Topic mean</span>
        <span class="n">med</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">asarray</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_thetas</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">))</span><span class="o">.</span><span class="n">ravel</span><span class="p">()</span>
        <span class="c1"># Topic square mean</span>
        <span class="n">thetas2</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_thetas</span><span class="o">.</span><span class="n">multiply</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_thetas</span><span class="p">)</span>
        <span class="n">med2</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">asarray</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">thetas2</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">))</span><span class="o">.</span><span class="n">ravel</span><span class="p">()</span>
        <span class="c1"># Topic stds</span>
        <span class="n">stds</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="n">med2</span> <span class="o">-</span> <span class="n">med</span> <span class="o">**</span> <span class="mi">2</span><span class="p">)</span>
        <span class="c1"># Topic correlation</span>
        <span class="n">num</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_thetas</span><span class="o">.</span><span class="n">T</span><span class="o">.</span><span class="n">dot</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_thetas</span><span class="p">)</span><span class="o">.</span><span class="n">toarray</span><span class="p">()</span> <span class="o">/</span> <span class="bp">self</span><span class="o">.</span><span class="n">_thetas</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
        <span class="n">num</span> <span class="o">=</span> <span class="n">num</span> <span class="o">-</span> <span class="n">med</span><span class="p">[</span><span class="o">...</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">newaxis</span><span class="p">]</span><span class="o">.</span><span class="n">dot</span><span class="p">(</span><span class="n">med</span><span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">newaxis</span><span class="p">,</span> <span class="o">...</span><span class="p">])</span>
        <span class="n">deno</span> <span class="o">=</span> <span class="n">stds</span><span class="p">[</span><span class="o">...</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">newaxis</span><span class="p">]</span><span class="o">.</span><span class="n">dot</span><span class="p">(</span><span class="n">stds</span><span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">newaxis</span><span class="p">,</span> <span class="o">...</span><span class="p">])</span>
        <span class="k">return</span> <span class="n">num</span> <span class="o">/</span> <span class="n">deno</span></div>

<div class="viewcode-block" id="TMmodel.get_tpc_JSdist"><a class="viewcode-back" href="../topicmodeling.html#topicmodeling.TMmodel.get_tpc_JSdist">[docs]</a>    <span class="k">def</span> <span class="nf">get_tpc_JSdist</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">thr</span><span class="o">=</span><span class="mf">1e-3</span><span class="p">):</span>
        <span class="c1"># Computes inter-topic distance based on word distributions</span>
        <span class="c1"># using Jensen Shannon distance</span>
        <span class="c1"># For a more efficient computation with very large vocabularies</span>
        <span class="c1"># we implement a threshold for restricting the distance calculation</span>
        <span class="c1"># to columns where any elment is greater than threshold thr</span>
        <span class="n">betas_aux</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_betas</span><span class="p">[:,</span> <span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_betas</span><span class="o">.</span><span class="n">max</span><span class="p">(</span><span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span> <span class="o">&gt;</span> <span class="n">thr</span><span class="p">)[</span><span class="mi">0</span><span class="p">]]</span>
        <span class="n">js_mat</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="bp">self</span><span class="o">.</span><span class="n">_ntopics</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_ntopics</span><span class="p">))</span>
        <span class="k">for</span> <span class="n">k</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_ntopics</span><span class="p">):</span>
            <span class="k">for</span> <span class="n">kk</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_ntopics</span><span class="p">):</span>
                <span class="n">js_mat</span><span class="p">[</span><span class="n">k</span><span class="p">,</span> <span class="n">kk</span><span class="p">]</span> <span class="o">=</span> <span class="n">jensenshannon</span><span class="p">(</span><span class="n">betas_aux</span><span class="p">[</span><span class="n">k</span><span class="p">,</span> <span class="p">:],</span> <span class="n">betas_aux</span><span class="p">[</span><span class="n">kk</span><span class="p">,</span> <span class="p">:])</span>
        <span class="k">return</span> <span class="n">js_mat</span></div>

<div class="viewcode-block" id="TMmodel.get_similar_corrcoef"><a class="viewcode-back" href="../topicmodeling.html#topicmodeling.TMmodel.get_similar_corrcoef">[docs]</a>    <span class="k">def</span> <span class="nf">get_similar_corrcoef</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">npairs</span><span class="p">):</span>
        <span class="c1"># Returns most similar pairs of topics by co-occurence of topics in docs</span>
        <span class="n">corrcoef</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_tpc_corrcoef</span><span class="p">()</span>
        <span class="n">selected</span> <span class="o">=</span> <span class="n">largest_indices</span><span class="p">(</span><span class="n">corrcoef</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_ntopics</span> <span class="o">+</span> <span class="mi">2</span> <span class="o">*</span> <span class="n">npairs</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">selected</span></div>

<div class="viewcode-block" id="TMmodel.get_similar_JSdist"><a class="viewcode-back" href="../topicmodeling.html#topicmodeling.TMmodel.get_similar_JSdist">[docs]</a>    <span class="k">def</span> <span class="nf">get_similar_JSdist</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">npairs</span><span class="p">,</span> <span class="n">thr</span><span class="o">=</span><span class="mf">1e-3</span><span class="p">):</span>
        <span class="c1"># Returns most similar pairs of topics by co-occurence of topics in docs</span>
        <span class="n">JSsim</span> <span class="o">=</span> <span class="mi">1</span> <span class="o">-</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_tpc_JSdist</span><span class="p">(</span><span class="n">thr</span><span class="p">)</span>
        <span class="n">selected</span> <span class="o">=</span> <span class="n">largest_indices</span><span class="p">(</span><span class="n">JSsim</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_ntopics</span> <span class="o">+</span> <span class="mi">2</span> <span class="o">*</span> <span class="n">npairs</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">selected</span></div>

<div class="viewcode-block" id="TMmodel.get_descriptions"><a class="viewcode-back" href="../topicmodeling.html#topicmodeling.TMmodel.get_descriptions">[docs]</a>    <span class="k">def</span> <span class="nf">get_descriptions</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">tpc</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">tpc</span><span class="p">:</span>
            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_descriptions</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_descriptions</span><span class="p">[</span><span class="n">tpc</span><span class="p">]</span></div>

<div class="viewcode-block" id="TMmodel.set_description"><a class="viewcode-back" href="../topicmodeling.html#topicmodeling.TMmodel.set_description">[docs]</a>    <span class="k">def</span> <span class="nf">set_description</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">desc_tpc</span><span class="p">,</span> <span class="n">tpc</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Set description of topic tpc to desc_tpc</span>
<span class="sd">        </span>
<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        desc_tpc:</span>
<span class="sd">            String with the description for the topic</span>
<span class="sd">        tpc:</span>
<span class="sd">            Number of topic</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="n">tpc</span> <span class="o">&gt;</span> <span class="bp">self</span><span class="o">.</span><span class="n">_ntopics</span> <span class="o">-</span> <span class="mi">1</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Error setting topic description: Topic ID is larger than number of topics&#39;</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_descriptions</span><span class="p">[</span><span class="n">tpc</span><span class="p">]</span> <span class="o">=</span> <span class="n">desc_tpc</span>
        <span class="k">return</span></div>

<div class="viewcode-block" id="TMmodel.lee_vocabfreq"><a class="viewcode-back" href="../topicmodeling.html#topicmodeling.TMmodel.lee_vocabfreq">[docs]</a>    <span class="k">def</span> <span class="nf">lee_vocabfreq</span><span class="p">(</span><span class="n">vocabfreq_path</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Lee el vocabulario del modelo que se encuentra en el fichero indicado</span>
<span class="sd">        Devuelve dos diccionarios, uno usando las palabras como llave, y el otro</span>
<span class="sd">        utilizando el id de la palabra como clave</span>
<span class="sd">        Devuelve también la lista de frequencias de cada término del vocabulario</span>
<span class="sd">        </span>
<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        vocabfreq_path: pathlib.Path</span>
<span class="sd">            Path con la ruta al vocabulario</span>
<span class="sd">        </span>
<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        : tuple(vocab_w2id,vocab_id2w)</span>
<span class="sd">            * vocab_w2id         : Diccionario {pal_i : id_pal_i}</span>
<span class="sd">            * vocab_id2w         : Diccionario {i     : pal_i}</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">vocab_w2id</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="n">vocab_id2w</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="n">vocabfreq</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">with</span> <span class="n">vocabfreq_path</span><span class="o">.</span><span class="n">open</span><span class="p">(</span><span class="s1">&#39;r&#39;</span><span class="p">,</span> <span class="n">encoding</span><span class="o">=</span><span class="s1">&#39;utf-8&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
            <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">line</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">f</span><span class="p">):</span>
                <span class="n">wd</span><span class="p">,</span> <span class="n">freq</span> <span class="o">=</span> <span class="n">line</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;</span><span class="se">\t</span><span class="s1">&#39;</span><span class="p">)</span>
                <span class="n">vocab_w2id</span><span class="p">[</span><span class="n">wd</span><span class="p">]</span> <span class="o">=</span> <span class="n">i</span>
                <span class="n">vocab_id2w</span><span class="p">[</span><span class="nb">str</span><span class="p">(</span><span class="n">i</span><span class="p">)]</span> <span class="o">=</span> <span class="n">wd</span>
                <span class="n">vocabfreq</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="nb">int</span><span class="p">(</span><span class="n">freq</span><span class="p">))</span>

        <span class="k">return</span> <span class="p">(</span><span class="n">vocab_w2id</span><span class="p">,</span> <span class="n">vocab_id2w</span><span class="p">,</span> <span class="n">vocabfreq</span><span class="p">)</span></div>

<div class="viewcode-block" id="TMmodel.save_npz"><a class="viewcode-back" href="../topicmodeling.html#topicmodeling.TMmodel.save_npz">[docs]</a>    <span class="k">def</span> <span class="nf">save_npz</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">npzfile</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Salva las matrices que caracterizan el modelo de tópicos en un fichero npz de numpy</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        npzfile:</span>
<span class="sd">            Nombre del fichero en el que se guardará el modelo</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_thetas</span><span class="p">,</span> <span class="n">sparse</span><span class="o">.</span><span class="n">csr_matrix</span><span class="p">):</span>
            <span class="n">np</span><span class="o">.</span><span class="n">savez</span><span class="p">(</span><span class="n">npzfile</span><span class="p">,</span> <span class="n">alphas</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">_alphas</span><span class="p">,</span> <span class="n">betas</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">_betas</span><span class="p">,</span>
                     <span class="n">thetas_data</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">_thetas</span><span class="o">.</span><span class="n">data</span><span class="p">,</span> <span class="n">thetas_indices</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">_thetas</span><span class="o">.</span><span class="n">indices</span><span class="p">,</span>
                     <span class="n">thetas_indptr</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">_thetas</span><span class="o">.</span><span class="n">indptr</span><span class="p">,</span> <span class="n">thetas_shape</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">_thetas</span><span class="o">.</span><span class="n">shape</span><span class="p">,</span>
                     <span class="n">alphas_orig</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">_alphas_orig</span><span class="p">,</span> <span class="n">betas_orig</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">_betas_orig</span><span class="p">,</span>
                     <span class="n">thetas_orig_data</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">_thetas_orig</span><span class="o">.</span><span class="n">data</span><span class="p">,</span> <span class="n">thetas_orig_indices</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">_thetas_orig</span><span class="o">.</span><span class="n">indices</span><span class="p">,</span>
                     <span class="n">thetas_orig_indptr</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">_thetas_orig</span><span class="o">.</span><span class="n">indptr</span><span class="p">,</span> <span class="n">thetas_orig_shape</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">_thetas_orig</span><span class="o">.</span><span class="n">shape</span><span class="p">,</span>
                     <span class="n">ntopics</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">_ntopics</span><span class="p">,</span> <span class="n">betas_ds</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">_betas_ds</span><span class="p">,</span> <span class="n">topic_entropy</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">_topic_entropy</span><span class="p">,</span>
                     <span class="n">descriptions</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">_descriptions</span><span class="p">,</span> <span class="n">edits</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">_edits</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">np</span><span class="o">.</span><span class="n">savez</span><span class="p">(</span><span class="n">npzfile</span><span class="p">,</span> <span class="n">alphas</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">_alphas</span><span class="p">,</span> <span class="n">betas</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">_betas</span><span class="p">,</span> <span class="n">thetas</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">_thetas</span><span class="p">,</span>
                     <span class="n">alphas_orig</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">_alphas_orig</span><span class="p">,</span> <span class="n">betas_orig</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">_betas_orig</span><span class="p">,</span> <span class="n">thetas_orig</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">_thetas_orig</span><span class="p">,</span>
                     <span class="n">ntopics</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">_ntopics</span><span class="p">,</span> <span class="n">betas_ds</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">_betas_ds</span><span class="p">,</span> <span class="n">topic_entropy</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">_topic_entropy</span><span class="p">,</span>
                     <span class="n">descriptions</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">_descriptions</span><span class="p">,</span> <span class="n">edits</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">_edits</span><span class="p">)</span>

        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_edits</span><span class="p">):</span>
            <span class="n">edits_file</span> <span class="o">=</span> <span class="n">Path</span><span class="p">(</span><span class="n">npzfile</span><span class="p">)</span><span class="o">.</span><span class="n">parent</span><span class="o">.</span><span class="n">joinpath</span><span class="p">(</span><span class="s1">&#39;model_edits.txt&#39;</span><span class="p">)</span>
            <span class="k">with</span> <span class="n">edits_file</span><span class="o">.</span><span class="n">open</span><span class="p">(</span><span class="s1">&#39;w&#39;</span><span class="p">,</span> <span class="n">encoding</span><span class="o">=</span><span class="s1">&#39;utf8&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">fout</span><span class="p">:</span>
                <span class="p">[</span><span class="n">fout</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">el</span> <span class="o">+</span> <span class="s1">&#39;</span><span class="se">\n</span><span class="s1">&#39;</span><span class="p">)</span> <span class="k">for</span> <span class="n">el</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_edits</span><span class="p">]</span></div>

<div class="viewcode-block" id="TMmodel.thetas2sparse"><a class="viewcode-back" href="../topicmodeling.html#topicmodeling.TMmodel.thetas2sparse">[docs]</a>    <span class="k">def</span> <span class="nf">thetas2sparse</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">thr</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Convert thetas matrix to CSR format</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        thr:</span>
<span class="sd">            Threshold to umbralize the matrix</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_thetas</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">_thetas</span> <span class="o">&lt;</span> <span class="n">thr</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_thetas</span> <span class="o">=</span> <span class="n">sparse</span><span class="o">.</span><span class="n">csr_matrix</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_thetas</span><span class="p">,</span> <span class="n">copy</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_thetas</span> <span class="o">=</span> <span class="n">normalize</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_thetas</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">norm</span><span class="o">=</span><span class="s1">&#39;l1&#39;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_thetas_orig</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">_thetas_orig</span> <span class="o">&lt;</span> <span class="n">thr</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_thetas_orig</span> <span class="o">=</span> <span class="n">sparse</span><span class="o">.</span><span class="n">csr_matrix</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_thetas_orig</span><span class="p">,</span> <span class="n">copy</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_thetas_orig</span> <span class="o">=</span> <span class="n">normalize</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_thetas_orig</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">norm</span><span class="o">=</span><span class="s1">&#39;l1&#39;</span><span class="p">)</span></div>

<div class="viewcode-block" id="TMmodel.muestra_perfiles"><a class="viewcode-back" href="../topicmodeling.html#topicmodeling.TMmodel.muestra_perfiles">[docs]</a>    <span class="k">def</span> <span class="nf">muestra_perfiles</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">n_palabras</span><span class="o">=</span><span class="mi">10</span><span class="p">,</span> <span class="n">tfidf</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">tpc</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Muestra por pantalla los perfiles del modelo lda por pantalla</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        n_palabas:</span>
<span class="sd">            Número de palabras a mostrar para cada perfil</span>
<span class="sd">        tfidf:</span>
<span class="sd">            Si True, se hace downscaling de palabras poco específicas (Blei and Lafferty, 2009)</span>
<span class="sd">        tpc:</span>
<span class="sd">            If not None, se imprimen los tópicos con ID en la lista tpc e.g.: tpc = [0,3,4]</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">tpc</span><span class="p">:</span>
            <span class="n">tpc</span> <span class="o">=</span> <span class="nb">range</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_ntopics</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">tpc</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">tfidf</span><span class="p">:</span>
                <span class="n">words</span> <span class="o">=</span> <span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">_vocab_id2w</span><span class="p">[</span><span class="nb">str</span><span class="p">(</span><span class="n">idx2</span><span class="p">)]</span>
                         <span class="k">for</span> <span class="n">idx2</span> <span class="ow">in</span> <span class="n">np</span><span class="o">.</span><span class="n">argsort</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_betas_ds</span><span class="p">[</span><span class="n">i</span><span class="p">])[::</span><span class="o">-</span><span class="mi">1</span><span class="p">][</span><span class="mi">0</span><span class="p">:</span><span class="n">n_palabras</span><span class="p">]]</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">words</span> <span class="o">=</span> <span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">_vocab_id2w</span><span class="p">[</span><span class="nb">str</span><span class="p">(</span><span class="n">idx2</span><span class="p">)]</span>
                         <span class="k">for</span> <span class="n">idx2</span> <span class="ow">in</span> <span class="n">np</span><span class="o">.</span><span class="n">argsort</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_betas</span><span class="p">[</span><span class="n">i</span><span class="p">])[::</span><span class="o">-</span><span class="mi">1</span><span class="p">][</span><span class="mi">0</span><span class="p">:</span><span class="n">n_palabras</span><span class="p">]]</span>
            <span class="nb">print</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">i</span><span class="p">)</span> <span class="o">+</span> <span class="s1">&#39;</span><span class="se">\t</span><span class="s1">&#39;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_alphas</span><span class="p">[</span><span class="n">i</span><span class="p">])</span> <span class="o">+</span> <span class="s1">&#39;</span><span class="se">\t</span><span class="s1">&#39;</span> <span class="o">+</span> <span class="s1">&#39;, &#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">words</span><span class="p">))</span>
        <span class="k">return</span></div>

<div class="viewcode-block" id="TMmodel.muestra_descriptions"><a class="viewcode-back" href="../topicmodeling.html#topicmodeling.TMmodel.muestra_descriptions">[docs]</a>    <span class="k">def</span> <span class="nf">muestra_descriptions</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">tpc</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">simple</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Muestra por pantalla las descripciones de los perfiles del modelo lda</span>
<span class="sd">        </span>
<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        tpc:</span>
<span class="sd">            If not None, se imprimen los tópicos con ID en la lista tpc e.g.: tpc = [0,3,4]</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">tpc</span><span class="p">:</span>
            <span class="n">tpc</span> <span class="o">=</span> <span class="nb">range</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_ntopics</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">tpc</span><span class="p">:</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">simple</span><span class="p">:</span>
                <span class="nb">print</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">i</span><span class="p">)</span> <span class="o">+</span> <span class="s1">&#39;</span><span class="se">\t</span><span class="s1">&#39;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_alphas</span><span class="p">[</span><span class="n">i</span><span class="p">])</span> <span class="o">+</span> <span class="s1">&#39;</span><span class="se">\t</span><span class="s1">&#39;</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">_descriptions</span><span class="p">[</span><span class="n">i</span><span class="p">])</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;</span><span class="se">\t</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_descriptions</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;, &#39;</span><span class="p">)))</span></div>

<div class="viewcode-block" id="TMmodel.get_topic_word_descriptions"><a class="viewcode-back" href="../topicmodeling.html#topicmodeling.TMmodel.get_topic_word_descriptions">[docs]</a>    <span class="k">def</span> <span class="nf">get_topic_word_descriptions</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">n_palabras</span><span class="o">=</span><span class="mi">15</span><span class="p">,</span> <span class="n">tfidf</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">tpc</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Devuelve una lista con las descripciones del modelo de tópicos</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        n_palabas:</span>
<span class="sd">            Número de palabras a mostrar para cada perfil</span>
<span class="sd">        tfidf:</span>
<span class="sd">            Si True, se hace downscaling de palabras poco específicas (Blei and Lafferty, 2009)</span>
<span class="sd">        tpc:</span>
<span class="sd">            If not None, se devuelven las descripciones de los tópicos con ID en la lista tpc e.g.: tpc = [0,3,4]                        </span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">tpc</span><span class="p">:</span>
            <span class="n">tpc</span> <span class="o">=</span> <span class="nb">range</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_ntopics</span><span class="p">)</span>
        <span class="n">tpc_descs</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">tpc</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">tfidf</span><span class="p">:</span>
                <span class="n">words</span> <span class="o">=</span> <span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">_vocab_id2w</span><span class="p">[</span><span class="nb">str</span><span class="p">(</span><span class="n">idx2</span><span class="p">)]</span>
                         <span class="k">for</span> <span class="n">idx2</span> <span class="ow">in</span> <span class="n">np</span><span class="o">.</span><span class="n">argsort</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_betas_ds</span><span class="p">[</span><span class="n">i</span><span class="p">])[::</span><span class="o">-</span><span class="mi">1</span><span class="p">][</span><span class="mi">0</span><span class="p">:</span><span class="n">n_palabras</span><span class="p">]]</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">words</span> <span class="o">=</span> <span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">_vocab_id2w</span><span class="p">[</span><span class="nb">str</span><span class="p">(</span><span class="n">idx2</span><span class="p">)]</span>
                         <span class="k">for</span> <span class="n">idx2</span> <span class="ow">in</span> <span class="n">np</span><span class="o">.</span><span class="n">argsort</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_betas</span><span class="p">[</span><span class="n">i</span><span class="p">])[::</span><span class="o">-</span><span class="mi">1</span><span class="p">][</span><span class="mi">0</span><span class="p">:</span><span class="n">n_palabras</span><span class="p">]]</span>
            <span class="n">tpc_descs</span><span class="o">.</span><span class="n">append</span><span class="p">((</span><span class="n">i</span><span class="p">,</span> <span class="s1">&#39;, &#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">words</span><span class="p">)))</span>
        <span class="k">return</span> <span class="n">tpc_descs</span></div>

<div class="viewcode-block" id="TMmodel.most_significant_words_per_topic"><a class="viewcode-back" href="../topicmodeling.html#topicmodeling.TMmodel.most_significant_words_per_topic">[docs]</a>    <span class="k">def</span> <span class="nf">most_significant_words_per_topic</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">n_palabras</span><span class="o">=</span><span class="mi">10</span><span class="p">,</span> <span class="n">tfidf</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">tpc</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Devuelve una lista de listas de tuplas, en el formato:</span>
<span class="sd">        ::</span>

<span class="sd">            [  [(palabra1tpc1, beta), (palabra2tpc1, beta)],</span>
<span class="sd">            [   (palabra1tpc2, beta), (palabra2tpc2, beta)]   ]</span>
<span class="sd">        </span>
<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        n_palabas:</span>
<span class="sd">            Número de palabras que se devuelven para cada perfil</span>
<span class="sd">        tfidf:</span>
<span class="sd">            Si True, para la relevancia se emplea el downscaling de palabras poco específicas de (Blei and Lafferty, 2009)</span>
<span class="sd">        tpc:</span>
<span class="sd">            If not None, se devuelven únicamente las descripciones de los tópicos con ID en la lista tpc e.g.: tpc = [0,3,4]                        </span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">tpc</span><span class="p">:</span>
            <span class="n">tpc</span> <span class="o">=</span> <span class="nb">range</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_ntopics</span><span class="p">)</span>
        <span class="n">mswpt</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">tpc</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">tfidf</span><span class="p">:</span>
                <span class="n">words</span> <span class="o">=</span> <span class="p">[(</span><span class="bp">self</span><span class="o">.</span><span class="n">_vocab_id2w</span><span class="p">[</span><span class="nb">str</span><span class="p">(</span><span class="n">idx2</span><span class="p">)],</span> <span class="bp">self</span><span class="o">.</span><span class="n">_betas</span><span class="p">[</span><span class="n">i</span><span class="p">,</span> <span class="n">idx2</span><span class="p">])</span>
                         <span class="k">for</span> <span class="n">idx2</span> <span class="ow">in</span> <span class="n">np</span><span class="o">.</span><span class="n">argsort</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_betas_ds</span><span class="p">[</span><span class="n">i</span><span class="p">])[::</span><span class="o">-</span><span class="mi">1</span><span class="p">][</span><span class="mi">0</span><span class="p">:</span><span class="n">n_palabras</span><span class="p">]]</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">words</span> <span class="o">=</span> <span class="p">[(</span><span class="bp">self</span><span class="o">.</span><span class="n">_vocab_id2w</span><span class="p">[</span><span class="nb">str</span><span class="p">(</span><span class="n">idx2</span><span class="p">)],</span> <span class="bp">self</span><span class="o">.</span><span class="n">_betas</span><span class="p">[</span><span class="n">i</span><span class="p">,</span> <span class="n">idx2</span><span class="p">])</span>
                         <span class="k">for</span> <span class="n">idx2</span> <span class="ow">in</span> <span class="n">np</span><span class="o">.</span><span class="n">argsort</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_betas</span><span class="p">[</span><span class="n">i</span><span class="p">])[::</span><span class="o">-</span><span class="mi">1</span><span class="p">][</span><span class="mi">0</span><span class="p">:</span><span class="n">n_palabras</span><span class="p">]]</span>
            <span class="n">mswpt</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">words</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">mswpt</span></div>

<div class="viewcode-block" id="TMmodel.ndocs_active_topic"><a class="viewcode-back" href="../topicmodeling.html#topicmodeling.TMmodel.ndocs_active_topic">[docs]</a>    <span class="k">def</span> <span class="nf">ndocs_active_topic</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Returns the number of documents where each topic is active&quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_thetas</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">)</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span><span class="o">.</span><span class="n">tolist</span><span class="p">()[</span><span class="mi">0</span><span class="p">]</span></div>

<div class="viewcode-block" id="TMmodel.delete_topic"><a class="viewcode-back" href="../topicmodeling.html#topicmodeling.TMmodel.delete_topic">[docs]</a>    <span class="k">def</span> <span class="nf">delete_topic</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">tpc</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Deletes the indicated topic</span>
<span class="sd">        </span>
<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        tpc:</span>
<span class="sd">            The topic to delete (an integer in range 0:ntopics)</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c1"># Keep record of model changes</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_edits</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s1">&#39;d &#39;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">tpc</span><span class="p">))</span>
        <span class="c1"># Update data matrices</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_betas</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">delete</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_betas</span><span class="p">,</span> <span class="n">tpc</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span>
        <span class="c1"># It could be more efficient, but this complies with full and csr matrices</span>
        <span class="n">tpc_keep</span> <span class="o">=</span> <span class="p">[</span><span class="n">k</span> <span class="k">for</span> <span class="n">k</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_ntopics</span><span class="p">)</span> <span class="k">if</span> <span class="n">k</span> <span class="o">!=</span> <span class="n">tpc</span><span class="p">]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_thetas</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_thetas</span><span class="p">[:,</span> <span class="n">tpc_keep</span><span class="p">]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_thetas</span> <span class="o">=</span> <span class="n">normalize</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_thetas</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">norm</span><span class="o">=</span><span class="s1">&#39;l1&#39;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_alphas</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">asarray</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_thetas</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">))</span><span class="o">.</span><span class="n">ravel</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_ntopics</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_thetas</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>

        <span class="c1"># Remove topic description</span>
        <span class="k">del</span> <span class="bp">self</span><span class="o">.</span><span class="n">_descriptions</span><span class="p">[</span><span class="n">tpc</span><span class="p">]</span>
        <span class="c1"># Recalculate all other stuff</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_calculate_other</span><span class="p">()</span>

        <span class="k">return</span></div>

<div class="viewcode-block" id="TMmodel.fuse_topics"><a class="viewcode-back" href="../topicmodeling.html#topicmodeling.TMmodel.fuse_topics">[docs]</a>    <span class="k">def</span> <span class="nf">fuse_topics</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">tpcs</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Hard fusion of several topics</span>
<span class="sd">        </span>
<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        tpcs:</span>
<span class="sd">            List of topics for the fusion</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c1"># Keep record of model chages</span>
        <span class="n">tpcs</span> <span class="o">=</span> <span class="nb">sorted</span><span class="p">(</span><span class="n">tpcs</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_edits</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s1">&#39;f &#39;</span> <span class="o">+</span> <span class="s1">&#39; &#39;</span><span class="o">.</span><span class="n">join</span><span class="p">([</span><span class="nb">str</span><span class="p">(</span><span class="n">el</span><span class="p">)</span> <span class="k">for</span> <span class="n">el</span> <span class="ow">in</span> <span class="n">tpcs</span><span class="p">]))</span>
        <span class="c1"># Update data matrices. For beta we keep an average of topic vectors</span>
        <span class="n">weights</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_alphas</span><span class="p">[</span><span class="n">tpcs</span><span class="p">]</span>
        <span class="n">bet</span> <span class="o">=</span> <span class="n">weights</span><span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">newaxis</span><span class="p">,</span> <span class="o">...</span><span class="p">]</span><span class="o">.</span><span class="n">dot</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_betas</span><span class="p">[</span><span class="n">tpcs</span><span class="p">,</span> <span class="p">:])</span> <span class="o">/</span> <span class="p">(</span><span class="nb">sum</span><span class="p">(</span><span class="n">weights</span><span class="p">))</span>
        <span class="c1"># keep new topic vector in upper position</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_betas</span><span class="p">[</span><span class="n">tpcs</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="p">:]</span> <span class="o">=</span> <span class="n">bet</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_betas</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">delete</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_betas</span><span class="p">,</span> <span class="n">tpcs</span><span class="p">[</span><span class="mi">1</span><span class="p">:],</span> <span class="mi">0</span><span class="p">)</span>
        <span class="c1"># For theta we need to keep the sum. Since adding implies changing</span>
        <span class="c1"># structure, we need to convert to full matrix first</span>
        <span class="c1"># No need to renormalize</span>
        <span class="n">thetas_full</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_thetas</span><span class="o">.</span><span class="n">toarray</span><span class="p">()</span>
        <span class="n">thet</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">thetas_full</span><span class="p">[:,</span> <span class="n">tpcs</span><span class="p">],</span> <span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
        <span class="n">thetas_full</span><span class="p">[:,</span> <span class="n">tpcs</span><span class="p">[</span><span class="mi">0</span><span class="p">]]</span> <span class="o">=</span> <span class="n">thet</span>
        <span class="n">thetas_full</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">delete</span><span class="p">(</span><span class="n">thetas_full</span><span class="p">,</span> <span class="n">tpcs</span><span class="p">[</span><span class="mi">1</span><span class="p">:],</span> <span class="mi">1</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_thetas</span> <span class="o">=</span> <span class="n">sparse</span><span class="o">.</span><span class="n">csr_matrix</span><span class="p">(</span><span class="n">thetas_full</span><span class="p">,</span> <span class="n">copy</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
        <span class="c1"># Compute new alphas and number of topics</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_alphas</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">asarray</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_thetas</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">))</span><span class="o">.</span><span class="n">ravel</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_ntopics</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_thetas</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>

        <span class="c1"># Remove topic descriptions</span>
        <span class="k">for</span> <span class="n">tpc</span> <span class="ow">in</span> <span class="n">tpcs</span><span class="p">[</span><span class="mi">1</span><span class="p">:]:</span>
            <span class="k">del</span> <span class="bp">self</span><span class="o">.</span><span class="n">_descriptions</span><span class="p">[</span><span class="n">tpc</span><span class="p">]</span>

        <span class="c1"># Recalculate all other stuff</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_calculate_other</span><span class="p">()</span>

        <span class="k">return</span></div>

<div class="viewcode-block" id="TMmodel.sort_topics"><a class="viewcode-back" href="../topicmodeling.html#topicmodeling.TMmodel.sort_topics">[docs]</a>    <span class="k">def</span> <span class="nf">sort_topics</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Sort topics according to topic size&quot;&quot;&quot;</span>
        <span class="c1"># Indexes for topics reordering</span>
        <span class="n">idx</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">argsort</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_alphas</span><span class="p">)[::</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_edits</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s1">&#39;s &#39;</span> <span class="o">+</span> <span class="s1">&#39; &#39;</span><span class="o">.</span><span class="n">join</span><span class="p">([</span><span class="nb">str</span><span class="p">(</span><span class="n">el</span><span class="p">)</span> <span class="k">for</span> <span class="n">el</span> <span class="ow">in</span> <span class="n">idx</span><span class="p">]))</span>

        <span class="c1"># Sort data matrices</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_alphas</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_alphas</span><span class="p">[</span><span class="n">idx</span><span class="p">]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_betas</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_betas</span><span class="p">[</span><span class="n">idx</span><span class="p">,</span> <span class="p">:]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_thetas</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_thetas</span><span class="p">[:,</span> <span class="n">idx</span><span class="p">]</span>

        <span class="c1"># Sort topic descriptions</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_descriptions</span> <span class="o">=</span> <span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">_descriptions</span><span class="p">[</span><span class="n">k</span><span class="p">]</span> <span class="k">for</span> <span class="n">k</span> <span class="ow">in</span> <span class="n">idx</span><span class="o">.</span><span class="n">tolist</span><span class="p">()]</span>

        <span class="c1"># Recalculate all other stuff</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_calculate_other</span><span class="p">()</span>

        <span class="k">return</span></div>

<div class="viewcode-block" id="TMmodel.reset_model"><a class="viewcode-back" href="../topicmodeling.html#topicmodeling.TMmodel.reset_model">[docs]</a>    <span class="k">def</span> <span class="nf">reset_model</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Resetea el modelo al resultado del LDA original con todos los tópicos&quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="fm">__init__</span><span class="p">(</span><span class="n">betas</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">_betas_orig</span><span class="p">,</span> <span class="n">thetas</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">_thetas_orig</span><span class="p">,</span>
                      <span class="n">alphas</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">_alphas_orig</span><span class="p">,</span> <span class="n">vocabfreq_file</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">_vocabfreq_file</span><span class="p">)</span>
        <span class="k">return</span></div>

<div class="viewcode-block" id="TMmodel.pyLDAvis"><a class="viewcode-back" href="../topicmodeling.html#topicmodeling.TMmodel.pyLDAvis">[docs]</a>    <span class="k">def</span> <span class="nf">pyLDAvis</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">htmlfile</span><span class="p">,</span> <span class="n">ndocs</span><span class="p">,</span> <span class="n">njobs</span><span class="o">=-</span><span class="mi">1</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Generación de la visualización de pyLDAvis</span>
<span class="sd">        La visualización se almacena en el fichero que se recibe como argumento</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        htmlfile:</span>
<span class="sd">            Path to generated html file</span>
<span class="sd">        ndocs:</span>
<span class="sd">            Number of documents used to compute the visualization</span>
<span class="sd">        njobs:</span>
<span class="sd">            Number of jobs used to accelerate pyLDAvis</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">([</span><span class="n">el</span> <span class="k">for</span> <span class="n">el</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_edits</span> <span class="k">if</span> <span class="n">el</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s1">&#39;d&#39;</span><span class="p">)]):</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s1">&#39;-- -- -- pyLDAvis: El modelo ha sido editado y se han eliminado tópicos.&#39;</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s1">&#39;-- -- -- pyLDAvis: No se puede generar la visualización.&#39;</span><span class="p">)</span>
            <span class="k">return</span>

        <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Generating pyLDAvisualization. This is an intensive task, consider sampling number of documents&#39;</span><span class="p">)</span>
        <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;The corpus you are using has been trained on&#39;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_thetas</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="s1">&#39;documents&#39;</span><span class="p">)</span>
        <span class="c1"># Ask user for a different number of docs, than default setting in config file</span>
        <span class="n">ndocs</span> <span class="o">=</span> <span class="n">var_num_keyboard</span><span class="p">(</span><span class="s1">&#39;int&#39;</span><span class="p">,</span> <span class="n">ndocs</span><span class="p">,</span>
                                 <span class="s1">&#39;How many documents should be used to compute the visualization?&#39;</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">ndocs</span> <span class="o">&gt;</span> <span class="bp">self</span><span class="o">.</span><span class="n">_thetas</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]:</span>
            <span class="n">ndocs</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_thetas</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
        <span class="n">perm</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sort</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">permutation</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_thetas</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">])[:</span><span class="n">ndocs</span><span class="p">])</span>
        <span class="c1"># We consider all documents are equally important</span>
        <span class="n">doc_len</span> <span class="o">=</span> <span class="n">ndocs</span> <span class="o">*</span> <span class="p">[</span><span class="mi">1</span><span class="p">]</span>
        <span class="n">vocab</span> <span class="o">=</span> <span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">_vocab_id2w</span><span class="p">[</span><span class="nb">str</span><span class="p">(</span><span class="n">k</span><span class="p">)]</span> <span class="k">for</span> <span class="n">k</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_vocab_id2w</span><span class="p">))]</span>
        <span class="n">vis_data</span> <span class="o">=</span> <span class="n">pyLDAvis</span><span class="o">.</span><span class="n">prepare</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_betas</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_thetas</span><span class="p">[</span><span class="n">perm</span><span class="p">,]</span><span class="o">.</span><span class="n">toarray</span><span class="p">(),</span>
                                    <span class="n">doc_len</span><span class="p">,</span> <span class="n">vocab</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_vocabfreq</span><span class="p">,</span> <span class="n">lambda_step</span><span class="o">=</span><span class="mf">0.05</span><span class="p">,</span>
                                    <span class="n">sort_topics</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">n_jobs</span><span class="o">=</span><span class="n">njobs</span><span class="p">)</span>
        <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Se ha generado la visualización. El fichero se guardará en la carpeta del modelo:&#39;</span><span class="p">)</span>
        <span class="nb">print</span><span class="p">(</span><span class="n">htmlfile</span><span class="p">)</span>
        <span class="n">pyLDAvis</span><span class="o">.</span><span class="n">save_html</span><span class="p">(</span><span class="n">vis_data</span><span class="p">,</span> <span class="n">htmlfile</span><span class="p">)</span>
        <span class="k">return</span></div>

<div class="viewcode-block" id="TMmodel.automatic_topic_labeling"><a class="viewcode-back" href="../topicmodeling.html#topicmodeling.TMmodel.automatic_topic_labeling">[docs]</a>    <span class="k">def</span> <span class="nf">automatic_topic_labeling</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">pathlabeling</span><span class="p">,</span> <span class="n">ranking</span><span class="o">=</span><span class="s1">&#39;unsupervised&#39;</span><span class="p">,</span> <span class="n">nwords</span><span class="o">=</span><span class="mi">10</span><span class="p">,</span> <span class="n">workers</span><span class="o">=</span><span class="mi">3</span><span class="p">,</span>
                                 <span class="n">num_candidates</span><span class="o">=</span><span class="mi">19</span><span class="p">,</span> <span class="n">num_unsup_labels</span><span class="o">=</span><span class="mi">5</span><span class="p">,</span> <span class="n">num_sup_labels</span><span class="o">=</span><span class="mi">5</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Genera vector de descripciones para los tópcios de un modelo</span>
<span class="sd">        Las descripciones o títulos de los tópicos se guardan en `self._descriptions`</span>

<span class="sd">        .. sectionauthor:: Simón Roca Sotelo</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        pathlabeling:</span>
<span class="sd">            Root path to NETL files</span>
<span class="sd">        ranking:</span>
<span class="sd">            Method to rank candidates (&#39;supervised&#39;,&#39;unsupervised&#39;,&#39;both&#39;)</span>
<span class="sd">        nwords:</span>
<span class="sd">            Number of words for representing a topic.</span>
<span class="sd">        workers:</span>
<span class="sd">            Number of workers for parallel computation</span>
<span class="sd">        num_candidates:</span>
<span class="sd">            Number of candidates for each topic</span>
<span class="sd">        num_unsup_labels:</span>
<span class="sd">            Top N unsupervised labels to propose</span>
<span class="sd">        num_sup_labels:</span>
<span class="sd">            Top N supervised labels to propose</span>
<span class="sd">        </span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;-- -- -- NETL: Running automatic_topic_labeling ...&#39;</span><span class="p">)</span>

        <span class="c1"># Make sure pathlabeling is a Path</span>
        <span class="n">pathlabeling</span> <span class="o">=</span> <span class="n">Path</span><span class="p">(</span><span class="n">pathlabeling</span><span class="p">)</span>
        <span class="c1"># Relative paths to needed files (pre-trained models)</span>
        <span class="n">doc2vecmodel</span> <span class="o">=</span> <span class="n">pathlabeling</span><span class="o">.</span><span class="n">joinpath</span><span class="p">(</span><span class="s1">&#39;pre_trained_models&#39;</span><span class="p">,</span> <span class="s1">&#39;doc2vec&#39;</span><span class="p">,</span> <span class="s1">&#39;docvecmodel.d2v&#39;</span><span class="p">)</span>
        <span class="n">word2vecmodel</span> <span class="o">=</span> <span class="n">pathlabeling</span><span class="o">.</span><span class="n">joinpath</span><span class="p">(</span><span class="s1">&#39;pre_trained_models&#39;</span><span class="p">,</span> <span class="s1">&#39;word2vec&#39;</span><span class="p">,</span> <span class="s1">&#39;word2vec&#39;</span><span class="p">)</span>
        <span class="n">doc2vec_indices_file</span> <span class="o">=</span> <span class="n">pathlabeling</span><span class="o">.</span><span class="n">joinpath</span><span class="p">(</span><span class="s1">&#39;support_files&#39;</span><span class="p">,</span> <span class="s1">&#39;doc2vec_indices&#39;</span><span class="p">)</span>
        <span class="n">word2vec_indices_file</span> <span class="o">=</span> <span class="n">pathlabeling</span><span class="o">.</span><span class="n">joinpath</span><span class="p">(</span><span class="s1">&#39;support_files&#39;</span><span class="p">,</span> <span class="s1">&#39;word2vec_indices&#39;</span><span class="p">)</span>
        <span class="c1"># This is precomputed pagerank model needed to genrate pagerank features.</span>
        <span class="n">pagerank_model</span> <span class="o">=</span> <span class="n">pathlabeling</span><span class="o">.</span><span class="n">joinpath</span><span class="p">(</span><span class="s1">&#39;support_files&#39;</span><span class="p">,</span> <span class="s1">&#39;pagerank-titles-sorted.txt&#39;</span><span class="p">)</span>
        <span class="c1"># SVM rank classify. After you download SVM Ranker classify gibve the path of svm_rank_classify here</span>
        <span class="n">svm_classify</span> <span class="o">=</span> <span class="n">pathlabeling</span><span class="o">.</span><span class="n">joinpath</span><span class="p">(</span><span class="s1">&#39;support_files&#39;</span><span class="p">,</span> <span class="s1">&#39;svm_rank_classify&#39;</span><span class="p">)</span>
        <span class="c1"># This is trained supervised model on the whole our dataset.</span>
        <span class="c1"># Run train train_svm_model.py if you want a new model on different dataset. </span>
        <span class="n">pretrained_svm_model</span> <span class="o">=</span> <span class="n">pathlabeling</span><span class="o">.</span><span class="n">joinpath</span><span class="p">(</span><span class="s1">&#39;support_files&#39;</span><span class="p">,</span> <span class="s1">&#39;svm_model&#39;</span><span class="p">)</span>

        <span class="c1"># Relative paths to temporal files created during execution.</span>
        <span class="n">out_sup</span> <span class="o">=</span> <span class="n">pathlabeling</span><span class="o">.</span><span class="n">joinpath</span><span class="p">(</span><span class="s1">&#39;output_supervised&#39;</span><span class="p">)</span>  <span class="c1"># The output file for supervised labels.</span>
        <span class="n">data</span> <span class="o">=</span> <span class="n">pathlabeling</span><span class="o">.</span><span class="n">joinpath</span><span class="p">(</span><span class="s1">&#39;temp_topics.csv&#39;</span><span class="p">)</span>
        <span class="n">out_unsup</span> <span class="o">=</span> <span class="n">pathlabeling</span><span class="o">.</span><span class="n">joinpath</span><span class="p">(</span><span class="s1">&#39;output_unsupervised&#39;</span><span class="p">)</span>
        <span class="n">cand_gen_output</span> <span class="o">=</span> <span class="n">pathlabeling</span><span class="o">.</span><span class="n">joinpath</span><span class="p">(</span><span class="s1">&#39;output_candidates&#39;</span><span class="p">)</span>

        <span class="c1"># Deleting temporal files if they exist from a previous run.</span>
        <span class="n">temp_files</span> <span class="o">=</span> <span class="p">[</span><span class="n">cand_gen_output</span><span class="p">,</span> <span class="n">data</span><span class="p">,</span> <span class="n">out_sup</span><span class="p">,</span> <span class="n">out_unsup</span><span class="p">]</span>
        <span class="p">[</span><span class="n">f</span><span class="o">.</span><span class="n">unlink</span><span class="p">()</span> <span class="k">for</span> <span class="n">f</span> <span class="ow">in</span> <span class="n">temp_files</span> <span class="k">if</span> <span class="n">f</span><span class="o">.</span><span class="n">is_file</span><span class="p">()]</span>

        <span class="c1"># Topics to a temporal file.</span>
        <span class="n">descr</span> <span class="o">=</span> <span class="p">[</span><span class="n">x</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_topic_word_descriptions</span><span class="p">(</span><span class="n">n_palabras</span><span class="o">=</span><span class="n">nwords</span><span class="p">,</span> <span class="n">tfidf</span><span class="o">=</span><span class="kc">False</span><span class="p">)]</span>
        <span class="k">with</span> <span class="n">data</span><span class="o">.</span><span class="n">open</span><span class="p">(</span><span class="s1">&#39;w&#39;</span><span class="p">,</span> <span class="n">encoding</span><span class="o">=</span><span class="s1">&#39;utf-8&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
            <span class="n">head</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;topic_id&#39;</span><span class="p">]</span>
            <span class="k">for</span> <span class="n">n</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">nwords</span><span class="p">):</span>
                <span class="n">head</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s1">&#39;term&#39;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">n</span><span class="p">))</span>
            <span class="n">f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s1">&#39;,&#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">head</span><span class="p">)</span> <span class="o">+</span> <span class="s1">&#39;</span><span class="se">\n</span><span class="s1">&#39;</span><span class="p">)</span>
            <span class="k">for</span> <span class="n">el</span> <span class="ow">in</span> <span class="n">descr</span><span class="p">:</span>
                <span class="n">f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">el</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s1">&#39;, &#39;</span><span class="p">,</span> <span class="s1">&#39;,&#39;</span><span class="p">))</span>
                <span class="n">f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s1">&#39;</span><span class="se">\n</span><span class="s1">&#39;</span><span class="p">)</span>

        <span class="c1"># Calling external script for candidate generation.</span>
        <span class="n">query1</span> <span class="o">=</span> <span class="s1">&#39;python &#39;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">pathlabeling</span><span class="o">.</span><span class="n">joinpath</span><span class="p">(</span><span class="s1">&#39;cand_generation.py&#39;</span><span class="p">))</span> <span class="o">+</span> <span class="s1">&#39; &#39;</span> <span class="o">+</span> \
                 <span class="nb">str</span><span class="p">(</span><span class="n">num_candidates</span><span class="p">)</span> <span class="o">+</span> <span class="s1">&#39; &#39;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">doc2vecmodel</span><span class="p">)</span> <span class="o">+</span> <span class="s1">&#39; &#39;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">word2vecmodel</span><span class="p">)</span> <span class="o">+</span> \
                 <span class="s1">&#39; &#39;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">data</span><span class="p">)</span> <span class="o">+</span> <span class="s1">&#39; &#39;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">cand_gen_output</span><span class="p">)</span> <span class="o">+</span> <span class="s1">&#39; &#39;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">doc2vec_indices_file</span><span class="p">)</span> <span class="o">+</span> \
                 <span class="s1">&#39; &#39;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">word2vec_indices_file</span><span class="p">)</span> <span class="o">+</span> <span class="s1">&#39; &#39;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">workers</span><span class="p">)</span>

        <span class="k">try</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s1">&#39;-- -- -- NETL: Extracting candidate labels&#39;</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s1">&#39;-- -- -- NETL: Query is gonna be: &#39;</span> <span class="o">+</span> <span class="n">query1</span><span class="p">)</span>
            <span class="n">check_output</span><span class="p">(</span><span class="n">args</span><span class="o">=</span><span class="n">query1</span><span class="p">,</span> <span class="n">shell</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
        <span class="k">except</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s1">&#39;-- -- -- NETL failed to extract labels. Revise your command&#39;</span><span class="p">)</span>
            <span class="k">return</span>

        <span class="n">final</span> <span class="o">=</span> <span class="p">[]</span>

        <span class="c1"># Ranking the previously obtained candidates, in the variants mentioned above.</span>
        <span class="k">try</span><span class="p">:</span>

            <span class="k">if</span> <span class="n">ranking</span> <span class="o">==</span> <span class="s1">&#39;both&#39;</span> <span class="ow">or</span> <span class="n">ranking</span> <span class="o">==</span> <span class="s1">&#39;supervised&#39;</span><span class="p">:</span>
                <span class="n">query2</span> <span class="o">=</span> <span class="s1">&#39;python &#39;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">pathlabeling</span><span class="o">.</span><span class="n">joinpath</span><span class="p">(</span><span class="s1">&#39;supervised_labels.py&#39;</span><span class="p">))</span> <span class="o">+</span> \
                         <span class="s1">&#39; &#39;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">num_sup_labels</span><span class="p">)</span> <span class="o">+</span> <span class="s1">&#39; &#39;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">pagerank_model</span><span class="p">)</span> <span class="o">+</span> <span class="s1">&#39; &#39;</span> <span class="o">+</span> \
                         <span class="nb">str</span><span class="p">(</span><span class="n">data</span><span class="p">)</span> <span class="o">+</span> <span class="s1">&#39; &#39;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">cand_gen_output</span><span class="p">)</span> <span class="o">+</span> <span class="s1">&#39; &#39;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">svm_classify</span><span class="p">)</span> <span class="o">+</span> \
                         <span class="s1">&#39; &#39;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">pretrained_svm_model</span><span class="p">)</span> <span class="o">+</span> <span class="s1">&#39; &#39;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">out_sup</span><span class="p">)</span>
                <span class="k">try</span><span class="p">:</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s1">&#39;-- -- -- NETL: Executing Supervised Model&#39;</span><span class="p">)</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s1">&#39;-- -- -- NETL: Query is gonna be: &#39;</span> <span class="o">+</span> <span class="n">query2</span><span class="p">)</span>
                    <span class="n">check_output</span><span class="p">(</span><span class="n">args</span><span class="o">=</span><span class="n">query2</span><span class="p">,</span> <span class="n">shell</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
                <span class="k">except</span><span class="p">:</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s1">&#39;-- -- -- NETL failed to extract labels (sup). Revise your command&#39;</span><span class="p">)</span>
                    <span class="k">return</span>

                <span class="n">sup</span> <span class="o">=</span> <span class="p">[]</span>
                <span class="k">with</span> <span class="n">out_sup</span><span class="o">.</span><span class="n">open</span><span class="p">(</span><span class="s1">&#39;r&#39;</span><span class="p">,</span> <span class="n">encoding</span><span class="o">=</span><span class="s1">&#39;utf-8&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
                    <span class="k">for</span> <span class="n">l</span> <span class="ow">in</span> <span class="n">f</span><span class="o">.</span><span class="n">readlines</span><span class="p">():</span>
                        <span class="n">sup</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">l</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s1">&#39;</span><span class="se">\n</span><span class="s1">&#39;</span><span class="p">,</span> <span class="s1">&#39;&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;,&#39;</span><span class="p">))</span>

            <span class="k">if</span> <span class="n">ranking</span> <span class="o">==</span> <span class="s1">&#39;both&#39;</span> <span class="ow">or</span> <span class="n">ranking</span> <span class="o">==</span> <span class="s1">&#39;unsupervised&#39;</span><span class="p">:</span>
                <span class="n">query3</span> <span class="o">=</span> <span class="s1">&#39;python &#39;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">pathlabeling</span><span class="o">.</span><span class="n">joinpath</span><span class="p">(</span><span class="s1">&#39;unsupervised_labels.py&#39;</span><span class="p">))</span> <span class="o">+</span> \
                         <span class="s1">&#39; &#39;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">num_unsup_labels</span><span class="p">)</span> <span class="o">+</span> <span class="s1">&#39; &#39;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">data</span><span class="p">)</span> <span class="o">+</span> <span class="s1">&#39; &#39;</span> <span class="o">+</span> \
                         <span class="nb">str</span><span class="p">(</span><span class="n">cand_gen_output</span><span class="p">)</span> <span class="o">+</span> <span class="s1">&#39; &#39;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">out_unsup</span><span class="p">)</span>
                <span class="k">try</span><span class="p">:</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;-- -- -- NETL Executing Unsupervised model&#39;</span><span class="p">)</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;-- -- -- NETL: Query is gonna be: &#39;</span> <span class="o">+</span> <span class="n">query3</span><span class="p">)</span>
                    <span class="n">check_output</span><span class="p">(</span><span class="n">args</span><span class="o">=</span><span class="n">query3</span><span class="p">,</span> <span class="n">shell</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
                <span class="k">except</span><span class="p">:</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s1">&#39;-- -- -- NETL failed to rank labels (unsup). Revise your command&#39;</span><span class="p">)</span>
                    <span class="k">return</span>

                <span class="n">unsup</span> <span class="o">=</span> <span class="p">[]</span>
                <span class="k">with</span> <span class="n">out_unsup</span><span class="o">.</span><span class="n">open</span><span class="p">(</span><span class="s1">&#39;r&#39;</span><span class="p">,</span> <span class="n">encoding</span><span class="o">=</span><span class="s1">&#39;utf-8&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
                    <span class="k">for</span> <span class="n">l</span> <span class="ow">in</span> <span class="n">f</span><span class="o">.</span><span class="n">readlines</span><span class="p">():</span>
                        <span class="n">unsup</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">l</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s1">&#39;</span><span class="se">\n</span><span class="s1">&#39;</span><span class="p">,</span> <span class="s1">&#39;&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;,&#39;</span><span class="p">))</span>

            <span class="c1"># Joining supervised and unsupervised labels, and getting unique labels.</span>
            <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_ntopics</span><span class="p">):</span>
                <span class="k">if</span> <span class="n">ranking</span> <span class="o">==</span> <span class="s1">&#39;both&#39;</span><span class="p">:</span>
                    <span class="n">final</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="nb">list</span><span class="p">(</span><span class="nb">set</span><span class="p">(</span><span class="n">sup</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">+</span> <span class="n">unsup</span><span class="p">[</span><span class="n">i</span><span class="p">])))</span>
                <span class="k">elif</span> <span class="n">ranking</span> <span class="o">==</span> <span class="s1">&#39;supervised&#39;</span><span class="p">:</span>
                    <span class="n">final</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="nb">list</span><span class="p">(</span><span class="nb">set</span><span class="p">(</span><span class="n">sup</span><span class="p">[</span><span class="n">i</span><span class="p">])))</span>
                <span class="k">elif</span> <span class="n">ranking</span> <span class="o">==</span> <span class="s1">&#39;unsupervised&#39;</span><span class="p">:</span>
                    <span class="n">final</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="nb">list</span><span class="p">(</span><span class="nb">set</span><span class="p">(</span><span class="n">unsup</span><span class="p">[</span><span class="n">i</span><span class="p">])))</span>
        <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s1">&#39;-- -- -- NETL: Something went wrong. Revise the previous log.&#39;</span><span class="p">)</span>

        <span class="c1"># Deleting temporal files at the end</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s1">&#39;-- -- -- NETL: Deleting temporal files&#39;</span><span class="p">)</span>
        <span class="p">[</span><span class="n">f</span><span class="o">.</span><span class="n">unlink</span><span class="p">()</span> <span class="k">for</span> <span class="n">f</span> <span class="ow">in</span> <span class="n">temp_files</span> <span class="k">if</span> <span class="n">f</span><span class="o">.</span><span class="n">is_file</span><span class="p">()]</span>

        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">final</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
            <span class="k">for</span> <span class="n">k</span><span class="p">,</span> <span class="n">wds</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">final</span><span class="p">):</span>
                <span class="n">proposed</span> <span class="o">=</span> <span class="s1">&#39;, &#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">wds</span><span class="p">)</span>
                <span class="nb">print</span><span class="p">(</span><span class="mi">10</span> <span class="o">*</span> <span class="s1">&#39;=&#39;</span><span class="p">)</span>
                <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Topic &#39;</span><span class="p">,</span> <span class="n">k</span><span class="p">)</span>
                <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Current description is&#39;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_descriptions</span><span class="p">[</span><span class="n">k</span><span class="p">])</span>
                <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Proposed description is&#39;</span><span class="p">,</span> <span class="n">wds</span><span class="p">)</span>
                <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;</span><span class="se">\n</span><span class="s1">&#39;</span><span class="p">)</span>
                <span class="k">if</span> <span class="n">request_confirmation</span><span class="p">(</span><span class="n">msg</span><span class="o">=</span><span class="s1">&#39;Keep newly proposed description?&#39;</span><span class="p">):</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">_descriptions</span><span class="p">[</span><span class="n">k</span><span class="p">]</span> <span class="o">=</span> <span class="n">proposed</span>
        <span class="k">return</span></div></div>


<div class="viewcode-block" id="MalletTrainer"><a class="viewcode-back" href="../topicmodeling.html#topicmodeling.MalletTrainer">[docs]</a><span class="k">class</span> <span class="nc">MalletTrainer</span><span class="p">(</span><span class="nb">object</span><span class="p">):</span>

<div class="viewcode-block" id="MalletTrainer.__init__"><a class="viewcode-back" href="../topicmodeling.html#topicmodeling.MalletTrainer.__init__">[docs]</a>    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">cf</span><span class="p">,</span> <span class="n">modelFolder</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Object initializer</span>
<span class="sd">        Initializes relevant variables from config file</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="n">logging</span><span class="o">.</span><span class="n">basicConfig</span><span class="p">(</span><span class="n">level</span><span class="o">=</span><span class="s1">&#39;INFO&#39;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">logger</span> <span class="o">=</span> <span class="n">logging</span><span class="o">.</span><span class="n">getLogger</span><span class="p">(</span><span class="s1">&#39;MalletTrainer&#39;</span><span class="p">)</span>

        <span class="c1"># Settings for text preprocessing</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_min_lemas</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">cf</span><span class="p">[</span><span class="s1">&#39;Preproc&#39;</span><span class="p">][</span><span class="s1">&#39;min_lemas&#39;</span><span class="p">])</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_no_below</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">cf</span><span class="p">[</span><span class="s1">&#39;Preproc&#39;</span><span class="p">][</span><span class="s1">&#39;no_below&#39;</span><span class="p">])</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_no_above</span> <span class="o">=</span> <span class="nb">float</span><span class="p">(</span><span class="n">cf</span><span class="p">[</span><span class="s1">&#39;Preproc&#39;</span><span class="p">][</span><span class="s1">&#39;no_above&#39;</span><span class="p">])</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_keep_n</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">cf</span><span class="p">[</span><span class="s1">&#39;Preproc&#39;</span><span class="p">][</span><span class="s1">&#39;keep_n&#39;</span><span class="p">])</span>
        <span class="c1"># Append stopwords and equivalences files only if they exist</span>
        <span class="c1"># Several stopword files can be used, but only one with equivalent terms</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_stw_file</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">f</span> <span class="ow">in</span> <span class="n">cf</span><span class="p">[</span><span class="s1">&#39;Preproc&#39;</span><span class="p">][</span><span class="s1">&#39;stw_file&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;,&#39;</span><span class="p">):</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">Path</span><span class="p">(</span><span class="n">f</span><span class="p">)</span><span class="o">.</span><span class="n">is_file</span><span class="p">():</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;-- -- Stopword file </span><span class="si">{</span><span class="n">f</span><span class="si">}</span><span class="s1"> does not exist -- Ignored&#39;</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_stw_file</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">Path</span><span class="p">(</span><span class="n">f</span><span class="p">))</span>
        <span class="n">f</span> <span class="o">=</span> <span class="n">cf</span><span class="p">[</span><span class="s1">&#39;Preproc&#39;</span><span class="p">][</span><span class="s1">&#39;eq_file&#39;</span><span class="p">]</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">Path</span><span class="p">(</span><span class="n">f</span><span class="p">)</span><span class="o">.</span><span class="n">is_file</span><span class="p">():</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;-- -- Equivalence file </span><span class="si">{</span><span class="n">f</span><span class="si">}</span><span class="s1"> does not exist -- Ignored&#39;</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_eq_file</span> <span class="o">=</span> <span class="n">Path</span><span class="p">(</span><span class="n">f</span><span class="p">)</span>
        <span class="c1"># Initialize string cleaner</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_stwEQ</span> <span class="o">=</span> <span class="n">stwEQcleaner</span><span class="p">(</span><span class="n">stw_files</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">_stw_file</span><span class="p">,</span> <span class="n">dict_eq_file</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">_eq_file</span><span class="p">,</span>
                                   <span class="n">logger</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="p">)</span>

        <span class="c1"># Settings for Mallet training</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_token_regexp_str</span> <span class="o">=</span> <span class="n">cf</span><span class="p">[</span><span class="s1">&#39;Training&#39;</span><span class="p">][</span><span class="s1">&#39;token_regexp&#39;</span><span class="p">]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_token_regexp</span> <span class="o">=</span> <span class="n">javare</span><span class="o">.</span><span class="n">compile</span><span class="p">(</span><span class="n">cf</span><span class="p">[</span><span class="s1">&#39;Training&#39;</span><span class="p">][</span><span class="s1">&#39;token_regexp&#39;</span><span class="p">])</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_mallet_path</span> <span class="o">=</span> <span class="n">Path</span><span class="p">(</span><span class="n">cf</span><span class="p">[</span><span class="s1">&#39;Training&#39;</span><span class="p">][</span><span class="s1">&#39;mallet_path&#39;</span><span class="p">])</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">_mallet_path</span><span class="o">.</span><span class="n">is_file</span><span class="p">():</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;-- -- Provided mallet path is not valid -- Stop&#39;</span><span class="p">)</span>
            <span class="n">sys</span><span class="o">.</span><span class="n">exit</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_numTopics</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">cf</span><span class="p">[</span><span class="s1">&#39;Training&#39;</span><span class="p">][</span><span class="s1">&#39;ntopics&#39;</span><span class="p">])</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_alpha</span> <span class="o">=</span> <span class="nb">float</span><span class="p">(</span><span class="n">cf</span><span class="p">[</span><span class="s1">&#39;Training&#39;</span><span class="p">][</span><span class="s1">&#39;alpha&#39;</span><span class="p">])</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_optimizeInterval</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">cf</span><span class="p">[</span><span class="s1">&#39;Training&#39;</span><span class="p">][</span><span class="s1">&#39;optimize_interval&#39;</span><span class="p">])</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_numThreads</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">cf</span><span class="p">[</span><span class="s1">&#39;Training&#39;</span><span class="p">][</span><span class="s1">&#39;num_threads&#39;</span><span class="p">])</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_numIterations</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">cf</span><span class="p">[</span><span class="s1">&#39;Training&#39;</span><span class="p">][</span><span class="s1">&#39;num_iterations&#39;</span><span class="p">])</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_docTopicsThreshold</span> <span class="o">=</span> <span class="nb">float</span><span class="p">(</span><span class="n">cf</span><span class="p">[</span><span class="s1">&#39;Training&#39;</span><span class="p">][</span><span class="s1">&#39;doc_topic_thr&#39;</span><span class="p">])</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_sparse_thr</span> <span class="o">=</span> <span class="nb">float</span><span class="p">(</span><span class="n">cf</span><span class="p">[</span><span class="s1">&#39;Training&#39;</span><span class="p">][</span><span class="s1">&#39;thetas_thr&#39;</span><span class="p">])</span>

        <span class="c1"># Output model folder and training files for the corpus</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_modelFolder</span> <span class="o">=</span> <span class="n">modelFolder</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">_modelFolder</span><span class="o">.</span><span class="n">is_dir</span><span class="p">():</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;-- -- Provided model folder is not valid -- Stop&#39;</span><span class="p">)</span>
            <span class="n">sys</span><span class="o">.</span><span class="n">exit</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_corpusFiles</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">f</span> <span class="ow">in</span> <span class="n">cf</span><span class="p">[</span><span class="s1">&#39;Training&#39;</span><span class="p">][</span><span class="s1">&#39;training_files&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;,&#39;</span><span class="p">):</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">Path</span><span class="p">(</span><span class="n">f</span><span class="p">)</span><span class="o">.</span><span class="n">is_file</span><span class="p">():</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">warn</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;-- -- Corpus file </span><span class="si">{</span><span class="n">f</span><span class="si">}</span><span class="s1"> does not exist -- Ignored&#39;</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_corpusFiles</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">Path</span><span class="p">(</span><span class="n">f</span><span class="p">))</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;-- -- Initialization of MalletTrainer variables completed&#39;</span><span class="p">)</span>

        <span class="k">return</span></div>

<div class="viewcode-block" id="MalletTrainer.fit"><a class="viewcode-back" href="../topicmodeling.html#topicmodeling.MalletTrainer.fit">[docs]</a>    <span class="k">def</span> <span class="nf">fit</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;To fit the model we need to preprocess training data, and then</span>
<span class="sd">        carry out the training itself&quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_preproc</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_train</span><span class="p">()</span>
        <span class="k">return</span></div>

    <span class="k">def</span> <span class="nf">_SaveThrFig</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">thetas32</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Creates a figure to illustrate the effect of thresholding</span>
<span class="sd">        The distribution of thetas is plotted, together with the value</span>
<span class="sd">        that the trainer is programmed to use for the thresholding</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">allvalues</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sort</span><span class="p">(</span><span class="n">thetas32</span><span class="o">.</span><span class="n">flatten</span><span class="p">())</span>
        <span class="n">step</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">round</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">allvalues</span><span class="p">)</span> <span class="o">/</span> <span class="mi">1000</span><span class="p">))</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">semilogx</span><span class="p">(</span><span class="n">allvalues</span><span class="p">[::</span><span class="n">step</span><span class="p">],</span> <span class="p">(</span><span class="mi">100</span> <span class="o">/</span> <span class="nb">len</span><span class="p">(</span><span class="n">allvalues</span><span class="p">))</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">allvalues</span><span class="p">))[::</span><span class="n">step</span><span class="p">])</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">semilogx</span><span class="p">([</span><span class="bp">self</span><span class="o">.</span><span class="n">_sparse_thr</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_sparse_thr</span><span class="p">],</span> <span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">100</span><span class="p">],</span> <span class="s1">&#39;r&#39;</span><span class="p">)</span>
        <span class="n">plot_file</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_modelFolder</span><span class="o">.</span><span class="n">joinpath</span><span class="p">(</span><span class="s1">&#39;thetas_dist.pdf&#39;</span><span class="p">)</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">savefig</span><span class="p">(</span><span class="n">plot_file</span><span class="p">)</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>

    <span class="k">def</span> <span class="nf">_preproc</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Preprocessing of files</span>
<span class="sd">        For the training we have access (in self._corpusFiles) to a number of lemmatized</span>
<span class="sd">        documents. This function:</span>
<span class="sd">            1) Carries out a first set of cleaning and homogeneization tasks</span>
<span class="sd">            2) Allow to reduce the size of the vocabulary (removing very rare or common terms)</span>
<span class="sd">            3) Import the training corpus into Mallet format</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="c1"># Identification of words that are too rare or common that need to be</span>
        <span class="c1"># removed from the dictionary.</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;-- -- Mallet Corpus Generation: Vocabulary generation&#39;</span><span class="p">)</span>
        <span class="n">dictionary</span> <span class="o">=</span> <span class="n">corpora</span><span class="o">.</span><span class="n">Dictionary</span><span class="p">()</span>

        <span class="c1"># We iterate over all CSV files</span>
        <span class="c1">#### Very important</span>
        <span class="c1">#### Corpus that can be used for Topic Modeling must contain</span>
        <span class="c1">#### two fields: [&quot;id&quot;, &quot;lemmas&quot;]</span>
        <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Processing files for vocabulary creation&#39;</span><span class="p">)</span>
        <span class="n">pbar</span> <span class="o">=</span> <span class="n">tqdm</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_corpusFiles</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">csvFile</span> <span class="ow">in</span> <span class="n">pbar</span><span class="p">:</span>
            <span class="n">df</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">read_csv</span><span class="p">(</span><span class="n">csvFile</span><span class="p">,</span> <span class="n">escapechar</span><span class="o">=</span><span class="s2">&quot;</span><span class="se">\\</span><span class="s2">&quot;</span><span class="p">,</span> <span class="n">on_bad_lines</span><span class="o">=</span><span class="s2">&quot;skip&quot;</span><span class="p">)</span>
            <span class="k">if</span> <span class="s2">&quot;id&quot;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">df</span><span class="o">.</span><span class="n">columns</span> <span class="ow">or</span> <span class="s2">&quot;lemmas&quot;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">df</span><span class="o">.</span><span class="n">columns</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s1">&#39;-- -- Traning corpus error: must contain &quot;id&quot; and &quot;lemmas&quot; - Exit&#39;</span><span class="p">)</span>
                <span class="n">sys</span><span class="o">.</span><span class="n">exit</span><span class="p">()</span>
            <span class="c1"># Keep only relevant fields</span>
            <span class="n">id_lemas</span> <span class="o">=</span> <span class="n">df</span><span class="p">[[</span><span class="s2">&quot;id&quot;</span><span class="p">,</span> <span class="s2">&quot;lemmas&quot;</span><span class="p">]]</span><span class="o">.</span><span class="n">values</span><span class="o">.</span><span class="n">tolist</span><span class="p">()</span>
            <span class="c1"># Apply regular expression to identify tokens</span>
            <span class="n">id_lemas</span> <span class="o">=</span> <span class="p">[[</span><span class="n">el</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="s1">&#39; &#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_token_regexp</span><span class="o">.</span><span class="n">findall</span><span class="p">(</span><span class="n">el</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s1">&#39;</span><span class="se">\n</span><span class="s1">&#39;</span><span class="p">,</span> <span class="s1">&#39; &#39;</span><span class="p">)</span><span class="o">.</span><span class="n">strip</span><span class="p">()))]</span>
                        <span class="k">for</span> <span class="n">el</span> <span class="ow">in</span> <span class="n">id_lemas</span><span class="p">]</span>
            <span class="c1"># Apply stopwords and equivalence files</span>
            <span class="n">id_lemas</span> <span class="o">=</span> <span class="p">[[</span><span class="n">el</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="bp">self</span><span class="o">.</span><span class="n">_stwEQ</span><span class="o">.</span><span class="n">cleanstr</span><span class="p">(</span><span class="n">el</span><span class="p">[</span><span class="mi">1</span><span class="p">])]</span> <span class="k">for</span> <span class="n">el</span> <span class="ow">in</span> <span class="n">id_lemas</span><span class="p">]</span>
            <span class="c1"># Apply gensim tokenizer</span>
            <span class="n">id_lemas</span> <span class="o">=</span> <span class="p">[[</span><span class="n">el</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="nb">list</span><span class="p">(</span><span class="n">tokenize</span><span class="p">(</span><span class="n">el</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">lowercase</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">deacc</span><span class="o">=</span><span class="kc">True</span><span class="p">))]</span> <span class="k">for</span> <span class="n">el</span> <span class="ow">in</span> <span class="n">id_lemas</span><span class="p">]</span>
            <span class="c1"># Retain only documents with minimum extension</span>
            <span class="n">id_lemas</span> <span class="o">=</span> <span class="p">[</span><span class="n">el</span> <span class="k">for</span> <span class="n">el</span> <span class="ow">in</span> <span class="n">id_lemas</span> <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">el</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span> <span class="o">&gt;=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_min_lemas</span><span class="p">]</span>
            <span class="c1"># Add to dictionary</span>
            <span class="n">all_lemas</span> <span class="o">=</span> <span class="p">[</span><span class="n">el</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="k">for</span> <span class="n">el</span> <span class="ow">in</span> <span class="n">id_lemas</span><span class="p">]</span>
            <span class="n">dictionary</span><span class="o">.</span><span class="n">add_documents</span><span class="p">(</span><span class="n">all_lemas</span><span class="p">)</span>

        <span class="c1"># Remove words that appear in less than no_below documents, or in more than</span>
        <span class="c1"># no_above, and keep at most keep_n most frequent terms, keep track of removed</span>
        <span class="c1"># words for debugging purposes</span>
        <span class="n">all_words</span> <span class="o">=</span> <span class="p">[</span><span class="n">dictionary</span><span class="p">[</span><span class="n">idx</span><span class="p">]</span> <span class="k">for</span> <span class="n">idx</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">dictionary</span><span class="p">))]</span>
        <span class="n">dictionary</span><span class="o">.</span><span class="n">filter_extremes</span><span class="p">(</span><span class="n">no_below</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">_no_below</span><span class="p">,</span> <span class="n">no_above</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">_no_above</span><span class="p">,</span> <span class="n">keep_n</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">_keep_n</span><span class="p">)</span>
        <span class="n">kept_words</span> <span class="o">=</span> <span class="nb">set</span><span class="p">([</span><span class="n">dictionary</span><span class="p">[</span><span class="n">idx</span><span class="p">]</span> <span class="k">for</span> <span class="n">idx</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">dictionary</span><span class="p">))])</span>
        <span class="n">rmv_words</span> <span class="o">=</span> <span class="p">[</span><span class="n">el</span> <span class="k">for</span> <span class="n">el</span> <span class="ow">in</span> <span class="n">all_words</span> <span class="k">if</span> <span class="n">el</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">kept_words</span><span class="p">]</span>
        <span class="c1"># Save extreme words that will be removed</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;-- -- Saving </span><span class="si">{</span><span class="nb">len</span><span class="p">(</span><span class="n">rmv_words</span><span class="p">)</span><span class="si">}</span><span class="s1"> extreme words to file&#39;</span><span class="p">)</span>
        <span class="n">rmv_file</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_modelFolder</span><span class="o">.</span><span class="n">joinpath</span><span class="p">(</span><span class="s1">&#39;commonrare_words.txt&#39;</span><span class="p">)</span>
        <span class="k">with</span> <span class="n">rmv_file</span><span class="o">.</span><span class="n">open</span><span class="p">(</span><span class="s1">&#39;w&#39;</span><span class="p">,</span> <span class="n">encoding</span><span class="o">=</span><span class="s1">&#39;utf-8&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">fout</span><span class="p">:</span>
            <span class="p">[</span><span class="n">fout</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">el</span> <span class="o">+</span> <span class="s1">&#39;</span><span class="se">\n</span><span class="s1">&#39;</span><span class="p">)</span> <span class="k">for</span> <span class="n">el</span> <span class="ow">in</span> <span class="nb">sorted</span><span class="p">(</span><span class="n">rmv_words</span><span class="p">)]</span>
        <span class="c1"># Save dictionary to file</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;-- -- Saving dictionary to file. Number of words: </span><span class="si">{</span><span class="nb">len</span><span class="p">(</span><span class="n">kept_words</span><span class="p">)</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span>
        <span class="n">vocab_txt</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_modelFolder</span><span class="o">.</span><span class="n">joinpath</span><span class="p">(</span><span class="s1">&#39;vocabulary.txt&#39;</span><span class="p">)</span>
        <span class="k">with</span> <span class="n">vocab_txt</span><span class="o">.</span><span class="n">open</span><span class="p">(</span><span class="s1">&#39;w&#39;</span><span class="p">,</span> <span class="n">encoding</span><span class="o">=</span><span class="s1">&#39;utf-8&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">fout</span><span class="p">:</span>
            <span class="p">[</span><span class="n">fout</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">el</span> <span class="o">+</span> <span class="s1">&#39;</span><span class="se">\n</span><span class="s1">&#39;</span><span class="p">)</span> <span class="k">for</span> <span class="n">el</span> <span class="ow">in</span> <span class="nb">sorted</span><span class="p">(</span><span class="n">kept_words</span><span class="p">)]</span>
        <span class="c1"># Save also in gensim text format</span>
        <span class="n">vocab_gensim</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_modelFolder</span><span class="o">.</span><span class="n">joinpath</span><span class="p">(</span><span class="s1">&#39;vocabulary.gensim&#39;</span><span class="p">)</span>
        <span class="n">dictionary</span><span class="o">.</span><span class="n">save_as_text</span><span class="p">(</span><span class="n">vocab_gensim</span><span class="p">)</span>

        <span class="c1">##################################################</span>
        <span class="c1"># Create corpus txt files</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;-- -- Mallet Corpus generation: TXT file&#39;</span><span class="p">)</span>

        <span class="n">corpus_file</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_modelFolder</span><span class="o">.</span><span class="n">joinpath</span><span class="p">(</span><span class="s1">&#39;training_data.txt&#39;</span><span class="p">)</span>

        <span class="n">fcorpus</span> <span class="o">=</span> <span class="n">corpus_file</span><span class="o">.</span><span class="n">open</span><span class="p">(</span><span class="s1">&#39;w&#39;</span><span class="p">,</span> <span class="n">encoding</span><span class="o">=</span><span class="s1">&#39;utf-8&#39;</span><span class="p">)</span>

        <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Processing files for training dataset creation&#39;</span><span class="p">)</span>
        <span class="n">pbar</span> <span class="o">=</span> <span class="n">tqdm</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_corpusFiles</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">csvFile</span> <span class="ow">in</span> <span class="n">pbar</span><span class="p">:</span>
            <span class="c1"># Document preprocessing is same as before, but now we apply an additional filter</span>
            <span class="c1"># and keep only words in the vocabulary</span>
            <span class="n">df</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">read_csv</span><span class="p">(</span><span class="n">csvFile</span><span class="p">,</span> <span class="n">escapechar</span><span class="o">=</span><span class="s2">&quot;</span><span class="se">\\</span><span class="s2">&quot;</span><span class="p">,</span> <span class="n">on_bad_lines</span><span class="o">=</span><span class="s2">&quot;skip&quot;</span><span class="p">)</span>
            <span class="n">id_lemas</span> <span class="o">=</span> <span class="n">df</span><span class="p">[[</span><span class="s2">&quot;id&quot;</span><span class="p">,</span> <span class="s2">&quot;lemmas&quot;</span><span class="p">]]</span><span class="o">.</span><span class="n">values</span><span class="o">.</span><span class="n">tolist</span><span class="p">()</span>
            <span class="n">id_lemas</span> <span class="o">=</span> <span class="p">[[</span><span class="n">el</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="s1">&#39; &#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_token_regexp</span><span class="o">.</span><span class="n">findall</span><span class="p">(</span><span class="n">el</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s1">&#39;</span><span class="se">\n</span><span class="s1">&#39;</span><span class="p">,</span> <span class="s1">&#39; &#39;</span><span class="p">)</span><span class="o">.</span><span class="n">strip</span><span class="p">()))]</span>
                        <span class="k">for</span> <span class="n">el</span> <span class="ow">in</span> <span class="n">id_lemas</span><span class="p">]</span>
            <span class="n">id_lemas</span> <span class="o">=</span> <span class="p">[[</span><span class="n">el</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="bp">self</span><span class="o">.</span><span class="n">_stwEQ</span><span class="o">.</span><span class="n">cleanstr</span><span class="p">(</span><span class="n">el</span><span class="p">[</span><span class="mi">1</span><span class="p">])]</span> <span class="k">for</span> <span class="n">el</span> <span class="ow">in</span> <span class="n">id_lemas</span><span class="p">]</span>
            <span class="n">id_lemas</span> <span class="o">=</span> <span class="p">[[</span><span class="n">el</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="nb">list</span><span class="p">(</span><span class="n">tokenize</span><span class="p">(</span><span class="n">el</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">lowercase</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">deacc</span><span class="o">=</span><span class="kc">True</span><span class="p">))]</span> <span class="k">for</span> <span class="n">el</span> <span class="ow">in</span> <span class="n">id_lemas</span><span class="p">]</span>
            <span class="n">id_lemas</span> <span class="o">=</span> <span class="p">[[</span><span class="n">el</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="p">[</span><span class="n">tk</span> <span class="k">for</span> <span class="n">tk</span> <span class="ow">in</span> <span class="n">el</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="k">if</span> <span class="n">tk</span> <span class="ow">in</span> <span class="n">kept_words</span><span class="p">]]</span> <span class="k">for</span> <span class="n">el</span> <span class="ow">in</span> <span class="n">id_lemas</span><span class="p">]</span>
            <span class="n">id_lemas</span> <span class="o">=</span> <span class="p">[</span><span class="n">el</span> <span class="k">for</span> <span class="n">el</span> <span class="ow">in</span> <span class="n">id_lemas</span> <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">el</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span> <span class="o">&gt;=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_min_lemas</span><span class="p">]</span>
            <span class="c1"># Write to corpus file</span>
            <span class="p">[</span><span class="n">fcorpus</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">el</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">+</span> <span class="s1">&#39; 0 &#39;</span> <span class="o">+</span> <span class="s1">&#39; &#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">el</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span> <span class="o">+</span> <span class="s1">&#39;</span><span class="se">\n</span><span class="s1">&#39;</span><span class="p">)</span> <span class="k">for</span> <span class="n">el</span> <span class="ow">in</span> <span class="n">id_lemas</span><span class="p">]</span>

        <span class="n">fcorpus</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>

        <span class="c1">##################################################</span>
        <span class="c1"># Importing Data to mallet</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;-- -- Mallet Corpus Generation: Mallet Data Import&#39;</span><span class="p">)</span>

        <span class="n">corpus_mallet</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_modelFolder</span><span class="o">.</span><span class="n">joinpath</span><span class="p">(</span><span class="s1">&#39;training_data.mallet&#39;</span><span class="p">)</span>

        <span class="n">cmd</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_mallet_path</span><span class="o">.</span><span class="n">as_posix</span><span class="p">()</span> <span class="o">+</span> \
              <span class="s1">&#39; import-file --preserve-case --keep-sequence &#39;</span> <span class="o">+</span> \
              <span class="s1">&#39;--remove-stopwords --token-regex &quot;&#39;</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">_token_regexp_str</span> <span class="o">+</span> \
              <span class="s1">&#39;&quot; --input </span><span class="si">%s</span><span class="s1"> --output </span><span class="si">%s</span><span class="s1">&#39;</span>
        <span class="n">cmd</span> <span class="o">=</span> <span class="n">cmd</span> <span class="o">%</span> <span class="p">(</span><span class="n">corpus_file</span><span class="p">,</span> <span class="n">corpus_mallet</span><span class="p">)</span>

        <span class="k">try</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;-- -- Running command </span><span class="si">{</span><span class="n">cmd</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span>
            <span class="n">check_output</span><span class="p">(</span><span class="n">args</span><span class="o">=</span><span class="n">cmd</span><span class="p">,</span> <span class="n">shell</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
        <span class="k">except</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s1">&#39;-- -- Mallet failed to import data. Revise command&#39;</span><span class="p">)</span>

        <span class="k">return</span>

    <span class="k">def</span> <span class="nf">_train</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Mallet training. It does the following:</span>
<span class="sd">            1) Trains a Mallet model using the settings provided by the user</span>
<span class="sd">            2) It sparsifies thetas matrix and save a figure to report the effect</span>
<span class="sd">            3) It saves model matrices: alphas, betas, thetas (sparse)</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">config_file</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_modelFolder</span><span class="o">.</span><span class="n">joinpath</span><span class="p">(</span><span class="s1">&#39;mallet.config&#39;</span><span class="p">)</span>
        <span class="n">corpus_mallet</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_modelFolder</span><span class="o">.</span><span class="n">joinpath</span><span class="p">(</span><span class="s1">&#39;training_data.mallet&#39;</span><span class="p">)</span>
        <span class="c1"># create folder for storing results for mallet training</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_modelFolder</span><span class="o">.</span><span class="n">joinpath</span><span class="p">(</span><span class="s1">&#39;mallet_output&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">mkdir</span><span class="p">()</span>

        <span class="k">with</span> <span class="n">config_file</span><span class="o">.</span><span class="n">open</span><span class="p">(</span><span class="s1">&#39;w&#39;</span><span class="p">,</span> <span class="n">encoding</span><span class="o">=</span><span class="s1">&#39;utf8&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">fout</span><span class="p">:</span>
            <span class="n">fout</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s1">&#39;input = &#39;</span> <span class="o">+</span> <span class="n">corpus_mallet</span><span class="o">.</span><span class="n">as_posix</span><span class="p">()</span> <span class="o">+</span> <span class="s1">&#39;</span><span class="se">\n</span><span class="s1">&#39;</span><span class="p">)</span>
            <span class="n">fout</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s1">&#39;num-topics = &#39;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_numTopics</span><span class="p">)</span> <span class="o">+</span> <span class="s1">&#39;</span><span class="se">\n</span><span class="s1">&#39;</span><span class="p">)</span>
            <span class="n">fout</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s1">&#39;alpha = &#39;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_alpha</span><span class="p">)</span> <span class="o">+</span> <span class="s1">&#39;</span><span class="se">\n</span><span class="s1">&#39;</span><span class="p">)</span>
            <span class="n">fout</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s1">&#39;optimize-interval = &#39;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_optimizeInterval</span><span class="p">)</span> <span class="o">+</span> <span class="s1">&#39;</span><span class="se">\n</span><span class="s1">&#39;</span><span class="p">)</span>
            <span class="n">fout</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s1">&#39;num-threads = &#39;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_numThreads</span><span class="p">)</span> <span class="o">+</span> <span class="s1">&#39;</span><span class="se">\n</span><span class="s1">&#39;</span><span class="p">)</span>
            <span class="n">fout</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s1">&#39;num-iterations = &#39;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_numIterations</span><span class="p">)</span> <span class="o">+</span> <span class="s1">&#39;</span><span class="se">\n</span><span class="s1">&#39;</span><span class="p">)</span>
            <span class="n">fout</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s1">&#39;doc-topics-threshold = &#39;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_docTopicsThreshold</span><span class="p">)</span> <span class="o">+</span> <span class="s1">&#39;</span><span class="se">\n</span><span class="s1">&#39;</span><span class="p">)</span>
            <span class="c1"># fout.write(&#39;output-state = &#39; + os.path.join(self._outputFolder, &#39;topic-state.gz&#39;) + &#39;\n&#39;)</span>
            <span class="n">fout</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s1">&#39;output-doc-topics = &#39;</span> <span class="o">+</span> \
                       <span class="bp">self</span><span class="o">.</span><span class="n">_modelFolder</span><span class="o">.</span><span class="n">joinpath</span><span class="p">(</span><span class="s1">&#39;mallet_output&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">joinpath</span><span class="p">(</span><span class="s1">&#39;doc-topics.txt&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">as_posix</span><span class="p">()</span> <span class="o">+</span> <span class="s1">&#39;</span><span class="se">\n</span><span class="s1">&#39;</span><span class="p">)</span>
            <span class="n">fout</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s1">&#39;word-topic-counts-file = &#39;</span> <span class="o">+</span> \
                       <span class="bp">self</span><span class="o">.</span><span class="n">_modelFolder</span><span class="o">.</span><span class="n">joinpath</span><span class="p">(</span><span class="s1">&#39;mallet_output&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">joinpath</span><span class="p">(</span><span class="s1">&#39;word-topic-counts.txt&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">as_posix</span><span class="p">()</span> <span class="o">+</span> <span class="s1">&#39;</span><span class="se">\n</span><span class="s1">&#39;</span><span class="p">)</span>
            <span class="n">fout</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s1">&#39;diagnostics-file = &#39;</span> <span class="o">+</span> \
                       <span class="bp">self</span><span class="o">.</span><span class="n">_modelFolder</span><span class="o">.</span><span class="n">joinpath</span><span class="p">(</span><span class="s1">&#39;mallet_output&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">joinpath</span><span class="p">(</span><span class="s1">&#39;diagnostics.xml &#39;</span><span class="p">)</span><span class="o">.</span><span class="n">as_posix</span><span class="p">()</span> <span class="o">+</span> <span class="s1">&#39;</span><span class="se">\n</span><span class="s1">&#39;</span><span class="p">)</span>
            <span class="n">fout</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s1">&#39;xml-topic-report = &#39;</span> <span class="o">+</span> \
                       <span class="bp">self</span><span class="o">.</span><span class="n">_modelFolder</span><span class="o">.</span><span class="n">joinpath</span><span class="p">(</span><span class="s1">&#39;mallet_output&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">joinpath</span><span class="p">(</span><span class="s1">&#39;topic-report.xml&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">as_posix</span><span class="p">()</span> <span class="o">+</span> <span class="s1">&#39;</span><span class="se">\n</span><span class="s1">&#39;</span><span class="p">)</span>
            <span class="n">fout</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s1">&#39;output-topic-keys = &#39;</span> <span class="o">+</span> \
                       <span class="bp">self</span><span class="o">.</span><span class="n">_modelFolder</span><span class="o">.</span><span class="n">joinpath</span><span class="p">(</span><span class="s1">&#39;mallet_output&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">joinpath</span><span class="p">(</span><span class="s1">&#39;topickeys.txt&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">as_posix</span><span class="p">()</span> <span class="o">+</span> <span class="s1">&#39;</span><span class="se">\n</span><span class="s1">&#39;</span><span class="p">)</span>
            <span class="n">fout</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s1">&#39;inferencer-filename = &#39;</span> <span class="o">+</span> \
                       <span class="bp">self</span><span class="o">.</span><span class="n">_modelFolder</span><span class="o">.</span><span class="n">joinpath</span><span class="p">(</span><span class="s1">&#39;mallet_output&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">joinpath</span><span class="p">(</span><span class="s1">&#39;inferencer.mallet&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">as_posix</span><span class="p">()</span> <span class="o">+</span> <span class="s1">&#39;</span><span class="se">\n</span><span class="s1">&#39;</span><span class="p">)</span>
            <span class="c1"># fout.write(&#39;output-model = &#39; + \</span>
            <span class="c1">#    self._outputFolder.joinpath(&#39;mallet_output&#39;).joinpath(&#39;modelo.bin&#39;).as_posix() + &#39;\n&#39;)</span>
            <span class="c1"># fout.write(&#39;topic-word-weights-file = &#39; + \</span>
            <span class="c1">#    self._outputFolder.joinpath(&#39;mallet_output&#39;).joinpath(&#39;topic-word-weights.txt&#39;).as_posix() + &#39;\n&#39;)</span>

        <span class="n">cmd</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_mallet_path</span><span class="p">)</span> <span class="o">+</span> <span class="s1">&#39; train-topics --config &#39;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">config_file</span><span class="p">)</span>

        <span class="k">try</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;-- -- Training mallet topic model. Command is </span><span class="si">{</span><span class="n">cmd</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span>
            <span class="n">check_output</span><span class="p">(</span><span class="n">args</span><span class="o">=</span><span class="n">cmd</span><span class="p">,</span> <span class="n">shell</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
        <span class="k">except</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s1">&#39;-- -- Model training failed. Revise command&#39;</span><span class="p">)</span>
            <span class="k">return</span>

        <span class="n">thetas_file</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_modelFolder</span><span class="o">.</span><span class="n">joinpath</span><span class="p">(</span><span class="s1">&#39;mallet_output&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">joinpath</span><span class="p">(</span><span class="s1">&#39;doc-topics.txt&#39;</span><span class="p">)</span>

        <span class="n">cols</span> <span class="o">=</span> <span class="p">[</span><span class="n">k</span> <span class="k">for</span> <span class="n">k</span> <span class="ow">in</span> <span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_numTopics</span> <span class="o">+</span> <span class="mi">2</span><span class="p">)]</span>

        <span class="c1"># Sparsification of thetas matrix</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s1">&#39;-- -- Sparsifying doc-topics matrix&#39;</span><span class="p">)</span>
        <span class="n">thetas32</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">loadtxt</span><span class="p">(</span><span class="n">thetas_file</span><span class="p">,</span> <span class="n">delimiter</span><span class="o">=</span><span class="s1">&#39;</span><span class="se">\t</span><span class="s1">&#39;</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">float32</span><span class="p">,</span> <span class="n">usecols</span><span class="o">=</span><span class="n">cols</span><span class="p">)</span>
        <span class="c1"># thetas32 = np.loadtxt(thetas_file, delimiter=&#39;\t&#39;, dtype=np.float32)[:,2:]</span>
        <span class="c1"># Create figure to check thresholding is correct</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_SaveThrFig</span><span class="p">(</span><span class="n">thetas32</span><span class="p">)</span>
        <span class="c1"># Set to zeros all thetas below threshold, and renormalize</span>
        <span class="n">thetas32</span><span class="p">[</span><span class="n">thetas32</span> <span class="o">&lt;</span> <span class="bp">self</span><span class="o">.</span><span class="n">_sparse_thr</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="n">thetas32</span> <span class="o">=</span> <span class="n">normalize</span><span class="p">(</span><span class="n">thetas32</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">norm</span><span class="o">=</span><span class="s1">&#39;l1&#39;</span><span class="p">)</span>
        <span class="n">thetas32</span> <span class="o">=</span> <span class="n">sparse</span><span class="o">.</span><span class="n">csr_matrix</span><span class="p">(</span><span class="n">thetas32</span><span class="p">,</span> <span class="n">copy</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>

        <span class="c1"># Recalculate topic weights to avoid errors due to sparsification</span>
        <span class="n">alphas</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">asarray</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">thetas32</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">))</span><span class="o">.</span><span class="n">ravel</span><span class="p">()</span>

        <span class="c1"># Create vocabulary files and calculate beta matrix</span>
        <span class="c1"># A vocabulary is available with words in alphabetic order,</span>
        <span class="c1"># but the new files will use the order used by mallet</span>
        <span class="n">wtcFile</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_modelFolder</span><span class="o">.</span><span class="n">joinpath</span><span class="p">(</span><span class="s1">&#39;mallet_output&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">joinpath</span><span class="p">(</span><span class="s1">&#39;word-topic-counts.txt&#39;</span><span class="p">)</span>
        <span class="n">vocab_size</span> <span class="o">=</span> <span class="n">file_lines</span><span class="p">(</span><span class="n">wtcFile</span><span class="p">)</span>
        <span class="n">betas</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="bp">self</span><span class="o">.</span><span class="n">_numTopics</span><span class="p">,</span> <span class="n">vocab_size</span><span class="p">))</span>
        <span class="n">vocab</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="n">term_freq</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="n">vocab_size</span><span class="p">,))</span>

        <span class="k">with</span> <span class="n">wtcFile</span><span class="o">.</span><span class="n">open</span><span class="p">(</span><span class="s1">&#39;r&#39;</span><span class="p">,</span> <span class="n">encoding</span><span class="o">=</span><span class="s1">&#39;utf8&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">fin</span><span class="p">:</span>
            <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">line</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">fin</span><span class="p">):</span>
                <span class="n">elements</span> <span class="o">=</span> <span class="n">line</span><span class="o">.</span><span class="n">split</span><span class="p">()</span>
                <span class="n">vocab</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">elements</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span>
                <span class="k">for</span> <span class="n">counts</span> <span class="ow">in</span> <span class="n">elements</span><span class="p">[</span><span class="mi">2</span><span class="p">:]:</span>
                    <span class="n">tpc</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">counts</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;:&#39;</span><span class="p">)[</span><span class="mi">0</span><span class="p">])</span>
                    <span class="n">cnt</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">counts</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;:&#39;</span><span class="p">)[</span><span class="mi">1</span><span class="p">])</span>
                    <span class="n">betas</span><span class="p">[</span><span class="n">tpc</span><span class="p">,</span> <span class="n">i</span><span class="p">]</span> <span class="o">+=</span> <span class="n">cnt</span>
                    <span class="n">term_freq</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">+=</span> <span class="n">cnt</span>
        <span class="n">betas</span> <span class="o">=</span> <span class="n">normalize</span><span class="p">(</span><span class="n">betas</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">norm</span><span class="o">=</span><span class="s1">&#39;l1&#39;</span><span class="p">)</span>
        <span class="c1"># save vocabulary and frequencies</span>
        <span class="k">with</span> <span class="bp">self</span><span class="o">.</span><span class="n">_modelFolder</span><span class="o">.</span><span class="n">joinpath</span><span class="p">(</span><span class="s1">&#39;vocab_freq_mallet.txt&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">open</span><span class="p">(</span><span class="s1">&#39;w&#39;</span><span class="p">,</span> <span class="n">encoding</span><span class="o">=</span><span class="s1">&#39;utf8&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">fout</span><span class="p">:</span>
            <span class="p">[</span><span class="n">fout</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">el</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">+</span> <span class="s1">&#39;</span><span class="se">\t</span><span class="s1">&#39;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="nb">int</span><span class="p">(</span><span class="n">el</span><span class="p">[</span><span class="mi">1</span><span class="p">]))</span> <span class="o">+</span> <span class="s1">&#39;</span><span class="se">\n</span><span class="s1">&#39;</span><span class="p">)</span> <span class="k">for</span> <span class="n">el</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="n">vocab</span><span class="p">,</span> <span class="n">term_freq</span><span class="p">)]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s1">&#39;-- -- Mallet training: Vocabulary file generated&#39;</span><span class="p">)</span>

        <span class="c1"># We end by saving the model for future use</span>
        <span class="n">modelVarsDir</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_modelFolder</span><span class="o">.</span><span class="n">joinpath</span><span class="p">(</span><span class="s1">&#39;model_vars&#39;</span><span class="p">)</span>
        <span class="n">modelVarsDir</span><span class="o">.</span><span class="n">mkdir</span><span class="p">()</span>
        <span class="n">np</span><span class="o">.</span><span class="n">save</span><span class="p">(</span><span class="n">modelVarsDir</span><span class="o">.</span><span class="n">joinpath</span><span class="p">(</span><span class="s1">&#39;alpha_orig.npy&#39;</span><span class="p">),</span> <span class="n">alphas</span><span class="p">)</span>
        <span class="n">np</span><span class="o">.</span><span class="n">save</span><span class="p">(</span><span class="n">modelVarsDir</span><span class="o">.</span><span class="n">joinpath</span><span class="p">(</span><span class="s1">&#39;beta_orig.npy&#39;</span><span class="p">),</span> <span class="n">betas</span><span class="p">)</span>
        <span class="n">np</span><span class="o">.</span><span class="n">savez</span><span class="p">(</span><span class="n">modelVarsDir</span><span class="o">.</span><span class="n">joinpath</span><span class="p">(</span><span class="s1">&#39;thetas_orig.npz&#39;</span><span class="p">),</span>
                 <span class="n">thetas_data</span><span class="o">=</span><span class="n">thetas32</span><span class="o">.</span><span class="n">data</span><span class="p">,</span> <span class="n">thetas_indices</span><span class="o">=</span><span class="n">thetas32</span><span class="o">.</span><span class="n">indices</span><span class="p">,</span>
                 <span class="n">thetas_indptr</span><span class="o">=</span><span class="n">thetas32</span><span class="o">.</span><span class="n">indptr</span><span class="p">,</span> <span class="n">thetas_shape</span><span class="o">=</span><span class="n">thetas32</span><span class="o">.</span><span class="n">shape</span><span class="p">)</span>

        <span class="c1"># Remove doc-topics file. It is no longer needed and takes a lot of space</span>
        <span class="n">thetas_file</span><span class="o">.</span><span class="n">unlink</span><span class="p">()</span>

        <span class="k">return</span></div>


<span class="c1">##############################################################################</span>
<span class="c1">#                                PRODLDA                                     #</span>
<span class="c1">##############################################################################</span>
<div class="viewcode-block" id="ProdLDATrainer"><a class="viewcode-back" href="../topicmodeling.html#topicmodeling.ProdLDATrainer">[docs]</a><span class="k">class</span> <span class="nc">ProdLDATrainer</span><span class="p">(</span><span class="nb">object</span><span class="p">):</span>

<div class="viewcode-block" id="ProdLDATrainer.__init__"><a class="viewcode-back" href="../topicmodeling.html#topicmodeling.ProdLDATrainer.__init__">[docs]</a>    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">cf</span><span class="p">,</span> <span class="n">modelFolder</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Object initializer</span>
<span class="sd">        Initializes relevant variables from config file</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="n">logging</span><span class="o">.</span><span class="n">basicConfig</span><span class="p">(</span><span class="n">level</span><span class="o">=</span><span class="s1">&#39;INFO&#39;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">logger</span> <span class="o">=</span> <span class="n">logging</span><span class="o">.</span><span class="n">getLogger</span><span class="p">(</span><span class="s1">&#39;ProdLDATrainer&#39;</span><span class="p">)</span>

        <span class="c1"># Settings for text preprocessing</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_min_lemas</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">cf</span><span class="p">[</span><span class="s1">&#39;Preproc&#39;</span><span class="p">][</span><span class="s1">&#39;min_lemas&#39;</span><span class="p">])</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_no_below</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">cf</span><span class="p">[</span><span class="s1">&#39;Preproc&#39;</span><span class="p">][</span><span class="s1">&#39;no_below&#39;</span><span class="p">])</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_no_above</span> <span class="o">=</span> <span class="nb">float</span><span class="p">(</span><span class="n">cf</span><span class="p">[</span><span class="s1">&#39;Preproc&#39;</span><span class="p">][</span><span class="s1">&#39;no_above&#39;</span><span class="p">])</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_keep_n</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">cf</span><span class="p">[</span><span class="s1">&#39;Preproc&#39;</span><span class="p">][</span><span class="s1">&#39;keep_n&#39;</span><span class="p">])</span>
        <span class="c1"># Append stopwords and equivalences files only if they exist</span>
        <span class="c1"># Several stopword files can be used, but only one with equivalent terms</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_stw_file</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">f</span> <span class="ow">in</span> <span class="n">cf</span><span class="p">[</span><span class="s1">&#39;Preproc&#39;</span><span class="p">][</span><span class="s1">&#39;stw_file&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;,&#39;</span><span class="p">):</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">Path</span><span class="p">(</span><span class="n">f</span><span class="p">)</span><span class="o">.</span><span class="n">is_file</span><span class="p">():</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;-- -- Stopword file </span><span class="si">{</span><span class="n">f</span><span class="si">}</span><span class="s1"> does not exist -- Ignored&#39;</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_stw_file</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">Path</span><span class="p">(</span><span class="n">f</span><span class="p">))</span>
        <span class="n">f</span> <span class="o">=</span> <span class="n">cf</span><span class="p">[</span><span class="s1">&#39;Preproc&#39;</span><span class="p">][</span><span class="s1">&#39;eq_file&#39;</span><span class="p">]</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">Path</span><span class="p">(</span><span class="n">f</span><span class="p">)</span><span class="o">.</span><span class="n">is_file</span><span class="p">():</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;-- -- Equivalence file </span><span class="si">{</span><span class="n">f</span><span class="si">}</span><span class="s1"> does not exist -- Ignored&#39;</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_eq_file</span> <span class="o">=</span> <span class="n">Path</span><span class="p">(</span><span class="n">f</span><span class="p">)</span>
        <span class="c1"># Initialize string cleaner</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_stwEQ</span> <span class="o">=</span> <span class="n">stwEQcleaner</span><span class="p">(</span><span class="n">stw_files</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">_stw_file</span><span class="p">,</span> <span class="n">dict_eq_file</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">_eq_file</span><span class="p">,</span>
                                   <span class="n">logger</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="p">)</span>

        <span class="c1"># Settings for ProdLDA training</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_token_regexp_str</span> <span class="o">=</span> <span class="n">cf</span><span class="p">[</span><span class="s1">&#39;Training&#39;</span><span class="p">][</span><span class="s1">&#39;token_regexp&#39;</span><span class="p">]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_token_regexp</span> <span class="o">=</span> <span class="n">javare</span><span class="o">.</span><span class="n">compile</span><span class="p">(</span><span class="n">cf</span><span class="p">[</span><span class="s1">&#39;Training&#39;</span><span class="p">][</span><span class="s1">&#39;token_regexp&#39;</span><span class="p">])</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">_n_components</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">cf</span><span class="p">[</span><span class="s1">&#39;Training&#39;</span><span class="p">][</span><span class="s1">&#39;n_components&#39;</span><span class="p">])</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_model_type</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="n">cf</span><span class="p">[</span><span class="s1">&#39;Training&#39;</span><span class="p">][</span><span class="s1">&#39;model_type&#39;</span><span class="p">])</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_hidden_sizes</span> <span class="o">=</span> \
            <span class="nb">tuple</span><span class="p">(</span><span class="nb">map</span><span class="p">(</span><span class="nb">int</span><span class="p">,</span> <span class="n">cf</span><span class="p">[</span><span class="s1">&#39;Training&#39;</span><span class="p">][</span><span class="s1">&#39;hidden_sizes&#39;</span><span class="p">][</span><span class="mi">1</span><span class="p">:</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;,&#39;</span><span class="p">)))</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_activation</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="n">cf</span><span class="p">[</span><span class="s1">&#39;Training&#39;</span><span class="p">][</span><span class="s1">&#39;activation&#39;</span><span class="p">])</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_dropout</span> <span class="o">=</span> <span class="nb">float</span><span class="p">(</span><span class="n">cf</span><span class="p">[</span><span class="s1">&#39;Training&#39;</span><span class="p">][</span><span class="s1">&#39;dropout&#39;</span><span class="p">])</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_learn_priors</span> <span class="o">=</span> \
            <span class="kc">True</span> <span class="k">if</span> <span class="n">cf</span><span class="p">[</span><span class="s1">&#39;Training&#39;</span><span class="p">][</span><span class="s1">&#39;learn_priors&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="s2">&quot;True&quot;</span> <span class="k">else</span> <span class="kc">False</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_lr</span> <span class="o">=</span> <span class="nb">float</span><span class="p">(</span><span class="n">cf</span><span class="p">[</span><span class="s1">&#39;Training&#39;</span><span class="p">][</span><span class="s1">&#39;lr&#39;</span><span class="p">])</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_momentum</span> <span class="o">=</span> <span class="nb">float</span><span class="p">(</span><span class="n">cf</span><span class="p">[</span><span class="s1">&#39;Training&#39;</span><span class="p">][</span><span class="s1">&#39;momentum&#39;</span><span class="p">])</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_solver</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="n">cf</span><span class="p">[</span><span class="s1">&#39;Training&#39;</span><span class="p">][</span><span class="s1">&#39;solver&#39;</span><span class="p">])</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_num_epochs</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">cf</span><span class="p">[</span><span class="s1">&#39;Training&#39;</span><span class="p">][</span><span class="s1">&#39;num_epochs&#39;</span><span class="p">])</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_reduce_on_plateau</span> <span class="o">=</span> \
            <span class="kc">True</span> <span class="k">if</span> <span class="n">cf</span><span class="p">[</span><span class="s1">&#39;Training&#39;</span><span class="p">][</span><span class="s1">&#39;reduce_on_plateau&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="s2">&quot;True&quot;</span> <span class="k">else</span> <span class="kc">False</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_num_data_loader_workers</span> <span class="o">=</span> <span class="n">mp</span><span class="o">.</span><span class="n">cpu_count</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_batch_size</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">cf</span><span class="p">[</span><span class="s1">&#39;Training&#39;</span><span class="p">][</span><span class="s1">&#39;batch_size&#39;</span><span class="p">])</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">_docTopicsThreshold</span> <span class="o">=</span> <span class="nb">float</span><span class="p">(</span><span class="n">cf</span><span class="p">[</span><span class="s1">&#39;Training&#39;</span><span class="p">][</span><span class="s1">&#39;doc_topic_thr&#39;</span><span class="p">])</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_sparse_thr</span> <span class="o">=</span> <span class="nb">float</span><span class="p">(</span><span class="n">cf</span><span class="p">[</span><span class="s1">&#39;Training&#39;</span><span class="p">][</span><span class="s1">&#39;thetas_thr&#39;</span><span class="p">])</span>

        <span class="c1"># Output model folder and training files for the corpus</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_modelFolder</span> <span class="o">=</span> <span class="n">modelFolder</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">_modelFolder</span><span class="o">.</span><span class="n">is_dir</span><span class="p">():</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;-- -- Provided model folder is not valid -- Stop&#39;</span><span class="p">)</span>
            <span class="n">sys</span><span class="o">.</span><span class="n">exit</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_corpusFiles</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">f</span> <span class="ow">in</span> <span class="n">cf</span><span class="p">[</span><span class="s1">&#39;Training&#39;</span><span class="p">][</span><span class="s1">&#39;training_files&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;,&#39;</span><span class="p">):</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">Path</span><span class="p">(</span><span class="n">f</span><span class="p">)</span><span class="o">.</span><span class="n">is_file</span><span class="p">():</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">warn</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;-- -- Corpus file </span><span class="si">{</span><span class="n">f</span><span class="si">}</span><span class="s1"> does not exist -- Ignored&#39;</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_corpusFiles</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">Path</span><span class="p">(</span><span class="n">f</span><span class="p">))</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;-- -- Initialization of ProdLDATrainer variables completed&#39;</span><span class="p">)</span>

        <span class="k">return</span></div>

    <span class="k">def</span> <span class="nf">_SaveThrFig</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">thetas32</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Creates a figure to illustrate the effect of thresholding</span>
<span class="sd">        The distribution of thetas is plotted, together with the value</span>
<span class="sd">        that the trainer is programmed to use for the thresholding</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">allvalues</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sort</span><span class="p">(</span><span class="n">thetas32</span><span class="o">.</span><span class="n">flatten</span><span class="p">())</span>
        <span class="n">step</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">round</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">allvalues</span><span class="p">)</span> <span class="o">/</span> <span class="mi">1000</span><span class="p">))</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">semilogx</span><span class="p">(</span><span class="n">allvalues</span><span class="p">[::</span><span class="n">step</span><span class="p">],</span> <span class="p">(</span><span class="mi">100</span> <span class="o">/</span> <span class="nb">len</span><span class="p">(</span><span class="n">allvalues</span><span class="p">))</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">allvalues</span><span class="p">))[::</span><span class="n">step</span><span class="p">])</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">semilogx</span><span class="p">([</span><span class="bp">self</span><span class="o">.</span><span class="n">_sparse_thr</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_sparse_thr</span><span class="p">],</span> <span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">100</span><span class="p">],</span> <span class="s1">&#39;r&#39;</span><span class="p">)</span>
        <span class="n">plot_file</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_modelFolder</span><span class="o">.</span><span class="n">joinpath</span><span class="p">(</span><span class="s1">&#39;thetas_dist.pdf&#39;</span><span class="p">)</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">savefig</span><span class="p">(</span><span class="n">plot_file</span><span class="p">)</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>

<div class="viewcode-block" id="ProdLDATrainer.fit"><a class="viewcode-back" href="../topicmodeling.html#topicmodeling.ProdLDATrainer.fit">[docs]</a>    <span class="k">def</span> <span class="nf">fit</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;To fit the model we need to preprocess training data, and then</span>
<span class="sd">        carry out the training itself&quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_preproc</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_train</span><span class="p">()</span>
        <span class="k">return</span></div>

    <span class="k">def</span> <span class="nf">_preproc</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Preprocessing of files</span>
<span class="sd">        For the training we have access (in self._corpusFiles) to a number of lemmatized</span>
<span class="sd">        documents. This function:</span>
<span class="sd">        1) Carries out a first set of cleaning and homogeneization tasks</span>
<span class="sd">        2) Allow to reduce the size of the vocabulary (removing very rare or common terms)</span>
<span class="sd">        3) Converts the training corpus into ProdLDA format</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="c1"># Identification of words that are too rare or common that need to be</span>
        <span class="c1"># removed from the dictionary.</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;-- -- ProdLDA Corpus Generation: Vocabulary generation&#39;</span><span class="p">)</span>
        <span class="n">dictionary</span> <span class="o">=</span> <span class="n">corpora</span><span class="o">.</span><span class="n">Dictionary</span><span class="p">()</span>

        <span class="c1"># We iterate over all CSV files</span>
        <span class="c1">#### Very important</span>
        <span class="c1">#### Corpus that can be used for Topic Modeling must contain</span>
        <span class="c1">#### two fields: [&quot;id&quot;, &quot;lemmas&quot;]</span>
        <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Processing files for vocabulary creation&#39;</span><span class="p">)</span>
        <span class="n">pbar</span> <span class="o">=</span> <span class="n">tqdm</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_corpusFiles</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">csvFile</span> <span class="ow">in</span> <span class="n">pbar</span><span class="p">:</span>
            <span class="n">df</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">read_csv</span><span class="p">(</span><span class="n">csvFile</span><span class="p">,</span> <span class="n">escapechar</span><span class="o">=</span><span class="s2">&quot;</span><span class="se">\\</span><span class="s2">&quot;</span><span class="p">,</span> <span class="n">on_bad_lines</span><span class="o">=</span><span class="s2">&quot;skip&quot;</span><span class="p">)</span>
            <span class="k">if</span> <span class="s2">&quot;id&quot;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">df</span><span class="o">.</span><span class="n">columns</span> <span class="ow">or</span> <span class="s2">&quot;lemmas&quot;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">df</span><span class="o">.</span><span class="n">columns</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s1">&#39;-- -- Traning corpus error: must contain &quot;id&quot; and &quot;lemmas&quot; - Exit&#39;</span><span class="p">)</span>
                <span class="n">sys</span><span class="o">.</span><span class="n">exit</span><span class="p">()</span>
            <span class="c1"># Keep only relevant fields</span>
            <span class="n">id_lemas</span> <span class="o">=</span> <span class="n">df</span><span class="p">[[</span><span class="s2">&quot;id&quot;</span><span class="p">,</span> <span class="s2">&quot;lemmas&quot;</span><span class="p">]]</span><span class="o">.</span><span class="n">values</span><span class="o">.</span><span class="n">tolist</span><span class="p">()</span>
            <span class="c1"># Apply regular expression to identify tokens</span>
            <span class="n">id_lemas</span> <span class="o">=</span> <span class="p">[[</span><span class="n">el</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="s1">&#39; &#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_token_regexp</span><span class="o">.</span><span class="n">findall</span><span class="p">(</span><span class="n">el</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s1">&#39;</span><span class="se">\n</span><span class="s1">&#39;</span><span class="p">,</span> <span class="s1">&#39; &#39;</span><span class="p">)</span><span class="o">.</span><span class="n">strip</span><span class="p">()))]</span> <span class="k">for</span> <span class="n">el</span> <span class="ow">in</span>
                        <span class="n">id_lemas</span><span class="p">]</span>
            <span class="c1"># Apply stopwords and equivalence files</span>
            <span class="n">id_lemas</span> <span class="o">=</span> <span class="p">[[</span><span class="n">el</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="bp">self</span><span class="o">.</span><span class="n">_stwEQ</span><span class="o">.</span><span class="n">cleanstr</span><span class="p">(</span><span class="n">el</span><span class="p">[</span><span class="mi">1</span><span class="p">])]</span> <span class="k">for</span> <span class="n">el</span> <span class="ow">in</span> <span class="n">id_lemas</span><span class="p">]</span>
            <span class="c1"># Apply gensim tokenizer</span>
            <span class="n">id_lemas</span> <span class="o">=</span> <span class="p">[[</span><span class="n">el</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="nb">list</span><span class="p">(</span><span class="n">tokenize</span><span class="p">(</span><span class="n">el</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">lowercase</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">deacc</span><span class="o">=</span><span class="kc">True</span><span class="p">))]</span> <span class="k">for</span> <span class="n">el</span> <span class="ow">in</span> <span class="n">id_lemas</span><span class="p">]</span>
            <span class="c1"># Retain only documents with minimum extension</span>
            <span class="n">id_lemas</span> <span class="o">=</span> <span class="p">[</span><span class="n">el</span> <span class="k">for</span> <span class="n">el</span> <span class="ow">in</span> <span class="n">id_lemas</span> <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">el</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span> <span class="o">&gt;=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_min_lemas</span><span class="p">]</span>
            <span class="c1"># Add to dictionary</span>
            <span class="n">all_lemas</span> <span class="o">=</span> <span class="p">[</span><span class="n">el</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="k">for</span> <span class="n">el</span> <span class="ow">in</span> <span class="n">id_lemas</span><span class="p">]</span>
            <span class="n">dictionary</span><span class="o">.</span><span class="n">add_documents</span><span class="p">(</span><span class="n">all_lemas</span><span class="p">)</span>

        <span class="c1"># Remove words that appear in less than no_below documents, or in more than</span>
        <span class="c1"># no_above, and keep at most keep_n most frequent terms, keep track of removed</span>
        <span class="c1"># words for debugging purposes</span>
        <span class="n">all_words</span> <span class="o">=</span> <span class="p">[</span><span class="n">dictionary</span><span class="p">[</span><span class="n">idx</span><span class="p">]</span> <span class="k">for</span> <span class="n">idx</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">dictionary</span><span class="p">))]</span>
        <span class="n">dictionary</span><span class="o">.</span><span class="n">filter_extremes</span><span class="p">(</span><span class="n">no_below</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">_no_below</span><span class="p">,</span> <span class="n">no_above</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">_no_above</span><span class="p">,</span> <span class="n">keep_n</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">_keep_n</span><span class="p">)</span>
        <span class="n">kept_words</span> <span class="o">=</span> <span class="nb">set</span><span class="p">([</span><span class="n">dictionary</span><span class="p">[</span><span class="n">idx</span><span class="p">]</span> <span class="k">for</span> <span class="n">idx</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">dictionary</span><span class="p">))])</span>
        <span class="n">rmv_words</span> <span class="o">=</span> <span class="p">[</span><span class="n">el</span> <span class="k">for</span> <span class="n">el</span> <span class="ow">in</span> <span class="n">all_words</span> <span class="k">if</span> <span class="n">el</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">kept_words</span><span class="p">]</span>
        <span class="c1"># Save extreme words that will be removed</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;-- -- Saving </span><span class="si">{</span><span class="nb">len</span><span class="p">(</span><span class="n">rmv_words</span><span class="p">)</span><span class="si">}</span><span class="s1"> extreme words to file&#39;</span><span class="p">)</span>
        <span class="n">rmv_file</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_modelFolder</span><span class="o">.</span><span class="n">joinpath</span><span class="p">(</span><span class="s1">&#39;commonrare_words.txt&#39;</span><span class="p">)</span>
        <span class="k">with</span> <span class="n">rmv_file</span><span class="o">.</span><span class="n">open</span><span class="p">(</span><span class="s1">&#39;w&#39;</span><span class="p">,</span> <span class="n">encoding</span><span class="o">=</span><span class="s1">&#39;utf-8&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">fout</span><span class="p">:</span>
            <span class="p">[</span><span class="n">fout</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">el</span> <span class="o">+</span> <span class="s1">&#39;</span><span class="se">\n</span><span class="s1">&#39;</span><span class="p">)</span> <span class="k">for</span> <span class="n">el</span> <span class="ow">in</span> <span class="nb">sorted</span><span class="p">(</span><span class="n">rmv_words</span><span class="p">)]</span>
        <span class="c1"># Save dictionary to file</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;-- -- Saving dictionary to file. Number of words: </span><span class="si">{</span><span class="nb">len</span><span class="p">(</span><span class="n">kept_words</span><span class="p">)</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span>
        <span class="n">vocab_txt</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_modelFolder</span><span class="o">.</span><span class="n">joinpath</span><span class="p">(</span><span class="s1">&#39;vocabulary.txt&#39;</span><span class="p">)</span>
        <span class="k">with</span> <span class="n">vocab_txt</span><span class="o">.</span><span class="n">open</span><span class="p">(</span><span class="s1">&#39;w&#39;</span><span class="p">,</span> <span class="n">encoding</span><span class="o">=</span><span class="s1">&#39;utf-8&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">fout</span><span class="p">:</span>
            <span class="p">[</span><span class="n">fout</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">el</span> <span class="o">+</span> <span class="s1">&#39;</span><span class="se">\n</span><span class="s1">&#39;</span><span class="p">)</span> <span class="k">for</span> <span class="n">el</span> <span class="ow">in</span> <span class="nb">sorted</span><span class="p">(</span><span class="n">kept_words</span><span class="p">)]</span>
        <span class="c1"># Save also in gensim text format</span>
        <span class="n">vocab_gensim</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_modelFolder</span><span class="o">.</span><span class="n">joinpath</span><span class="p">(</span><span class="s1">&#39;vocabulary.gensim&#39;</span><span class="p">)</span>
        <span class="n">dictionary</span><span class="o">.</span><span class="n">save_as_text</span><span class="p">(</span><span class="n">vocab_gensim</span><span class="p">)</span>

        <span class="c1">##################################################</span>
        <span class="c1"># Create corpus txt files</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;-- -- ProdLDA Corpus generation: TXT file&#39;</span><span class="p">)</span>

        <span class="n">corpus_file</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_modelFolder</span><span class="o">.</span><span class="n">joinpath</span><span class="p">(</span><span class="s1">&#39;training_data.txt&#39;</span><span class="p">)</span>

        <span class="n">fcorpus</span> <span class="o">=</span> <span class="n">corpus_file</span><span class="o">.</span><span class="n">open</span><span class="p">(</span><span class="s1">&#39;w&#39;</span><span class="p">,</span> <span class="n">encoding</span><span class="o">=</span><span class="s1">&#39;utf-8&#39;</span><span class="p">)</span>

        <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Processing files for training dataset creation&#39;</span><span class="p">)</span>
        <span class="n">pbar</span> <span class="o">=</span> <span class="n">tqdm</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_corpusFiles</span><span class="p">)</span>
        <span class="n">corpus</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">csvFile</span> <span class="ow">in</span> <span class="n">pbar</span><span class="p">:</span>
            <span class="c1"># Document preprocessing is same as before, but now we apply an additional filter</span>
            <span class="c1"># and keep only words in the vocabulary</span>
            <span class="n">df</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">read_csv</span><span class="p">(</span><span class="n">csvFile</span><span class="p">,</span> <span class="n">escapechar</span><span class="o">=</span><span class="s2">&quot;</span><span class="se">\\</span><span class="s2">&quot;</span><span class="p">,</span> <span class="n">on_bad_lines</span><span class="o">=</span><span class="s2">&quot;skip&quot;</span><span class="p">)</span>
            <span class="n">id_lemas</span> <span class="o">=</span> <span class="n">df</span><span class="p">[[</span><span class="s2">&quot;id&quot;</span><span class="p">,</span> <span class="s2">&quot;lemmas&quot;</span><span class="p">]]</span><span class="o">.</span><span class="n">values</span><span class="o">.</span><span class="n">tolist</span><span class="p">()</span>
            <span class="n">id_lemas</span> <span class="o">=</span> <span class="p">[[</span><span class="n">el</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="s1">&#39; &#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_token_regexp</span><span class="o">.</span><span class="n">findall</span><span class="p">(</span><span class="n">el</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s1">&#39;</span><span class="se">\n</span><span class="s1">&#39;</span><span class="p">,</span> <span class="s1">&#39; &#39;</span><span class="p">)</span><span class="o">.</span><span class="n">strip</span><span class="p">()))]</span>
                        <span class="k">for</span> <span class="n">el</span> <span class="ow">in</span> <span class="n">id_lemas</span><span class="p">]</span>
            <span class="n">id_lemas</span> <span class="o">=</span> <span class="p">[[</span><span class="n">el</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="bp">self</span><span class="o">.</span><span class="n">_stwEQ</span><span class="o">.</span><span class="n">cleanstr</span><span class="p">(</span><span class="n">el</span><span class="p">[</span><span class="mi">1</span><span class="p">])]</span> <span class="k">for</span> <span class="n">el</span> <span class="ow">in</span> <span class="n">id_lemas</span><span class="p">]</span>
            <span class="n">id_lemas</span> <span class="o">=</span> <span class="p">[[</span><span class="n">el</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="nb">list</span><span class="p">(</span><span class="n">tokenize</span><span class="p">(</span><span class="n">el</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">lowercase</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">deacc</span><span class="o">=</span><span class="kc">True</span><span class="p">))]</span> <span class="k">for</span> <span class="n">el</span> <span class="ow">in</span> <span class="n">id_lemas</span><span class="p">]</span>
            <span class="n">id_lemas</span> <span class="o">=</span> <span class="p">[[</span><span class="n">el</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="p">[</span><span class="n">tk</span> <span class="k">for</span> <span class="n">tk</span> <span class="ow">in</span> <span class="n">el</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="k">if</span> <span class="n">tk</span> <span class="ow">in</span> <span class="n">kept_words</span><span class="p">]]</span> <span class="k">for</span> <span class="n">el</span> <span class="ow">in</span> <span class="n">id_lemas</span><span class="p">]</span>
            <span class="n">id_lemas</span> <span class="o">=</span> <span class="p">[</span><span class="n">el</span> <span class="k">for</span> <span class="n">el</span> <span class="ow">in</span> <span class="n">id_lemas</span> <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">el</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span> <span class="o">&gt;=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_min_lemas</span><span class="p">]</span>
            <span class="c1"># Write to corpus file</span>
            <span class="p">[</span><span class="n">fcorpus</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">el</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">+</span> <span class="s1">&#39; 0 &#39;</span> <span class="o">+</span> <span class="s1">&#39; &#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">el</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span> <span class="o">+</span> <span class="s1">&#39;</span><span class="se">\n</span><span class="s1">&#39;</span><span class="p">)</span> <span class="k">for</span> <span class="n">el</span> <span class="ow">in</span> <span class="n">id_lemas</span><span class="p">]</span>
            <span class="n">corpus</span> <span class="o">=</span> <span class="n">corpus</span> <span class="o">+</span> <span class="p">[</span><span class="n">el</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="k">for</span> <span class="n">el</span> <span class="ow">in</span> <span class="n">id_lemas</span><span class="p">]</span>

        <span class="n">fcorpus</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>

        <span class="c1">##################################################</span>
        <span class="c1"># Generating the corpus in the input format required by ProdLDA</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;-- -- ProdLDA Corpus Generation: BOW Dataset object&#39;</span><span class="p">)</span>

        <span class="n">train_dataset</span><span class="p">,</span> <span class="n">val_dataset</span><span class="p">,</span> <span class="n">input_size</span><span class="p">,</span> <span class="n">id2token</span> <span class="o">=</span> <span class="n">prepare_dataset</span><span class="p">(</span><span class="n">corpus</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_bow_size</span> <span class="o">=</span> <span class="n">input_size</span>
        <span class="n">data</span> <span class="o">=</span> <span class="p">[</span><span class="n">train_dataset</span><span class="p">,</span> <span class="n">val_dataset</span><span class="p">,</span> <span class="n">input_size</span><span class="p">,</span> <span class="n">id2token</span><span class="p">]</span>

        <span class="n">bowdataset_file</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_modelFolder</span><span class="o">.</span><span class="n">joinpath</span><span class="p">(</span><span class="s1">&#39;bowdataset.pickle&#39;</span><span class="p">)</span>
        <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">bowdataset_file</span><span class="p">,</span> <span class="s1">&#39;wb&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
            <span class="n">pickle</span><span class="o">.</span><span class="n">dump</span><span class="p">(</span><span class="n">data</span><span class="p">,</span> <span class="n">f</span><span class="p">)</span>

        <span class="k">return</span>

    <span class="k">def</span> <span class="nf">_train</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;ProdLDA training. It does the following:</span>
<span class="sd">        1) Trains a ProdLDA model using the settings provided by the user</span>
<span class="sd">        2) It sparsifies thetas matrix and save a figure to report the effect</span>
<span class="sd">        3) It saves model matrices: alphas, betas, thetas (sparse)</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="c1"># Get BOWDataset</span>
        <span class="n">bowdataset_file</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_modelFolder</span><span class="o">.</span><span class="n">joinpath</span><span class="p">(</span><span class="s1">&#39;bowdataset.pickle&#39;</span><span class="p">)</span>
        <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">bowdataset_file</span><span class="p">,</span> <span class="s2">&quot;rb&quot;</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
            <span class="n">data</span> <span class="o">=</span> <span class="n">pickle</span><span class="o">.</span><span class="n">load</span><span class="p">(</span><span class="n">f</span><span class="p">)</span>

        <span class="c1"># Create folder for storing results for mallet training</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_modelFolder</span><span class="o">.</span><span class="n">joinpath</span><span class="p">(</span><span class="s1">&#39;prodlda_output&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">mkdir</span><span class="p">()</span>

        <span class="c1"># Train model</span>
        <span class="n">avitm</span> <span class="o">=</span> <span class="n">AVITM</span><span class="p">(</span><span class="n">logger</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="p">,</span> <span class="n">input_size</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">_bow_size</span><span class="p">,</span>
                      <span class="n">n_components</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">_n_components</span><span class="p">,</span>
                      <span class="n">model_type</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">_model_type</span><span class="p">,</span> <span class="n">hidden_sizes</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">_hidden_sizes</span><span class="p">,</span> <span class="n">activation</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">_activation</span><span class="p">,</span>
                      <span class="n">dropout</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">_dropout</span><span class="p">,</span>
                      <span class="n">learn_priors</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">_learn_priors</span><span class="p">,</span> <span class="n">batch_size</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">_batch_size</span><span class="p">,</span>
                      <span class="n">lr</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">_lr</span><span class="p">,</span> <span class="n">momentum</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">_momentum</span><span class="p">,</span> <span class="n">solver</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">_solver</span><span class="p">,</span> <span class="n">num_epochs</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">_num_epochs</span><span class="p">,</span>
                      <span class="n">reduce_on_plateau</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">_reduce_on_plateau</span><span class="p">)</span>

        <span class="n">avitm_fit</span> <span class="o">=</span> <span class="n">avitm</span><span class="o">.</span><span class="n">fit</span><span class="p">(</span><span class="n">data</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">data</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span>

        <span class="c1"># Get thetas</span>
        <span class="n">thetas</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">asarray</span><span class="p">(</span><span class="n">avitm</span><span class="o">.</span><span class="n">get_doc_topic_distribution</span><span class="p">(</span><span class="n">avitm</span><span class="o">.</span><span class="n">train_data</span><span class="p">))</span>  <span class="c1"># .T</span>

        <span class="c1"># Sparsification of thetas matrix</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s1">&#39;-- -- Sparsifying doc-topics matrix&#39;</span><span class="p">)</span>
        <span class="c1"># Create figure to check thresholding is correct</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_SaveThrFig</span><span class="p">(</span><span class="n">thetas</span><span class="p">)</span>
        <span class="c1"># Set to zeros all thetas below threshold, and renormalize</span>
        <span class="n">thetas</span><span class="p">[</span><span class="n">thetas</span> <span class="o">&lt;</span> <span class="bp">self</span><span class="o">.</span><span class="n">_sparse_thr</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="n">thetas</span> <span class="o">=</span> <span class="n">normalize</span><span class="p">(</span><span class="n">thetas</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">norm</span><span class="o">=</span><span class="s1">&#39;l1&#39;</span><span class="p">)</span>
        <span class="n">thetas</span> <span class="o">=</span> <span class="n">sparse</span><span class="o">.</span><span class="n">csr_matrix</span><span class="p">(</span><span class="n">thetas</span><span class="p">,</span> <span class="n">copy</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>

        <span class="c1"># Recalculate topic weights to avoid errors due to sparsification</span>
        <span class="n">alphas</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">asarray</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">thetas</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">))</span><span class="o">.</span><span class="n">ravel</span><span class="p">()</span>

        <span class="c1"># Calculate beta matrix</span>
        <span class="n">betas</span> <span class="o">=</span> <span class="n">avitm</span><span class="o">.</span><span class="n">get_topic_word_distribution</span><span class="p">()</span>

        <span class="c1"># Create vocabulary files and calculate beta matrix</span>
        <span class="n">betas</span> <span class="o">=</span> <span class="n">avitm</span><span class="o">.</span><span class="n">get_topic_word_distribution</span><span class="p">()</span>
        <span class="n">a</span> <span class="o">=</span> <span class="nb">sum</span><span class="p">(</span><span class="n">betas</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="p">:])</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;SUM BETAS&quot;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">a</span><span class="p">))</span>
        <span class="n">vocab_size</span> <span class="o">=</span> <span class="n">betas</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
        <span class="n">vocab</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="n">term_freq</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="n">vocab_size</span><span class="p">,))</span>

        <span class="n">id2token</span> <span class="o">=</span> <span class="n">data</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span>
        <span class="k">for</span> <span class="n">top</span> <span class="ow">in</span> <span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_n_components</span><span class="p">):</span>
            <span class="k">for</span> <span class="n">idx</span><span class="p">,</span> <span class="n">word</span> <span class="ow">in</span> <span class="n">id2token</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
                <span class="n">vocab</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">word</span><span class="p">)</span>
                <span class="n">cnt</span> <span class="o">=</span> <span class="n">betas</span><span class="p">[</span><span class="n">top</span><span class="p">][</span><span class="n">idx</span><span class="p">]</span>
                <span class="n">term_freq</span><span class="p">[</span><span class="n">idx</span><span class="p">]</span> <span class="o">+=</span> <span class="n">cnt</span>  <span class="c1"># Cuántas veces aparece una palabra</span>

        <span class="c1"># save vocabulary and frequencies</span>
        <span class="k">with</span> <span class="bp">self</span><span class="o">.</span><span class="n">_modelFolder</span><span class="o">.</span><span class="n">joinpath</span><span class="p">(</span><span class="s1">&#39;vocab_freq_prodlda.txt&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">open</span><span class="p">(</span><span class="s1">&#39;w&#39;</span><span class="p">,</span> <span class="n">encoding</span><span class="o">=</span><span class="s1">&#39;utf8&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">fout</span><span class="p">:</span>
            <span class="p">[</span><span class="n">fout</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">el</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">+</span> <span class="s1">&#39;</span><span class="se">\t</span><span class="s1">&#39;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="nb">int</span><span class="p">(</span><span class="n">el</span><span class="p">[</span><span class="mi">1</span><span class="p">]))</span> <span class="o">+</span> <span class="s1">&#39;</span><span class="se">\n</span><span class="s1">&#39;</span><span class="p">)</span> <span class="k">for</span> <span class="n">el</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="n">vocab</span><span class="p">,</span> <span class="n">term_freq</span><span class="p">)]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s1">&#39;-- -- ProdLDA training: Vocabulary file generated&#39;</span><span class="p">)</span>

        <span class="c1"># We end by saving the model for future use</span>
        <span class="n">modelVarsDir</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_modelFolder</span><span class="o">.</span><span class="n">joinpath</span><span class="p">(</span><span class="s1">&#39;model_vars&#39;</span><span class="p">)</span>
        <span class="n">modelVarsDir</span><span class="o">.</span><span class="n">mkdir</span><span class="p">()</span>
        <span class="n">np</span><span class="o">.</span><span class="n">save</span><span class="p">(</span><span class="n">modelVarsDir</span><span class="o">.</span><span class="n">joinpath</span><span class="p">(</span><span class="s1">&#39;alpha_orig.npy&#39;</span><span class="p">),</span> <span class="n">alphas</span><span class="p">)</span>
        <span class="n">np</span><span class="o">.</span><span class="n">save</span><span class="p">(</span><span class="n">modelVarsDir</span><span class="o">.</span><span class="n">joinpath</span><span class="p">(</span><span class="s1">&#39;beta_orig.npy&#39;</span><span class="p">),</span> <span class="n">betas</span><span class="p">)</span>
        <span class="n">np</span><span class="o">.</span><span class="n">savez</span><span class="p">(</span><span class="n">modelVarsDir</span><span class="o">.</span><span class="n">joinpath</span><span class="p">(</span><span class="s1">&#39;thetas_orig.npz&#39;</span><span class="p">),</span>
                 <span class="n">thetas_data</span><span class="o">=</span><span class="n">thetas</span><span class="o">.</span><span class="n">data</span><span class="p">,</span> <span class="n">thetas_indices</span><span class="o">=</span><span class="n">thetas</span><span class="o">.</span><span class="n">indices</span><span class="p">,</span>
                 <span class="n">thetas_indptr</span><span class="o">=</span><span class="n">thetas</span><span class="o">.</span><span class="n">indptr</span><span class="p">,</span> <span class="n">thetas_shape</span><span class="o">=</span><span class="n">thetas</span><span class="o">.</span><span class="n">shape</span><span class="p">)</span>

        <span class="k">return</span></div>


<span class="c1">##############################################################################</span>
<span class="c1">#                                  CTM                                       #</span>
<span class="c1">##############################################################################</span>
<div class="viewcode-block" id="CTMTrainer"><a class="viewcode-back" href="../topicmodeling.html#topicmodeling.CTMTrainer">[docs]</a><span class="k">class</span> <span class="nc">CTMTrainer</span><span class="p">(</span><span class="nb">object</span><span class="p">):</span>

<div class="viewcode-block" id="CTMTrainer.__init__"><a class="viewcode-back" href="../topicmodeling.html#topicmodeling.CTMTrainer.__init__">[docs]</a>    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">cf</span><span class="p">,</span> <span class="n">modelFolder</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Object initializer</span>
<span class="sd">        Initializes relevant variables from config file</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="n">logging</span><span class="o">.</span><span class="n">basicConfig</span><span class="p">(</span><span class="n">level</span><span class="o">=</span><span class="s1">&#39;INFO&#39;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">logger</span> <span class="o">=</span> <span class="n">logging</span><span class="o">.</span><span class="n">getLogger</span><span class="p">(</span><span class="s1">&#39;CTMTrainer&#39;</span><span class="p">)</span>

        <span class="c1"># Settings for text preprocessing</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_min_lemas</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">cf</span><span class="p">[</span><span class="s1">&#39;Preproc&#39;</span><span class="p">][</span><span class="s1">&#39;min_lemas&#39;</span><span class="p">])</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_no_below</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">cf</span><span class="p">[</span><span class="s1">&#39;Preproc&#39;</span><span class="p">][</span><span class="s1">&#39;no_below&#39;</span><span class="p">])</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_no_above</span> <span class="o">=</span> <span class="nb">float</span><span class="p">(</span><span class="n">cf</span><span class="p">[</span><span class="s1">&#39;Preproc&#39;</span><span class="p">][</span><span class="s1">&#39;no_above&#39;</span><span class="p">])</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_keep_n</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">cf</span><span class="p">[</span><span class="s1">&#39;Preproc&#39;</span><span class="p">][</span><span class="s1">&#39;keep_n&#39;</span><span class="p">])</span>
        <span class="c1"># Append stopwords and equivalences files only if they exist</span>
        <span class="c1"># Several stopword files can be used, but only one with equivalent terms</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_stw_file</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">f</span> <span class="ow">in</span> <span class="n">cf</span><span class="p">[</span><span class="s1">&#39;Preproc&#39;</span><span class="p">][</span><span class="s1">&#39;stw_file&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;,&#39;</span><span class="p">):</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">Path</span><span class="p">(</span><span class="n">f</span><span class="p">)</span><span class="o">.</span><span class="n">is_file</span><span class="p">():</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;-- -- Stopword file </span><span class="si">{</span><span class="n">f</span><span class="si">}</span><span class="s1"> does not exist -- Ignored&#39;</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_stw_file</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">Path</span><span class="p">(</span><span class="n">f</span><span class="p">))</span>
        <span class="n">f</span> <span class="o">=</span> <span class="n">cf</span><span class="p">[</span><span class="s1">&#39;Preproc&#39;</span><span class="p">][</span><span class="s1">&#39;eq_file&#39;</span><span class="p">]</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">Path</span><span class="p">(</span><span class="n">f</span><span class="p">)</span><span class="o">.</span><span class="n">is_file</span><span class="p">():</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;-- -- Equivalence file </span><span class="si">{</span><span class="n">f</span><span class="si">}</span><span class="s1"> does not exist -- Ignored&#39;</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_eq_file</span> <span class="o">=</span> <span class="n">Path</span><span class="p">(</span><span class="n">f</span><span class="p">)</span>
        <span class="c1"># Initialize string cleaner</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_stwEQ</span> <span class="o">=</span> <span class="n">stwEQcleaner</span><span class="p">(</span><span class="n">stw_files</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">_stw_file</span><span class="p">,</span> <span class="n">dict_eq_file</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">_eq_file</span><span class="p">,</span>
                                   <span class="n">logger</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="p">)</span>

        <span class="c1"># Settings for CTM training</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_token_regexp_str</span> <span class="o">=</span> <span class="n">cf</span><span class="p">[</span><span class="s1">&#39;Training&#39;</span><span class="p">][</span><span class="s1">&#39;token_regexp&#39;</span><span class="p">]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_token_regexp</span> <span class="o">=</span> <span class="n">javare</span><span class="o">.</span><span class="n">compile</span><span class="p">(</span><span class="n">cf</span><span class="p">[</span><span class="s1">&#39;Training&#39;</span><span class="p">][</span><span class="s1">&#39;token_regexp&#39;</span><span class="p">])</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">_ntopics</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">cf</span><span class="p">[</span><span class="s1">&#39;Training&#39;</span><span class="p">][</span><span class="s1">&#39;ntopics&#39;</span><span class="p">])</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_model_type</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="n">cf</span><span class="p">[</span><span class="s1">&#39;Training&#39;</span><span class="p">][</span><span class="s1">&#39;model_type&#39;</span><span class="p">])</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_ctm_model_type</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="n">cf</span><span class="p">[</span><span class="s1">&#39;Training&#39;</span><span class="p">][</span><span class="s1">&#39;ctm_model_type&#39;</span><span class="p">])</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_hidden_sizes</span> <span class="o">=</span> \
            <span class="nb">tuple</span><span class="p">(</span><span class="nb">map</span><span class="p">(</span><span class="nb">int</span><span class="p">,</span> <span class="n">cf</span><span class="p">[</span><span class="s1">&#39;Training&#39;</span><span class="p">][</span><span class="s1">&#39;hidden_sizes&#39;</span><span class="p">][</span><span class="mi">1</span><span class="p">:</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;,&#39;</span><span class="p">)))</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_activation</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="n">cf</span><span class="p">[</span><span class="s1">&#39;Training&#39;</span><span class="p">][</span><span class="s1">&#39;activation&#39;</span><span class="p">])</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_dropout</span> <span class="o">=</span> <span class="nb">float</span><span class="p">(</span><span class="n">cf</span><span class="p">[</span><span class="s1">&#39;Training&#39;</span><span class="p">][</span><span class="s1">&#39;dropout&#39;</span><span class="p">])</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_learn_priors</span> <span class="o">=</span> \
            <span class="kc">True</span> <span class="k">if</span> <span class="n">cf</span><span class="p">[</span><span class="s1">&#39;Training&#39;</span><span class="p">][</span><span class="s1">&#39;learn_priors&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="s2">&quot;True&quot;</span> <span class="k">else</span> <span class="kc">False</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_batch_size</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">cf</span><span class="p">[</span><span class="s1">&#39;Training&#39;</span><span class="p">][</span><span class="s1">&#39;batch_size&#39;</span><span class="p">])</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_lr</span> <span class="o">=</span> <span class="nb">float</span><span class="p">(</span><span class="n">cf</span><span class="p">[</span><span class="s1">&#39;Training&#39;</span><span class="p">][</span><span class="s1">&#39;lr&#39;</span><span class="p">])</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_momentum</span> <span class="o">=</span> <span class="nb">float</span><span class="p">(</span><span class="n">cf</span><span class="p">[</span><span class="s1">&#39;Training&#39;</span><span class="p">][</span><span class="s1">&#39;momentum&#39;</span><span class="p">])</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_solver</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="n">cf</span><span class="p">[</span><span class="s1">&#39;Training&#39;</span><span class="p">][</span><span class="s1">&#39;solver&#39;</span><span class="p">])</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_num_epochs</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">cf</span><span class="p">[</span><span class="s1">&#39;Training&#39;</span><span class="p">][</span><span class="s1">&#39;num_epochs&#39;</span><span class="p">])</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_num_samples</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">cf</span><span class="p">[</span><span class="s1">&#39;Training&#39;</span><span class="p">][</span><span class="s1">&#39;num_samples&#39;</span><span class="p">])</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_reduce_on_plateau</span> <span class="o">=</span> \
            <span class="kc">True</span> <span class="k">if</span> <span class="n">cf</span><span class="p">[</span><span class="s1">&#39;Training&#39;</span><span class="p">][</span><span class="s1">&#39;reduce_on_plateau&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="s2">&quot;True&quot;</span> <span class="k">else</span> <span class="kc">False</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_topic_prior_mean</span> <span class="o">=</span> <span class="nb">float</span><span class="p">(</span><span class="n">cf</span><span class="p">[</span><span class="s1">&#39;Training&#39;</span><span class="p">][</span><span class="s1">&#39;topic_prior_mean&#39;</span><span class="p">])</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_topic_prior_variance</span> <span class="o">=</span> <span class="kc">None</span> <span class="k">if</span> <span class="n">cf</span><span class="p">[</span><span class="s1">&#39;Training&#39;</span><span class="p">][</span><span class="s1">&#39;topic_prior_variance&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="s2">&quot;None&quot;</span> <span class="k">else</span> <span class="nb">float</span><span class="p">(</span>
            <span class="n">cf</span><span class="p">[</span><span class="s1">&#39;Training&#39;</span><span class="p">][</span><span class="s1">&#39;topic_prior_variance&#39;</span><span class="p">])</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_num_data_loader_workers</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">cf</span><span class="p">[</span><span class="s1">&#39;Training&#39;</span><span class="p">][</span><span class="s1">&#39;num_data_loader_workers&#39;</span><span class="p">])</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_docTopicsThreshold</span> <span class="o">=</span> <span class="nb">float</span><span class="p">(</span><span class="n">cf</span><span class="p">[</span><span class="s1">&#39;Training&#39;</span><span class="p">][</span><span class="s1">&#39;doc_topic_thr&#39;</span><span class="p">])</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_sparse_thr</span> <span class="o">=</span> <span class="nb">float</span><span class="p">(</span><span class="n">cf</span><span class="p">[</span><span class="s1">&#39;Training&#39;</span><span class="p">][</span><span class="s1">&#39;thetas_thr&#39;</span><span class="p">])</span>

        <span class="c1"># Output model folder and training files for the corpus</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_modelFolder</span> <span class="o">=</span> <span class="n">modelFolder</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">_modelFolder</span><span class="o">.</span><span class="n">is_dir</span><span class="p">():</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;-- -- Provided model folder is not valid -- Stop&#39;</span><span class="p">)</span>
            <span class="n">sys</span><span class="o">.</span><span class="n">exit</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_corpusFiles</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">f</span> <span class="ow">in</span> <span class="n">cf</span><span class="p">[</span><span class="s1">&#39;Training&#39;</span><span class="p">][</span><span class="s1">&#39;training_files&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;,&#39;</span><span class="p">):</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">Path</span><span class="p">(</span><span class="n">f</span><span class="p">)</span><span class="o">.</span><span class="n">is_file</span><span class="p">():</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">warn</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;-- -- Corpus file </span><span class="si">{</span><span class="n">f</span><span class="si">}</span><span class="s1"> does not exist -- Ignored&#39;</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_corpusFiles</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">Path</span><span class="p">(</span><span class="n">f</span><span class="p">))</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;-- -- Initialization of CTMTrainer variables completed&#39;</span><span class="p">)</span>

        <span class="k">return</span></div>

    <span class="k">def</span> <span class="nf">_SaveThrFig</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">thetas32</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Creates a figure to illustrate the effect of thresholding</span>
<span class="sd">        The distribution of thetas is plotted, together with the value</span>
<span class="sd">        that the trainer is programmed to use for the thresholding</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">allvalues</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sort</span><span class="p">(</span><span class="n">thetas32</span><span class="o">.</span><span class="n">flatten</span><span class="p">())</span>
        <span class="n">step</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">round</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">allvalues</span><span class="p">)</span> <span class="o">/</span> <span class="mi">1000</span><span class="p">))</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">semilogx</span><span class="p">(</span><span class="n">allvalues</span><span class="p">[::</span><span class="n">step</span><span class="p">],</span> <span class="p">(</span><span class="mi">100</span> <span class="o">/</span> <span class="nb">len</span><span class="p">(</span><span class="n">allvalues</span><span class="p">))</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">allvalues</span><span class="p">))[::</span><span class="n">step</span><span class="p">])</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">semilogx</span><span class="p">([</span><span class="bp">self</span><span class="o">.</span><span class="n">_sparse_thr</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_sparse_thr</span><span class="p">],</span> <span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">100</span><span class="p">],</span> <span class="s1">&#39;r&#39;</span><span class="p">)</span>
        <span class="n">plot_file</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_modelFolder</span><span class="o">.</span><span class="n">joinpath</span><span class="p">(</span><span class="s1">&#39;thetas_dist.pdf&#39;</span><span class="p">)</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">savefig</span><span class="p">(</span><span class="n">plot_file</span><span class="p">)</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>

<div class="viewcode-block" id="CTMTrainer.fit"><a class="viewcode-back" href="../topicmodeling.html#topicmodeling.CTMTrainer.fit">[docs]</a>    <span class="k">def</span> <span class="nf">fit</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;To fit the model we need to preprocess training data, and then</span>
<span class="sd">        carry out the training itself&quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_preproc</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_train</span><span class="p">()</span>
        <span class="k">return</span></div>

    <span class="k">def</span> <span class="nf">_preproc</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Preprocessing of files</span>
<span class="sd">        For the training we have access (in self._corpusFiles) to a number of lemmatized</span>
<span class="sd">        documents. This function:</span>
<span class="sd">        1) Carries out a first set of cleaning and homogeneization tasks</span>
<span class="sd">        2) Allow to reduce the size of the vocabulary (removing very rare or common terms)</span>
<span class="sd">        3) Converts the training corpus into CTM format</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="c1"># Identification of words that are too rare or common that need to be</span>
        <span class="c1"># removed from the dictionary.</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;-- -- CTM Corpus Generation: Vocabulary generation&#39;</span><span class="p">)</span>
        <span class="n">dictionary</span> <span class="o">=</span> <span class="n">corpora</span><span class="o">.</span><span class="n">Dictionary</span><span class="p">()</span>

        <span class="c1"># We iterate over all CSV files</span>
        <span class="c1">#### Very important</span>
        <span class="c1">#### Corpus that can be used for Topic Modeling must contain</span>
        <span class="c1">#### two fields: [&quot;id&quot;, &quot;lemmas&quot;]</span>
        <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Processing files for vocabulary creation&#39;</span><span class="p">)</span>
        <span class="n">pbar</span> <span class="o">=</span> <span class="n">tqdm</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_corpusFiles</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">csvFile</span> <span class="ow">in</span> <span class="n">pbar</span><span class="p">:</span>
            <span class="n">df</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">read_csv</span><span class="p">(</span><span class="n">csvFile</span><span class="p">,</span> <span class="n">escapechar</span><span class="o">=</span><span class="s2">&quot;</span><span class="se">\\</span><span class="s2">&quot;</span><span class="p">,</span> <span class="n">on_bad_lines</span><span class="o">=</span><span class="s2">&quot;skip&quot;</span><span class="p">)</span>
            <span class="k">if</span> <span class="s2">&quot;id&quot;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">df</span><span class="o">.</span><span class="n">columns</span> <span class="ow">or</span> <span class="s2">&quot;lemmas&quot;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">df</span><span class="o">.</span><span class="n">columns</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s1">&#39;-- -- Traning corpus error: must contain &quot;id&quot; and &quot;lemmas&quot; - Exit&#39;</span><span class="p">)</span>
                <span class="n">sys</span><span class="o">.</span><span class="n">exit</span><span class="p">()</span>
            <span class="c1"># Keep only relevant fields</span>
            <span class="n">id_lemas</span> <span class="o">=</span> <span class="n">df</span><span class="p">[[</span><span class="s2">&quot;id&quot;</span><span class="p">,</span> <span class="s2">&quot;lemmas&quot;</span><span class="p">]]</span><span class="o">.</span><span class="n">values</span><span class="o">.</span><span class="n">tolist</span><span class="p">()</span>
            <span class="c1"># Apply regular expression to identify tokens</span>
            <span class="n">id_lemas</span> <span class="o">=</span> <span class="p">[[</span><span class="n">el</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="s1">&#39; &#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_token_regexp</span><span class="o">.</span><span class="n">findall</span><span class="p">(</span><span class="n">el</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s1">&#39;</span><span class="se">\n</span><span class="s1">&#39;</span><span class="p">,</span> <span class="s1">&#39; &#39;</span><span class="p">)</span><span class="o">.</span><span class="n">strip</span><span class="p">()))]</span> <span class="k">for</span> <span class="n">el</span> <span class="ow">in</span>
                        <span class="n">id_lemas</span><span class="p">]</span>
            <span class="c1"># Apply stopwords and equivalence files</span>
            <span class="n">id_lemas</span> <span class="o">=</span> <span class="p">[[</span><span class="n">el</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="bp">self</span><span class="o">.</span><span class="n">_stwEQ</span><span class="o">.</span><span class="n">cleanstr</span><span class="p">(</span><span class="n">el</span><span class="p">[</span><span class="mi">1</span><span class="p">])]</span> <span class="k">for</span> <span class="n">el</span> <span class="ow">in</span> <span class="n">id_lemas</span><span class="p">]</span>
            <span class="c1"># Apply gensim tokenizer</span>
            <span class="n">id_lemas</span> <span class="o">=</span> <span class="p">[[</span><span class="n">el</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="nb">list</span><span class="p">(</span><span class="n">tokenize</span><span class="p">(</span><span class="n">el</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">lowercase</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">deacc</span><span class="o">=</span><span class="kc">True</span><span class="p">))]</span> <span class="k">for</span> <span class="n">el</span> <span class="ow">in</span> <span class="n">id_lemas</span><span class="p">]</span>
            <span class="c1"># Retain only documents with minimum extension</span>
            <span class="n">id_lemas</span> <span class="o">=</span> <span class="p">[</span><span class="n">el</span> <span class="k">for</span> <span class="n">el</span> <span class="ow">in</span> <span class="n">id_lemas</span> <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">el</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span> <span class="o">&gt;=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_min_lemas</span><span class="p">]</span>
            <span class="c1"># Add to dictionary</span>
            <span class="n">all_lemas</span> <span class="o">=</span> <span class="p">[</span><span class="n">el</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="k">for</span> <span class="n">el</span> <span class="ow">in</span> <span class="n">id_lemas</span><span class="p">]</span>
            <span class="n">dictionary</span><span class="o">.</span><span class="n">add_documents</span><span class="p">(</span><span class="n">all_lemas</span><span class="p">)</span>

        <span class="c1"># Remove words that appear in less than no_below documents, or in more than</span>
        <span class="c1"># no_above, and keep at most keep_n most frequent terms, keep track of removed</span>
        <span class="c1"># words for debugging purposes</span>
        <span class="n">all_words</span> <span class="o">=</span> <span class="p">[</span><span class="n">dictionary</span><span class="p">[</span><span class="n">idx</span><span class="p">]</span> <span class="k">for</span> <span class="n">idx</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">dictionary</span><span class="p">))]</span>
        <span class="n">dictionary</span><span class="o">.</span><span class="n">filter_extremes</span><span class="p">(</span><span class="n">no_below</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">_no_below</span><span class="p">,</span> <span class="n">no_above</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">_no_above</span><span class="p">,</span> <span class="n">keep_n</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">_keep_n</span><span class="p">)</span>
        <span class="n">kept_words</span> <span class="o">=</span> <span class="nb">set</span><span class="p">([</span><span class="n">dictionary</span><span class="p">[</span><span class="n">idx</span><span class="p">]</span> <span class="k">for</span> <span class="n">idx</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">dictionary</span><span class="p">))])</span>
        <span class="n">rmv_words</span> <span class="o">=</span> <span class="p">[</span><span class="n">el</span> <span class="k">for</span> <span class="n">el</span> <span class="ow">in</span> <span class="n">all_words</span> <span class="k">if</span> <span class="n">el</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">kept_words</span><span class="p">]</span>
        <span class="c1"># Save extreme words that will be removed</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;-- -- Saving </span><span class="si">{</span><span class="nb">len</span><span class="p">(</span><span class="n">rmv_words</span><span class="p">)</span><span class="si">}</span><span class="s1"> extreme words to file&#39;</span><span class="p">)</span>
        <span class="n">rmv_file</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_modelFolder</span><span class="o">.</span><span class="n">joinpath</span><span class="p">(</span><span class="s1">&#39;commonrare_words.txt&#39;</span><span class="p">)</span>
        <span class="k">with</span> <span class="n">rmv_file</span><span class="o">.</span><span class="n">open</span><span class="p">(</span><span class="s1">&#39;w&#39;</span><span class="p">,</span> <span class="n">encoding</span><span class="o">=</span><span class="s1">&#39;utf-8&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">fout</span><span class="p">:</span>
            <span class="p">[</span><span class="n">fout</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">el</span> <span class="o">+</span> <span class="s1">&#39;</span><span class="se">\n</span><span class="s1">&#39;</span><span class="p">)</span> <span class="k">for</span> <span class="n">el</span> <span class="ow">in</span> <span class="nb">sorted</span><span class="p">(</span><span class="n">rmv_words</span><span class="p">)]</span>
        <span class="c1"># Save dictionary to file</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;-- -- Saving dictionary to file. Number of words: </span><span class="si">{</span><span class="nb">len</span><span class="p">(</span><span class="n">kept_words</span><span class="p">)</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span>
        <span class="n">vocab_txt</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_modelFolder</span><span class="o">.</span><span class="n">joinpath</span><span class="p">(</span><span class="s1">&#39;vocabulary.txt&#39;</span><span class="p">)</span>
        <span class="k">with</span> <span class="n">vocab_txt</span><span class="o">.</span><span class="n">open</span><span class="p">(</span><span class="s1">&#39;w&#39;</span><span class="p">,</span> <span class="n">encoding</span><span class="o">=</span><span class="s1">&#39;utf-8&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">fout</span><span class="p">:</span>
            <span class="p">[</span><span class="n">fout</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">el</span> <span class="o">+</span> <span class="s1">&#39;</span><span class="se">\n</span><span class="s1">&#39;</span><span class="p">)</span> <span class="k">for</span> <span class="n">el</span> <span class="ow">in</span> <span class="nb">sorted</span><span class="p">(</span><span class="n">kept_words</span><span class="p">)]</span>
        <span class="c1"># Save also in gensim text format</span>
        <span class="n">vocab_gensim</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_modelFolder</span><span class="o">.</span><span class="n">joinpath</span><span class="p">(</span><span class="s1">&#39;vocabulary.gensim&#39;</span><span class="p">)</span>
        <span class="n">dictionary</span><span class="o">.</span><span class="n">save_as_text</span><span class="p">(</span><span class="n">vocab_gensim</span><span class="p">)</span>

        <span class="c1">##################################################</span>
        <span class="c1"># Create corpus txt files</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;-- -- CTM Corpus generation: TXT file&#39;</span><span class="p">)</span>

        <span class="n">corpus_file</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_modelFolder</span><span class="o">.</span><span class="n">joinpath</span><span class="p">(</span><span class="s1">&#39;training_data.txt&#39;</span><span class="p">)</span>

        <span class="n">fcorpus</span> <span class="o">=</span> <span class="n">corpus_file</span><span class="o">.</span><span class="n">open</span><span class="p">(</span><span class="s1">&#39;w&#39;</span><span class="p">,</span> <span class="n">encoding</span><span class="o">=</span><span class="s1">&#39;utf-8&#39;</span><span class="p">)</span>

        <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Processing files for training dataset creation&#39;</span><span class="p">)</span>
        <span class="n">pbar</span> <span class="o">=</span> <span class="n">tqdm</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_corpusFiles</span><span class="p">)</span>
        <span class="n">corpus</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="n">unpreprocessed_corpus</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">csvFile</span> <span class="ow">in</span> <span class="n">pbar</span><span class="p">:</span>
            <span class="c1"># Document preprocessing is same as before, but now we apply an additional filter</span>
            <span class="c1"># and keep only words in the vocabulary</span>
            <span class="n">df</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">read_csv</span><span class="p">(</span><span class="n">csvFile</span><span class="p">,</span> <span class="n">escapechar</span><span class="o">=</span><span class="s2">&quot;</span><span class="se">\\</span><span class="s2">&quot;</span><span class="p">,</span> <span class="n">on_bad_lines</span><span class="o">=</span><span class="s2">&quot;skip&quot;</span><span class="p">)</span>
            <span class="n">id_lemas</span> <span class="o">=</span> <span class="n">df</span><span class="p">[[</span><span class="s2">&quot;id&quot;</span><span class="p">,</span> <span class="s2">&quot;lemmas&quot;</span><span class="p">]]</span><span class="o">.</span><span class="n">values</span><span class="o">.</span><span class="n">tolist</span><span class="p">()</span>
            <span class="n">unpreprocessed_corpus</span> <span class="o">=</span> <span class="n">unpreprocessed_corpus</span> <span class="o">+</span> <span class="p">[</span><span class="n">el</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="k">for</span> <span class="n">el</span> <span class="ow">in</span> <span class="n">id_lemas</span><span class="p">]</span>
            <span class="n">id_lemas</span> <span class="o">=</span> <span class="p">[[</span><span class="n">el</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="s1">&#39; &#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_token_regexp</span><span class="o">.</span><span class="n">findall</span><span class="p">(</span><span class="n">el</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s1">&#39;</span><span class="se">\n</span><span class="s1">&#39;</span><span class="p">,</span> <span class="s1">&#39; &#39;</span><span class="p">)</span><span class="o">.</span><span class="n">strip</span><span class="p">()))]</span>
                        <span class="k">for</span> <span class="n">el</span> <span class="ow">in</span> <span class="n">id_lemas</span><span class="p">]</span>
            <span class="n">id_lemas</span> <span class="o">=</span> <span class="p">[[</span><span class="n">el</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="bp">self</span><span class="o">.</span><span class="n">_stwEQ</span><span class="o">.</span><span class="n">cleanstr</span><span class="p">(</span><span class="n">el</span><span class="p">[</span><span class="mi">1</span><span class="p">])]</span> <span class="k">for</span> <span class="n">el</span> <span class="ow">in</span> <span class="n">id_lemas</span><span class="p">]</span>
            <span class="n">id_lemas</span> <span class="o">=</span> <span class="p">[[</span><span class="n">el</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="nb">list</span><span class="p">(</span><span class="n">tokenize</span><span class="p">(</span><span class="n">el</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">lowercase</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">deacc</span><span class="o">=</span><span class="kc">True</span><span class="p">))]</span> <span class="k">for</span> <span class="n">el</span> <span class="ow">in</span> <span class="n">id_lemas</span><span class="p">]</span>
            <span class="n">id_lemas</span> <span class="o">=</span> <span class="p">[[</span><span class="n">el</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="p">[</span><span class="n">tk</span> <span class="k">for</span> <span class="n">tk</span> <span class="ow">in</span> <span class="n">el</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="k">if</span> <span class="n">tk</span> <span class="ow">in</span> <span class="n">kept_words</span><span class="p">]]</span> <span class="k">for</span> <span class="n">el</span> <span class="ow">in</span> <span class="n">id_lemas</span><span class="p">]</span>
            <span class="n">id_lemas</span> <span class="o">=</span> <span class="p">[</span><span class="n">el</span> <span class="k">for</span> <span class="n">el</span> <span class="ow">in</span> <span class="n">id_lemas</span> <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">el</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span> <span class="o">&gt;=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_min_lemas</span><span class="p">]</span>
            <span class="c1"># Write to corpus file</span>
            <span class="p">[</span><span class="n">fcorpus</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">el</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">+</span> <span class="s1">&#39; 0 &#39;</span> <span class="o">+</span> <span class="s1">&#39; &#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">el</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span> <span class="o">+</span> <span class="s1">&#39;</span><span class="se">\n</span><span class="s1">&#39;</span><span class="p">)</span> <span class="k">for</span> <span class="n">el</span> <span class="ow">in</span> <span class="n">id_lemas</span><span class="p">]</span>
            <span class="n">corpus</span> <span class="o">=</span> <span class="n">corpus</span> <span class="o">+</span> <span class="p">[</span><span class="n">el</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="k">for</span> <span class="n">el</span> <span class="ow">in</span> <span class="n">id_lemas</span><span class="p">]</span>

        <span class="n">fcorpus</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>

        <span class="c1">##################################################</span>
        <span class="c1"># Generating the corpus in the input format required by CTM</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;-- -- CTM Corpus Generation: CTM Dataset object&#39;</span><span class="p">)</span>

        <span class="n">train_dataset</span><span class="p">,</span> <span class="n">val_dataset</span><span class="p">,</span> <span class="n">input_size</span><span class="p">,</span> <span class="n">id2token</span> <span class="o">=</span> \
            <span class="n">prepare_ctm_dataset</span><span class="p">(</span><span class="n">corpus</span><span class="o">=</span><span class="n">corpus</span><span class="p">,</span> <span class="n">unpreprocessed_corpus</span><span class="o">=</span><span class="n">unpreprocessed_corpus</span><span class="p">,</span>
                                <span class="n">sbert_model_to_load</span><span class="o">=</span><span class="s1">&#39;paraphrase-distilroberta-base-v1&#39;</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">_input_size</span> <span class="o">=</span> <span class="n">input_size</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_train_dataset</span> <span class="o">=</span> <span class="n">train_dataset</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_val_dataset</span> <span class="o">=</span> <span class="n">val_dataset</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_id2token</span> <span class="o">=</span> <span class="n">id2token</span>

        <span class="n">data</span> <span class="o">=</span> <span class="p">[</span><span class="n">train_dataset</span><span class="p">,</span> <span class="n">val_dataset</span><span class="p">,</span> <span class="n">input_size</span><span class="p">,</span> <span class="n">id2token</span><span class="p">]</span>

        <span class="n">ctm_dataset_file</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_modelFolder</span><span class="o">.</span><span class="n">joinpath</span><span class="p">(</span><span class="s1">&#39;ctm_dataset.pickle&#39;</span><span class="p">)</span>
        <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">ctm_dataset_file</span><span class="p">,</span> <span class="s1">&#39;wb&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
            <span class="n">pickle</span><span class="o">.</span><span class="n">dump</span><span class="p">(</span><span class="n">data</span><span class="p">,</span> <span class="n">f</span><span class="p">)</span>

        <span class="k">return</span>

    <span class="k">def</span> <span class="nf">_train</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;ProdLDA training. It does the following:</span>
<span class="sd">        1) Trains a ProdLDA model using the settings provided by the user</span>
<span class="sd">        2) It sparsifies thetas matrix and save a figure to report the effect</span>
<span class="sd">        3) It saves model matrices: alphas, betas, thetas (sparse)</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="c1"># Get BOWDataset</span>
        <span class="n">ctm_dataset_file</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_modelFolder</span><span class="o">.</span><span class="n">joinpath</span><span class="p">(</span><span class="s1">&#39;ctm_dataset.pickle&#39;</span><span class="p">)</span>
        <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">ctm_dataset_file</span><span class="p">,</span> <span class="s2">&quot;rb&quot;</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
            <span class="n">data</span> <span class="o">=</span> <span class="n">pickle</span><span class="o">.</span><span class="n">load</span><span class="p">(</span><span class="n">f</span><span class="p">)</span>

        <span class="c1"># Create folder for storing results for mallet training</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_modelFolder</span><span class="o">.</span><span class="n">joinpath</span><span class="p">(</span><span class="s1">&#39;ctm_output&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">mkdir</span><span class="p">()</span>

        <span class="c1"># Train model</span>
        <span class="c1"># module = __import__(module_name)</span>
        <span class="c1"># class_ = getattr(module, self._ctm_model_type)</span>

        <span class="n">ctm</span> <span class="o">=</span> <span class="n">CombinedTM</span><span class="p">(</span><span class="n">logger</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="p">,</span> <span class="n">input_size</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">_input_size</span><span class="p">,</span>
                         <span class="n">contextual_size</span><span class="o">=</span><span class="mi">768</span><span class="p">,</span>
                         <span class="n">n_components</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">_ntopics</span><span class="p">,</span> <span class="n">model_type</span><span class="o">=</span><span class="s1">&#39;prodLDA&#39;</span><span class="p">,</span>
                         <span class="n">hidden_sizes</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">_hidden_sizes</span><span class="p">,</span> <span class="n">activation</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">_activation</span><span class="p">,</span>
                         <span class="n">dropout</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">_dropout</span><span class="p">,</span> <span class="n">learn_priors</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">_learn_priors</span><span class="p">,</span>
                         <span class="n">batch_size</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">_batch_size</span><span class="p">,</span> <span class="n">lr</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">_lr</span><span class="p">,</span> <span class="n">momentum</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">_momentum</span><span class="p">,</span>
                         <span class="n">solver</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">_solver</span><span class="p">,</span> <span class="n">num_epochs</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">_num_epochs</span><span class="p">,</span>
                         <span class="n">num_samples</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">_num_samples</span><span class="p">,</span> <span class="n">reduce_on_plateau</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">_reduce_on_plateau</span><span class="p">,</span>
                         <span class="n">topic_prior_mean</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">_topic_prior_mean</span><span class="p">,</span>
                         <span class="n">topic_prior_variance</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">_topic_prior_variance</span><span class="p">,</span>
                         <span class="n">num_data_loader_workers</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">_num_data_loader_workers</span><span class="p">,</span>
                         <span class="n">verbose</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>

        <span class="n">ctm_fit</span> <span class="o">=</span> <span class="n">ctm</span><span class="o">.</span><span class="n">fit</span><span class="p">(</span><span class="n">data</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">data</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span>

        <span class="c1"># Get thetas</span>
        <span class="n">thetas</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">asarray</span><span class="p">(</span><span class="n">ctm</span><span class="o">.</span><span class="n">get_doc_topic_distribution</span><span class="p">(</span><span class="n">ctm</span><span class="o">.</span><span class="n">train_data</span><span class="p">))</span>

        <span class="c1"># Sparsification of thetas matrix</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s1">&#39;-- -- Sparsifying doc-topics matrix&#39;</span><span class="p">)</span>
        <span class="c1"># Create figure to check thresholding is correct</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_SaveThrFig</span><span class="p">(</span><span class="n">thetas</span><span class="p">)</span>
        <span class="c1"># Set to zeros all thetas below threshold, and renormalize</span>
        <span class="n">thetas</span><span class="p">[</span><span class="n">thetas</span> <span class="o">&lt;</span> <span class="bp">self</span><span class="o">.</span><span class="n">_sparse_thr</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="n">thetas</span> <span class="o">=</span> <span class="n">normalize</span><span class="p">(</span><span class="n">thetas</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">norm</span><span class="o">=</span><span class="s1">&#39;l1&#39;</span><span class="p">)</span>
        <span class="n">thetas</span> <span class="o">=</span> <span class="n">sparse</span><span class="o">.</span><span class="n">csr_matrix</span><span class="p">(</span><span class="n">thetas</span><span class="p">,</span> <span class="n">copy</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>

        <span class="c1"># Recalculate topic weights to avoid errors due to sparsification</span>
        <span class="n">alphas</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">asarray</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">thetas</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">))</span><span class="o">.</span><span class="n">ravel</span><span class="p">()</span>

        <span class="c1"># Calculate beta matrix</span>
        <span class="n">betas</span> <span class="o">=</span> <span class="n">ctm</span><span class="o">.</span><span class="n">get_topic_word_distribution</span><span class="p">()</span>

        <span class="c1"># Create vocabulary files and calculate beta matrix</span>
        <span class="n">a</span> <span class="o">=</span> <span class="nb">sum</span><span class="p">(</span><span class="n">betas</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="p">:])</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;SUM BETAS&quot;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">a</span><span class="p">))</span>
        <span class="n">vocab_size</span> <span class="o">=</span> <span class="n">betas</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
        <span class="n">vocab</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="n">term_freq</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="n">vocab_size</span><span class="p">,))</span>

        <span class="n">id2token</span> <span class="o">=</span> <span class="n">data</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span>
        <span class="k">for</span> <span class="n">top</span> <span class="ow">in</span> <span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_ntopics</span><span class="p">):</span>
            <span class="k">for</span> <span class="n">idx</span><span class="p">,</span> <span class="n">word</span> <span class="ow">in</span> <span class="n">id2token</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
                <span class="n">vocab</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">word</span><span class="p">)</span>
                <span class="n">cnt</span> <span class="o">=</span> <span class="n">betas</span><span class="p">[</span><span class="n">top</span><span class="p">][</span><span class="n">idx</span><span class="p">]</span>
                <span class="n">term_freq</span><span class="p">[</span><span class="n">idx</span><span class="p">]</span> <span class="o">+=</span> <span class="n">cnt</span>  <span class="c1"># Cuántas veces aparece una palabra</span>

        <span class="c1"># save vocabulary and frequencies</span>
        <span class="k">with</span> <span class="bp">self</span><span class="o">.</span><span class="n">_modelFolder</span><span class="o">.</span><span class="n">joinpath</span><span class="p">(</span><span class="s1">&#39;vocab_freq_ctm.txt&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">open</span><span class="p">(</span><span class="s1">&#39;w&#39;</span><span class="p">,</span> <span class="n">encoding</span><span class="o">=</span><span class="s1">&#39;utf8&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">fout</span><span class="p">:</span>
            <span class="p">[</span><span class="n">fout</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">el</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">+</span> <span class="s1">&#39;</span><span class="se">\t</span><span class="s1">&#39;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="nb">int</span><span class="p">(</span><span class="n">el</span><span class="p">[</span><span class="mi">1</span><span class="p">]))</span> <span class="o">+</span> <span class="s1">&#39;</span><span class="se">\n</span><span class="s1">&#39;</span><span class="p">)</span> <span class="k">for</span> <span class="n">el</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="n">vocab</span><span class="p">,</span> <span class="n">term_freq</span><span class="p">)]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s1">&#39;-- -- CTM training: Vocabulary file generated&#39;</span><span class="p">)</span>

        <span class="c1"># We end by saving the model for future use</span>
        <span class="n">modelVarsDir</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_modelFolder</span><span class="o">.</span><span class="n">joinpath</span><span class="p">(</span><span class="s1">&#39;model_vars&#39;</span><span class="p">)</span>
        <span class="n">modelVarsDir</span><span class="o">.</span><span class="n">mkdir</span><span class="p">()</span>
        <span class="n">np</span><span class="o">.</span><span class="n">save</span><span class="p">(</span><span class="n">modelVarsDir</span><span class="o">.</span><span class="n">joinpath</span><span class="p">(</span><span class="s1">&#39;alpha_orig.npy&#39;</span><span class="p">),</span> <span class="n">alphas</span><span class="p">)</span>
        <span class="n">np</span><span class="o">.</span><span class="n">save</span><span class="p">(</span><span class="n">modelVarsDir</span><span class="o">.</span><span class="n">joinpath</span><span class="p">(</span><span class="s1">&#39;beta_orig.npy&#39;</span><span class="p">),</span> <span class="n">betas</span><span class="p">)</span>
        <span class="n">np</span><span class="o">.</span><span class="n">savez</span><span class="p">(</span><span class="n">modelVarsDir</span><span class="o">.</span><span class="n">joinpath</span><span class="p">(</span><span class="s1">&#39;thetas_orig.npz&#39;</span><span class="p">),</span>
                 <span class="n">thetas_data</span><span class="o">=</span><span class="n">thetas</span><span class="o">.</span><span class="n">data</span><span class="p">,</span> <span class="n">thetas_indices</span><span class="o">=</span><span class="n">thetas</span><span class="o">.</span><span class="n">indices</span><span class="p">,</span>
                 <span class="n">thetas_indptr</span><span class="o">=</span><span class="n">thetas</span><span class="o">.</span><span class="n">indptr</span><span class="p">,</span> <span class="n">thetas_shape</span><span class="o">=</span><span class="n">thetas</span><span class="o">.</span><span class="n">shape</span><span class="p">)</span>

        <span class="k">return</span></div>


<span class="c1">##############################################################################</span>
<span class="c1">#                                  MAIN                                      #</span>
<span class="c1">##############################################################################</span>
<span class="k">if</span> <span class="vm">__name__</span> <span class="o">==</span> <span class="s2">&quot;__main__&quot;</span><span class="p">:</span>

    <span class="c1"># settings</span>
    <span class="n">parser</span> <span class="o">=</span> <span class="n">argparse</span><span class="o">.</span><span class="n">ArgumentParser</span><span class="p">()</span>
    <span class="n">parser</span><span class="o">.</span><span class="n">add_argument</span><span class="p">(</span><span class="s1">&#39;--train&#39;</span><span class="p">,</span> <span class="n">action</span><span class="o">=</span><span class="s1">&#39;store_true&#39;</span><span class="p">,</span> <span class="n">default</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
                        <span class="n">help</span><span class="o">=</span><span class="s2">&quot;Train a Topic Model according to config file&quot;</span><span class="p">)</span>
    <span class="n">parser</span><span class="o">.</span><span class="n">add_argument</span><span class="p">(</span><span class="s1">&#39;--config&#39;</span><span class="p">,</span> <span class="nb">type</span><span class="o">=</span><span class="nb">str</span><span class="p">,</span> <span class="n">default</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
                        <span class="n">help</span><span class="o">=</span><span class="s2">&quot;path to configuration file&quot;</span><span class="p">)</span>
    <span class="n">args</span> <span class="o">=</span> <span class="n">parser</span><span class="o">.</span><span class="n">parse_args</span><span class="p">()</span>

    <span class="c1"># If the training flag is activated, we need to check availability of</span>
    <span class="c1"># configuration file, and run the training using class MalletTrainer</span>
    <span class="k">if</span> <span class="n">args</span><span class="o">.</span><span class="n">train</span><span class="p">:</span>
        <span class="n">configFile</span> <span class="o">=</span> <span class="n">Path</span><span class="p">(</span><span class="n">args</span><span class="o">.</span><span class="n">config</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">configFile</span><span class="o">.</span><span class="n">is_file</span><span class="p">():</span>
            <span class="n">cf</span> <span class="o">=</span> <span class="n">configparser</span><span class="o">.</span><span class="n">ConfigParser</span><span class="p">()</span>
            <span class="n">cf</span><span class="o">.</span><span class="n">read</span><span class="p">(</span><span class="n">configFile</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">cf</span><span class="p">[</span><span class="s1">&#39;Training&#39;</span><span class="p">][</span><span class="s1">&#39;trainer&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="s1">&#39;mallet&#39;</span><span class="p">:</span>
                <span class="n">MallTr</span> <span class="o">=</span> <span class="n">MalletTrainer</span><span class="p">(</span><span class="n">cf</span><span class="p">,</span> <span class="n">modelFolder</span><span class="o">=</span><span class="n">configFile</span><span class="o">.</span><span class="n">parent</span><span class="p">)</span>
                <span class="n">MallTr</span><span class="o">.</span><span class="n">fit</span><span class="p">()</span>
            <span class="k">elif</span> <span class="n">cf</span><span class="p">[</span><span class="s1">&#39;Training&#39;</span><span class="p">][</span><span class="s1">&#39;trainer&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="s1">&#39;prodlda&#39;</span><span class="p">:</span>
                <span class="n">ProdLDATr</span> <span class="o">=</span> <span class="n">ProdLDATrainer</span><span class="p">(</span><span class="n">cf</span><span class="p">,</span> <span class="n">modelFolder</span><span class="o">=</span><span class="n">configFile</span><span class="o">.</span><span class="n">parent</span><span class="p">)</span>
                <span class="n">ProdLDATr</span><span class="o">.</span><span class="n">fit</span><span class="p">()</span>
            <span class="k">elif</span> <span class="n">cf</span><span class="p">[</span><span class="s1">&#39;Training&#39;</span><span class="p">][</span><span class="s1">&#39;trainer&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="s1">&#39;ctm&#39;</span><span class="p">:</span>
                <span class="n">CTMr</span> <span class="o">=</span> <span class="n">CTMTrainer</span><span class="p">(</span><span class="n">cf</span><span class="p">,</span> <span class="n">modelFolder</span><span class="o">=</span><span class="n">configFile</span><span class="o">.</span><span class="n">parent</span><span class="p">)</span>
                <span class="n">CTMr</span><span class="o">.</span><span class="n">fit</span><span class="p">()</span>

        <span class="k">else</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;You need to provide a valid configuration file&#39;</span><span class="p">)</span>
</pre></div>

           </div>
          </div>
          <footer>

  <hr/>

  <div role="contentinfo">
    <p>&#169; Copyright 2022, J. Arenas-García, L. Calvo-Bartolomé, J. A. Espinosa-Melchor.</p>
  </div>

  Built with <a href="https://www.sphinx-doc.org/">Sphinx</a> using a
    <a href="https://github.com/readthedocs/sphinx_rtd_theme">theme</a>
    provided by <a href="https://readthedocs.org">Read the Docs</a>.
   

</footer>
        </div>
      </div>
    </section>
  </div>
  <script>
      jQuery(function () {
          SphinxRtdTheme.Navigation.enable(true);
      });
  </script> 

</body>
</html>